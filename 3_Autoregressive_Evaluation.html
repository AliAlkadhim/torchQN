
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>IQNx4: Chapter 3: Autoregressive Evaluation &#8212; torchIQNx4</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">

    
  <link rel="stylesheet"
    href="_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" href="_static/styles/sphinx-book-theme.css?digest=5115cc725059bd94278eecd172e13a965bf8f5a9" type="text/css" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="_static/design-style.b7bb847fb20b106c3d81b95245e65545.min.css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">

    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/clipboard.min.js"></script>
    <script src="_static/copybutton.js"></script>
    <script src="_static/scripts/sphinx-book-theme.js?digest=9c920249402e914e316237a7dbc6769907cce411"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="_static/sphinx-thebe.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Chapter 4: Optional Supplementary Material" href="4_SupplementaryMaterials_OptunaTuning_Theory_ML_Background.html" />
    <link rel="prev" title="2.1 Imports and Configurations" href="2_Train_all_IQNs.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
<!-- Checkboxes to toggle the left sidebar -->
<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle navigation sidebar">
<label class="overlay overlay-navbar" for="__navigation">
    <div class="visually-hidden">Toggle navigation sidebar</div>
</label>
<!-- Checkboxes to toggle the in-page toc -->
<input type="checkbox" class="sidebar-toggle" name="__page-toc" id="__page-toc" aria-label="Toggle in-page Table of Contents">
<label class="overlay overlay-pagetoc" for="__page-toc">
    <div class="visually-hidden">Toggle in-page Table of Contents</div>
</label>
<!-- Headers at the top -->
<div class="announcement header-item noprint"></div>
<div class="header header-item noprint"></div>

    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<!-- Sidebar -->
<div class="bd-sidebar noprint" id="site-navigation">
    <div class="bd-sidebar__content">
        <div class="bd-sidebar__top"><div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="index.html">
      
      
      
      <h1 class="site-logo" id="site-title">torchIQNx4</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="intro.html">
                    Welcome to the torchIQNx4
                </a>
            </li>
        </ul>
        <ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="1_Setup_and_Preprocess.html">
   IQNx4: Chapter 1. Setup and Preprocess
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="2_Train_all_IQNs.html">
   2.1 Imports and Configurations
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   IQNx4: Chapter 3: Autoregressive Evaluation
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="4_SupplementaryMaterials_OptunaTuning_Theory_ML_Background.html">
   Chapter 4: Optional Supplementary Material
  </a>
 </li>
</ul>

    </div>
</nav></div>
        <div class="bd-sidebar__bottom">
             <!-- To handle the deprecated key -->
            
            <div class="navbar_extra_footer">
            Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
            </div>
            
        </div>
    </div>
    <div id="rtd-footer-container"></div>
</div>


          


          
<!-- A tiny helper pixel to detect if we've scrolled -->
<div class="sbt-scroll-pixel-helper"></div>
<!-- Main content -->
<div class="col py-0 content-container">
    
    <div class="header-article row sticky-top noprint">
        



<div class="col py-1 d-flex header-article-main">
    <div class="header-article__left">
        
        <label for="__navigation"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="right"
title="Toggle navigation"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-bars"></i>
  </span>

</label>

        
    </div>
    <div class="header-article__right">
<div class="menu-dropdown menu-dropdown-launch-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Launch interactive content">
      <i class="fas fa-rocket"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="https://mybinder.org/v2/gh/AliAlkadhim/torchQN/HEAD?labpath=JupyterBook/v2/gh/AliAlkadhim/torchQN/master?urlpath=tree/JupyterBook/3_Autoregressive_Evaluation.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Launch on Binder"
>
  

<span class="headerbtn__icon-container">
  
    <img src="_static/images/logo_binder.svg">
  </span>
<span class="headerbtn__text-container">Binder</span>
</a>

      </li>
      
    </ul>
  </div>
</div>

<button onclick="toggleFullScreen()"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="bottom"
title="Fullscreen mode"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>

<div class="menu-dropdown menu-dropdown-download-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Download this page">
      <i class="fas fa-download"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="_sources/3_Autoregressive_Evaluation.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Download source file"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="headerbtn__text-container">.ipynb</span>
</a>

      </li>
      
      <li>
        
<button onclick="printPdf(this)"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="left"
title="Print to PDF"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="headerbtn__text-container">.pdf</span>
</button>

      </li>
      
    </ul>
  </div>
</div>
<label for="__page-toc"
  class="headerbtn headerbtn-page-toc"
  
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-list"></i>
  </span>

</label>

    </div>
</div>

<!-- Table of contents -->
<div class="col-md-3 bd-toc show noprint">
    <div class="tocsection onthispage pt-5 pb-3">
        <i class="fas fa-list"></i> Contents
    </div>
    <nav id="bd-toc-nav" aria-label="Page">
        <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#imports-and-configurations">
   3.1: Imports and Configurations
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#needed-functions">
   3.2: Needed Functions
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#evaluate-mass">
   3.3: Evaluate Mass
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#evaluate-p-t">
   3.4: Evaluate
   <span class="math notranslate nohighlight">
    \(p_T\)
   </span>
  </a>
 </li>
</ul>

    </nav>
</div>
    </div>
    <div class="article row">
        <div class="col pl-md-3 pl-lg-5 content-container">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>IQNx4: Chapter 3: Autoregressive Evaluation</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#imports-and-configurations">
   3.1: Imports and Configurations
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#needed-functions">
   3.2: Needed Functions
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#evaluate-mass">
   3.3: Evaluate Mass
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#evaluate-p-t">
   3.4: Evaluate
   <span class="math notranslate nohighlight">
    \(p_T\)
   </span>
  </a>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            <main id="main-content" role="main">
                
              <div>
                
  <section class="tex2jax_ignore mathjax_ignore" id="iqnx4-chapter-3-autoregressive-evaluation">
<h1>IQNx4: Chapter 3: Autoregressive Evaluation<a class="headerlink" href="#iqnx4-chapter-3-autoregressive-evaluation" title="Permalink to this headline">#</a></h1>
<section id="imports-and-configurations">
<h2>3.1: Imports and Configurations<a class="headerlink" href="#imports-and-configurations" title="Permalink to this headline">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="c1"># import scipy as sp; import scipy.stats as st</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">torch.nn</span> <span class="k">as</span> <span class="nn">nn</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;using torch version </span><span class="si">{</span><span class="n">torch</span><span class="o">.</span><span class="n">__version__</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="c1"># use numba&#39;s just-in-time compiler to speed things up</span>
<span class="c1"># from numba import njit</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">StandardScaler</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>
<span class="kn">import</span> <span class="nn">matplotlib</span> <span class="k">as</span> <span class="nn">mp</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;matplotlib version= &quot;</span><span class="p">,</span> <span class="n">mp</span><span class="o">.</span><span class="n">__version__</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="c1"># reset matplotlib stle/parameters</span>
<span class="c1"># reset matplotlib parameters to their defaults</span>
<span class="c1"># plt.style.use(&#39;seaborn-deep&#39;)</span>
<span class="c1"># mp.rcParams[&#39;agg.path.chunksize&#39;] = 10000</span>
<span class="n">font_legend</span> <span class="o">=</span> <span class="mi">15</span>
<span class="n">font_axes</span> <span class="o">=</span> <span class="mi">15</span>
<span class="c1"># %matplotlib inline</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="c1"># from IPython.display import Image, display</span>
<span class="c1"># from importlib import import_module</span>
<span class="c1"># import plotly</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">optuna</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;using (optional) optuna version </span><span class="si">{</span><span class="n">optuna</span><span class="o">.</span><span class="n">__version__</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;optuna is only used for hyperparameter tuning, not critical!&quot;</span><span class="p">)</span>
    <span class="k">pass</span>
<span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="c1"># import sympy as sy</span>
<span class="c1"># import ipywidgets as wid;</span>

<span class="c1"># update fonts</span>
<span class="n">font</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;family&quot;</span><span class="p">:</span> <span class="s2">&quot;serif&quot;</span><span class="p">,</span> <span class="s2">&quot;size&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">}</span>
<span class="n">mp</span><span class="o">.</span><span class="n">rc</span><span class="p">(</span><span class="s2">&quot;font&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">font</span><span class="p">)</span>

<span class="c1"># set usetex = False if LaTex is not</span>
<span class="c1"># available on your system or if the</span>
<span class="c1"># rendering is too slow</span>
<span class="n">mp</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;text.usetex&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span>
<span class="c1"># plt.rcParams[&#39;text.usetex&#39;] = True</span>
<span class="n">mp</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;text.latex.preamble&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="sa">r</span><span class="s2">&quot;\usepackage</span><span class="si">{amsmath}</span><span class="s2">&quot;</span><span class="p">]</span>  <span class="c1"># for \text command</span>


<span class="c1"># set a seed to ensure reproducibility</span>
<span class="c1"># seed = 128</span>
<span class="c1"># rnd  = np.random.RandomState(seed)</span>
<span class="c1"># sometimes jupyter doesnt initialize MathJax automatically for latex, so do this:</span>

<span class="k">try</span><span class="p">:</span>
    <span class="n">IQN_BASE</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;IQN_BASE&quot;</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;BASE directoy properly set = &quot;</span><span class="p">,</span> <span class="n">IQN_BASE</span><span class="p">)</span>
    <span class="n">utils_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">IQN_BASE</span><span class="p">,</span> <span class="s1">&#39;utils/&#39;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">utils_dir</span><span class="p">)</span>
    <span class="kn">import</span> <span class="nn">utils</span>

    <span class="c1"># usually its not recommended to import everything from a module, but we know</span>
    <span class="c1"># whats in it so its fine</span>
    <span class="c1"># from utils import *</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;DATA directory also properly set, in </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;DATA_DIR&quot;</span><span class="p">])</span>
<span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
    <span class="c1"># IQN_BASE=os.getcwd()</span>
    <span class="nb">print</span><span class="p">(</span>
        <span class="sd">&quot;&quot;&quot;\nBASE directory not properly set. Read repo README.    If you need a function from utils, use the decorator below, or add utils to sys.path\n</span>
<span class="sd">    You can also do </span>
<span class="sd">    os.environ[&#39;IQN_BASE&#39;]=&lt;ABSOLUTE PATH FOR THE IQN REPO&gt;</span>
<span class="sd">    or</span>
<span class="sd">    os.environ[&#39;IQN_BASE&#39;]=os.getcwd()&quot;&quot;&quot;</span>
    <span class="p">)</span>
    <span class="k">pass</span>

<span class="c1"># from IQNx4_utils import *</span>
<span class="n">IQN_BASE</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;IQN_BASE&quot;</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;BASE directoy properly set = &quot;</span><span class="p">,</span> <span class="n">IQN_BASE</span><span class="p">)</span>
<span class="n">utils_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">IQN_BASE</span><span class="p">,</span> <span class="s2">&quot;utils/&quot;</span><span class="p">)</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">utils_dir</span><span class="p">)</span>
<span class="c1"># usually its not recommended to import everything from a module, but we know</span>
<span class="c1"># whats in it so its fine</span>

<span class="c1"># or use joblib for caching on disk</span>
<span class="kn">from</span> <span class="nn">joblib</span> <span class="kn">import</span> <span class="n">Memory</span>


<span class="c1">################################### CONFIGURATIONS ###################################</span>
<span class="n">DATA_DIR</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;DATA_DIR&quot;</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;using DATA_DIR=</span><span class="si">{</span><span class="n">DATA_DIR</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">JUPYTER</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">use_subsample</span> <span class="o">=</span> <span class="kc">False</span>
<span class="c1"># use_subsample=True</span>
<span class="k">if</span> <span class="n">use_subsample</span><span class="p">:</span>
    <span class="n">SUBSAMPLE</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span>
        <span class="mf">1e5</span>
    <span class="p">)</span>  <span class="c1"># subsample use for development - in production use whole dataset</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">SUBSAMPLE</span> <span class="o">=</span> <span class="kc">None</span>

<span class="c1"># memory = Memory(DATA_DIR)</span>


<span class="c1">###############################################################################################</span>
<span class="n">y_label_dict</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;RecoDatapT&quot;</span><span class="p">:</span> <span class="s2">&quot;$p(p_T)$&quot;</span> <span class="o">+</span> <span class="s2">&quot; [ GeV&quot;</span> <span class="o">+</span> <span class="s2">&quot;$^{-1} $&quot;</span> <span class="o">+</span> <span class="s2">&quot;]&quot;</span><span class="p">,</span>
    <span class="s2">&quot;RecoDataeta&quot;</span><span class="p">:</span> <span class="s2">&quot;$p(\eta)$&quot;</span><span class="p">,</span>
    <span class="s2">&quot;RecoDataphi&quot;</span><span class="p">:</span> <span class="s2">&quot;$p(\phi)$&quot;</span><span class="p">,</span>
    <span class="s2">&quot;RecoDatam&quot;</span><span class="p">:</span> <span class="s2">&quot;$p(m)$&quot;</span> <span class="o">+</span> <span class="s2">&quot; [ GeV&quot;</span> <span class="o">+</span> <span class="s2">&quot;$^{-1} $&quot;</span> <span class="o">+</span> <span class="s2">&quot;]&quot;</span><span class="p">,</span>
<span class="p">}</span>

<span class="n">loss_y_label_dict</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;RecoDatapT&quot;</span><span class="p">:</span> <span class="s2">&quot;$p_T^</span><span class="si">{reco}</span><span class="s2">$&quot;</span><span class="p">,</span>
    <span class="s2">&quot;RecoDataeta&quot;</span><span class="p">:</span> <span class="s2">&quot;$\eta^</span><span class="si">{reco}</span><span class="s2">$&quot;</span><span class="p">,</span>
    <span class="s2">&quot;RecoDataphi&quot;</span><span class="p">:</span> <span class="s2">&quot;$\phi^</span><span class="si">{reco}</span><span class="s2">$&quot;</span><span class="p">,</span>
    <span class="s2">&quot;RecoDatam&quot;</span><span class="p">:</span> <span class="s2">&quot;$m^</span><span class="si">{reco}</span><span class="s2">$&quot;</span><span class="p">,</span>
<span class="p">}</span>


<span class="c1">################################### SET DATA CONFIGURATIONS ###################################</span>
<span class="n">X</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;genDatapT&quot;</span><span class="p">,</span> <span class="s2">&quot;genDataeta&quot;</span><span class="p">,</span> <span class="s2">&quot;genDataphi&quot;</span><span class="p">,</span> <span class="s2">&quot;genDatam&quot;</span><span class="p">,</span> <span class="s2">&quot;tau&quot;</span><span class="p">]</span>

<span class="c1"># set order of training:</span>
<span class="c1"># pT_first: pT-&gt;&gt;m-&gt;eta-&gt;phi</span>
<span class="c1"># m_first: m-&gt;pT-&gt;eta-&gt;phi</span>


<span class="n">ORDER</span> <span class="o">=</span> <span class="s2">&quot;m_First&quot;</span>

<span class="k">if</span> <span class="n">ORDER</span> <span class="o">==</span> <span class="s2">&quot;m_First&quot;</span><span class="p">:</span>
    <span class="n">FIELDS</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;RecoDatam&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;inputs&quot;</span><span class="p">:</span> <span class="n">X</span><span class="p">,</span>
            <span class="s2">&quot;xlabel&quot;</span><span class="p">:</span> <span class="sa">r</span><span class="s2">&quot;$m$ (GeV)&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ylabel&quot;</span><span class="p">:</span> <span class="s2">&quot;$m^</span><span class="si">{reco}</span><span class="s2">$&quot;</span><span class="p">,</span>
            <span class="s2">&quot;xmin&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s2">&quot;xmax&quot;</span><span class="p">:</span> <span class="mi">25</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="s2">&quot;RecoDatapT&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;inputs&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;RecoDatam&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">X</span><span class="p">,</span>
            <span class="s2">&quot;xlabel&quot;</span><span class="p">:</span> <span class="sa">r</span><span class="s2">&quot;$p_T$ (GeV)&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ylabel&quot;</span><span class="p">:</span> <span class="s2">&quot;$p_T^</span><span class="si">{reco}</span><span class="s2">$&quot;</span><span class="p">,</span>
            <span class="s2">&quot;xmin&quot;</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span>
            <span class="s2">&quot;xmax&quot;</span><span class="p">:</span> <span class="mi">80</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="s2">&quot;RecoDataeta&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;inputs&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;RecoDatam&quot;</span><span class="p">,</span> <span class="s2">&quot;RecoDatapT&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">X</span><span class="p">,</span>
            <span class="s2">&quot;xlabel&quot;</span><span class="p">:</span> <span class="sa">r</span><span class="s2">&quot;$\eta$&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ylabel&quot;</span><span class="p">:</span> <span class="s2">&quot;$\eta^</span><span class="si">{reco}</span><span class="s2">$&quot;</span><span class="p">,</span>
            <span class="s2">&quot;xmin&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">5</span><span class="p">,</span>
            <span class="s2">&quot;xmax&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="s2">&quot;RecoDataphi&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;inputs&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;RecoDatam&quot;</span><span class="p">,</span> <span class="s2">&quot;RecoDatapT&quot;</span><span class="p">,</span> <span class="s2">&quot;RecoDataeta&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">X</span><span class="p">,</span>
            <span class="s2">&quot;xlabel&quot;</span><span class="p">:</span> <span class="sa">r</span><span class="s2">&quot;$\phi$&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ylabel&quot;</span><span class="p">:</span> <span class="s2">&quot;$\phi^</span><span class="si">{reco}</span><span class="s2">$&quot;</span><span class="p">,</span>
            <span class="s2">&quot;xmin&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mf">3.2</span><span class="p">,</span>
            <span class="s2">&quot;xmax&quot;</span><span class="p">:</span> <span class="mf">3.2</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">}</span>


<span class="c1"># Load and explore raw (unscaled) dataframes</span>


<span class="n">all_variable_cols</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;genDatapT&quot;</span><span class="p">,</span>
    <span class="s2">&quot;genDataeta&quot;</span><span class="p">,</span>
    <span class="s2">&quot;genDataphi&quot;</span><span class="p">,</span>
    <span class="s2">&quot;genDatam&quot;</span><span class="p">,</span>
    <span class="s2">&quot;RecoDatapT&quot;</span><span class="p">,</span>
    <span class="s2">&quot;RecoDataeta&quot;</span><span class="p">,</span>
    <span class="s2">&quot;RecoDataphi&quot;</span><span class="p">,</span>
    <span class="s2">&quot;RecoDatam&quot;</span><span class="p">,</span>
<span class="p">]</span>
<span class="n">all_cols</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;genDatapT&quot;</span><span class="p">,</span>
    <span class="s2">&quot;genDataeta&quot;</span><span class="p">,</span>
    <span class="s2">&quot;genDataphi&quot;</span><span class="p">,</span>
    <span class="s2">&quot;genDatam&quot;</span><span class="p">,</span>
    <span class="s2">&quot;RecoDatapT&quot;</span><span class="p">,</span>
    <span class="s2">&quot;RecoDataeta&quot;</span><span class="p">,</span>
    <span class="s2">&quot;RecoDataphi&quot;</span><span class="p">,</span>
    <span class="s2">&quot;RecoDatam&quot;</span><span class="p">,</span>
    <span class="s2">&quot;tau&quot;</span><span class="p">,</span>
<span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>using torch version 1.9.0
matplotlib version=  3.5.1
using (optional) optuna version 2.8.0
BASE directoy properly set =  /home/ali/Desktop/Pulled_Github_Repositories/torchQN
DATA directory also properly set, in /home/ali/Desktop/Pulled_Github_Repositories/IQN_HEP/Davidson/data
BASE directoy properly set =  /home/ali/Desktop/Pulled_Github_Repositories/torchQN
using DATA_DIR=/home/ali/Desktop/Pulled_Github_Repositories/IQN_HEP/Davidson/data
</pre></div>
</div>
</div>
</div>
</section>
<section id="needed-functions">
<h2>3.2: Needed Functions<a class="headerlink" href="#needed-functions" title="Permalink to this headline">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">target</span> <span class="o">=</span> <span class="s2">&quot;RecoDatam&quot;</span>
<span class="n">source</span> <span class="o">=</span> <span class="n">FIELDS</span><span class="p">[</span><span class="n">target</span><span class="p">]</span>
<span class="n">features</span> <span class="o">=</span> <span class="n">source</span><span class="p">[</span><span class="s2">&quot;inputs&quot;</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Training Features:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">features</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Target = &quot;</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
<span class="n">AUTOREGRESSIVE_DIST_NAME</span> <span class="o">=</span> <span class="s2">&quot;AUTOREGRESSIVE_m_Prime.csv&quot;</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;USING NEW DATASET</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="c1">######################################</span>
<span class="n">USE_BRADEN_SCALING</span> <span class="o">=</span> <span class="kc">False</span>
<span class="c1">#####################################</span>
<span class="c1">################################### CONFIGURATIONS ###################################</span>

<span class="n">JUPYTER</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">use_subsample</span> <span class="o">=</span> <span class="kc">False</span>
<span class="c1"># use_subsample = True</span>
<span class="k">if</span> <span class="n">use_subsample</span><span class="p">:</span>
    <span class="n">SUBSAMPLE</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span>
        <span class="mf">1e5</span>
    <span class="p">)</span>  <span class="c1"># subsample use for development - in production use whole dataset</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">SUBSAMPLE</span> <span class="o">=</span> <span class="kc">None</span>

<span class="c1">########################################################################################</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Training Features:
 [&#39;genDatapT&#39;, &#39;genDataeta&#39;, &#39;genDataphi&#39;, &#39;genDatam&#39;, &#39;tau&#39;]

Target =  RecoDatam
USING NEW DATASET
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">################################## Load unscaled dataframes ###################################</span>
<span class="c1"># @memory.cache</span>
<span class="k">def</span> <span class="nf">load_raw_data</span><span class="p">(</span><span class="n">AUTOREGRESSIVE_DIST_NAME</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Dont use AUTOREGRESSIVE_DIST_NAME for training of any variable. </span>
<span class="sd">    For mass evaluation: dont use AUTOREGRESSIVE_DIST_NAME. For pT evaluation use AUTOREGRESSIVE_DIST_NAME </span>
<span class="sd">    as the distribution predicted by mass, etc.  &quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">SUBSAMPLE = </span><span class="si">{</span><span class="n">SUBSAMPLE</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">raw_train_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>
        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">DATA_DIR</span><span class="p">,</span> <span class="s2">&quot;train_data_10M_2.csv&quot;</span><span class="p">),</span>
        <span class="n">usecols</span><span class="o">=</span><span class="n">all_cols</span><span class="p">,</span>
        <span class="n">nrows</span><span class="o">=</span><span class="n">SUBSAMPLE</span><span class="p">,</span>
    <span class="p">)</span>



    <span class="n">raw_valid_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>
        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">DATA_DIR</span><span class="p">,</span> <span class="s2">&quot;validation_data_10M_2.csv&quot;</span><span class="p">),</span>
        <span class="n">usecols</span><span class="o">=</span><span class="n">all_cols</span><span class="p">,</span>
        <span class="n">nrows</span><span class="o">=</span><span class="n">SUBSAMPLE</span><span class="p">,</span>
    <span class="p">)</span>
    
    <span class="k">if</span> <span class="n">AUTOREGRESSIVE_DIST_NAME</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Test (evaluation) Data is Autoregressive, loading </span><span class="si">{</span><span class="n">AUTOREGRESSIVE_DIST_NAME</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">eval_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="n">IQN_BASE</span><span class="p">,</span>
                <span class="s2">&quot;JupyterBook&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Cluster&quot;</span><span class="p">,</span>
                <span class="s2">&quot;EVALUATE&quot;</span><span class="p">,</span>
                <span class="n">AUTOREGRESSIVE_DIST_NAME</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">raw_test_data</span> <span class="o">=</span> <span class="n">eval_data</span>
    <span class="k">else</span><span class="p">:</span>
    
        <span class="n">raw_test_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>
        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">DATA_DIR</span><span class="p">,</span> <span class="s2">&quot;test_data_10M_2.csv&quot;</span><span class="p">),</span> 
        <span class="n">usecols</span><span class="o">=</span><span class="n">all_cols</span><span class="p">,</span> 
        <span class="n">nrows</span><span class="o">=</span><span class="n">SUBSAMPLE</span>
        <span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> RAW TRAIN DATA</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">raw_train_data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">raw_train_data</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>  <span class="c1"># unscaled</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> RAW TEST DATA</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">raw_test_data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">raw_test_data</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>  <span class="c1"># unscaled</span>

    <span class="k">return</span> <span class="n">raw_train_data</span><span class="p">,</span> <span class="n">raw_test_data</span><span class="p">,</span> <span class="n">raw_valid_data</span>


<span class="c1">########## Generate scaled data###############</span>
<span class="c1"># scaled_train_data = L_scale_df(raw_train_data, title=&#39;scaled_train_data_10M_2.csv&#39;,</span>
<span class="c1">#                              save=True)</span>
<span class="c1"># print(&#39;\n\n&#39;)</span>
<span class="c1"># scaled_test_data = L_scale_df(raw_test_data,  title=&#39;scaled_test_data_10M_2.csv&#39;,</span>
<span class="c1">#                             save=True)</span>
<span class="c1"># print(&#39;\n\n&#39;)</span>

<span class="c1"># scaled_valid_data = L_scale_df(raw_valid_data,  title=&#39;scaled_valid_data_10M_2.csv&#39;,</span>
<span class="c1">#                             save=True)</span>

<span class="c1"># explore_data(df=scaled_train_data, title=&#39;Braden Kronheim-L-scaled Dataframe&#39;, scaled=True)</span>

<span class="c1">################ Load scaled data##############</span>
<span class="nd">@utils</span><span class="o">.</span><span class="n">time_type_of_func</span><span class="p">(</span><span class="n">tuning_or_training</span><span class="o">=</span><span class="s2">&quot;loading&quot;</span><span class="p">)</span>
<span class="c1"># @memory.cache</span>
<span class="k">def</span> <span class="nf">load_scaled_dataframes</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;SCALED TRAIN DATA&quot;</span><span class="p">)</span>
    <span class="n">scaled_train_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>
        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">DATA_DIR</span><span class="p">,</span> <span class="s2">&quot;scaled_train_data_10M_2.csv&quot;</span><span class="p">),</span>
        <span class="n">usecols</span><span class="o">=</span><span class="n">all_cols</span><span class="p">,</span>
        <span class="n">nrows</span><span class="o">=</span><span class="n">SUBSAMPLE</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;TRAINING FEATURES</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">scaled_train_data</span><span class="o">.</span><span class="n">head</span><span class="p">())</span>

    <span class="n">scaled_test_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>
        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">DATA_DIR</span><span class="p">,</span> <span class="s2">&quot;scaled_test_data_10M_2.csv&quot;</span><span class="p">),</span>
        <span class="n">usecols</span><span class="o">=</span><span class="n">all_cols</span><span class="p">,</span>
        <span class="n">nrows</span><span class="o">=</span><span class="n">SUBSAMPLE</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">scaled_valid_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>
        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">DATA_DIR</span><span class="p">,</span> <span class="s2">&quot;scaled_valid_data_10M_2.csv&quot;</span><span class="p">),</span>
        <span class="n">usecols</span><span class="o">=</span><span class="n">all_cols</span><span class="p">,</span>
        <span class="n">nrows</span><span class="o">=</span><span class="n">SUBSAMPLE</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">scaled_train_data</span><span class="p">,</span> <span class="n">scaled_test_data</span><span class="p">,</span> <span class="n">scaled_valid_data</span>


<span class="c1">#######################################</span>
<span class="c1">#</span>
<span class="c1"># # print(&#39;\nTESTING FEATURES\n&#39;, scaled_test_data.head())</span>

<span class="c1"># print(&#39;\ntrain set shape:&#39;,  scaled_train_data.shape)</span>
<span class="c1"># print(&#39;\ntest set shape:  &#39;, scaled_test_data.shape)</span>
<span class="c1"># # print(&#39;validation set shape:&#39;, valid_data.shape)</span>
<span class="c1"># @memory.cache</span>
<span class="k">def</span> <span class="nf">get_train_scale_dict</span><span class="p">(</span><span class="n">USE_BRADEN_SCALING</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">USE_BRADEN_SCALING</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span>
        <span class="n">TRAIN_SCALE_DICT</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_scaling_info</span><span class="p">(</span><span class="n">scaled_train_data</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;BRADEN SCALING DICTIONARY&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">TRAIN_SCALE_DICT</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="c1"># TEST_SCALE_DICT = get_scaling_info(scaled_test_data)</span>
        <span class="c1"># print(TEST_SCALE_DICT)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;NORMAL UNSCALED DICTIONARY&quot;</span><span class="p">)</span>
        <span class="n">TRAIN_SCALE_DICT</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_scaling_info</span><span class="p">(</span><span class="n">raw_train_data</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">TRAIN_SCALE_DICT</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="c1"># TEST_SCALE_DICT = get_scaling_info(scaled_test_data)</span>
        <span class="c1"># print(TEST_SCALE_DICT)</span>
    <span class="k">return</span> <span class="n">TRAIN_SCALE_DICT</span>


<span class="c1">################################ SPLIT###########</span>
<span class="c1"># @memory.cache</span>
<span class="k">def</span> <span class="nf">T</span><span class="p">(</span><span class="n">variable</span><span class="p">,</span> <span class="n">scaled_df</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">variable</span> <span class="o">==</span> <span class="s2">&quot;pT&quot;</span><span class="p">:</span>
        <span class="n">L_pT_gen</span> <span class="o">=</span> <span class="n">scaled_df</span><span class="p">[</span><span class="s2">&quot;genDatapT&quot;</span><span class="p">]</span>
        <span class="n">L_pT_reco</span> <span class="o">=</span> <span class="n">scaled_df</span><span class="p">[</span><span class="s2">&quot;RecoDatapT&quot;</span><span class="p">]</span>
        <span class="n">target</span> <span class="o">=</span> <span class="p">(</span><span class="n">L_pT_reco</span> <span class="o">+</span> <span class="mi">10</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">L_pT_gen</span> <span class="o">+</span> <span class="mi">10</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">variable</span> <span class="o">==</span> <span class="s2">&quot;eta&quot;</span><span class="p">:</span>
        <span class="n">L_eta_gen</span> <span class="o">=</span> <span class="n">scaled_df</span><span class="p">[</span><span class="s2">&quot;genDataeta&quot;</span><span class="p">]</span>
        <span class="n">L_eta_reco</span> <span class="o">=</span> <span class="n">scaled_df</span><span class="p">[</span><span class="s2">&quot;RecoDataeta&quot;</span><span class="p">]</span>
        <span class="n">target</span> <span class="o">=</span> <span class="p">(</span><span class="n">L_eta_reco</span> <span class="o">+</span> <span class="mi">10</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">L_eta_gen</span> <span class="o">+</span> <span class="mi">10</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">variable</span> <span class="o">==</span> <span class="s2">&quot;phi&quot;</span><span class="p">:</span>
        <span class="n">L_phi_gen</span> <span class="o">=</span> <span class="n">scaled_df</span><span class="p">[</span><span class="s2">&quot;genDataphi&quot;</span><span class="p">]</span>
        <span class="n">L_phi_reco</span> <span class="o">=</span> <span class="n">scaled_df</span><span class="p">[</span><span class="s2">&quot;RecoDataphi&quot;</span><span class="p">]</span>
        <span class="n">target</span> <span class="o">=</span> <span class="p">(</span><span class="n">L_phi_reco</span> <span class="o">+</span> <span class="mi">10</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">L_phi_gen</span> <span class="o">+</span> <span class="mi">10</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">variable</span> <span class="o">==</span> <span class="s2">&quot;m&quot;</span><span class="p">:</span>
        <span class="n">L_m_gen</span> <span class="o">=</span> <span class="n">scaled_df</span><span class="p">[</span><span class="s2">&quot;genDatam&quot;</span><span class="p">]</span>
        <span class="n">L_m_reco</span> <span class="o">=</span> <span class="n">scaled_df</span><span class="p">[</span><span class="s2">&quot;RecoDatam&quot;</span><span class="p">]</span>
        <span class="n">target</span> <span class="o">=</span> <span class="p">(</span><span class="n">L_m_reco</span> <span class="o">+</span> <span class="mi">10</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">L_m_gen</span> <span class="o">+</span> <span class="mi">10</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">target</span>


<span class="c1"># @memory.cache</span>
<span class="k">def</span> <span class="nf">split_t_x</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">input_features</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get teh target as the ratio, according to the T equation&quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">target</span> <span class="o">==</span> <span class="s2">&quot;RecoDatam&quot;</span><span class="p">:</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">T</span><span class="p">(</span><span class="s2">&quot;m&quot;</span><span class="p">,</span> <span class="n">scaled_df</span><span class="o">=</span><span class="n">scaled_train_data</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">target</span> <span class="o">==</span> <span class="s2">&quot;RecoDatapT&quot;</span><span class="p">:</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">T</span><span class="p">(</span><span class="s2">&quot;pT&quot;</span><span class="p">,</span> <span class="n">scaled_df</span><span class="o">=</span><span class="n">scaled_train_data</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">target</span> <span class="o">==</span> <span class="s2">&quot;RecoDataeta&quot;</span><span class="p">:</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">T</span><span class="p">(</span><span class="s2">&quot;eta&quot;</span><span class="p">,</span> <span class="n">scaled_df</span><span class="o">=</span><span class="n">scaled_train_data</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">target</span> <span class="o">==</span> <span class="s2">&quot;RecoDataphi&quot;</span><span class="p">:</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">T</span><span class="p">(</span><span class="s2">&quot;phi&quot;</span><span class="p">,</span> <span class="n">scaled_df</span><span class="o">=</span><span class="n">scaled_train_data</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">input_features</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">t</span><span class="p">),</span> <span class="n">x</span>


<span class="c1"># @memory.cache</span>
<span class="k">def</span> <span class="nf">split_t_x_test</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">input_features</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get teh target as the ratio, according to the T equation&quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">target</span> <span class="o">==</span> <span class="s2">&quot;RecoDatam&quot;</span><span class="p">:</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">T</span><span class="p">(</span><span class="s2">&quot;m&quot;</span><span class="p">,</span> <span class="n">scaled_df</span><span class="o">=</span><span class="n">scaled_test_data</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">target</span> <span class="o">==</span> <span class="s2">&quot;RecoDatapT&quot;</span><span class="p">:</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">T</span><span class="p">(</span><span class="s2">&quot;pT&quot;</span><span class="p">,</span> <span class="n">scaled_df</span><span class="o">=</span><span class="n">scaled_test_data</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">target</span> <span class="o">==</span> <span class="s2">&quot;RecoDataeta&quot;</span><span class="p">:</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">T</span><span class="p">(</span><span class="s2">&quot;eta&quot;</span><span class="p">,</span> <span class="n">scaled_df</span><span class="o">=</span><span class="n">scaled_test_data</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">target</span> <span class="o">==</span> <span class="s2">&quot;RecoDataphi&quot;</span><span class="p">:</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">T</span><span class="p">(</span><span class="s2">&quot;phi&quot;</span><span class="p">,</span> <span class="n">scaled_df</span><span class="o">=</span><span class="n">scaled_test_data</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">input_features</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">t</span><span class="p">),</span> <span class="n">x</span>


<span class="c1">#########################################################################</span>
<span class="c1"># @memory.cache</span>
<span class="k">def</span> <span class="nf">normal_split_t_x</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">input_features</span><span class="p">):</span>
    <span class="c1"># change from pandas dataframe format to a numpy</span>
    <span class="c1"># array of the specified types</span>
    <span class="c1"># t = np.array(df[target])</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">target</span><span class="p">])</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">input_features</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">t</span><span class="p">,</span> <span class="n">x</span>


<span class="c1">################ Apply Z scaling############</span>
<span class="k">def</span> <span class="nf">z</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="n">eps</span> <span class="o">=</span> <span class="mf">1e-20</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">x</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="n">eps</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">z_inverse</span><span class="p">(</span><span class="n">xprime</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">xprime</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>


<span class="c1"># @memory.cache</span>
<span class="k">def</span> <span class="nf">z2</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">mean</span><span class="p">,</span> <span class="n">std</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Args:</span>
<span class="sd">        x ([type]): [description]</span>
<span class="sd">        mean ([type]): [description]</span>
<span class="sd">        std ([type]): [description]</span>

<span class="sd">    Returns:</span>
<span class="sd">        [type]: [description]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">eps</span> <span class="o">=</span> <span class="mf">1e-20</span>
    <span class="n">scaled</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">mean</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">std</span> <span class="o">+</span> <span class="n">eps</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">scaled</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">z_inverse</span><span class="p">(</span><span class="n">xprime</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
    <span class="n">unscaled</span> <span class="o">=</span> <span class="n">xprime</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">unscaled</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>


<span class="c1"># @memory.cache</span>
<span class="k">def</span> <span class="nf">z_inverse2</span><span class="p">(</span><span class="n">xprime</span><span class="p">,</span> <span class="n">train_mean</span><span class="p">,</span> <span class="n">train_std</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;mean original train mean, std: original. Probably not needed&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">xprime</span> <span class="o">*</span> <span class="n">train_std</span> <span class="o">+</span> <span class="n">train_mean</span>


<span class="c1"># @memory.cache</span>
<span class="k">def</span> <span class="nf">apply_z_to_features</span><span class="p">(</span><span class="n">TRAIN_SCALE_DICT</span><span class="p">,</span> <span class="n">train_x</span><span class="p">,</span> <span class="n">test_x</span><span class="p">,</span> <span class="n">valid_x</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;TO ensure this z scaling is only applied once to the training features, we use a generator.</span>
<span class="sd">    This doesn&#39;t change the shapes of anything, just applies z to all the feature columns other than tau&quot;&quot;&quot;</span>
    <span class="n">NFEATURES</span> <span class="o">=</span> <span class="n">train_x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NFEATURES</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">variable</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">TRAIN_SCALE_DICT</span><span class="p">)[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">train_mean</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">TRAIN_SCALE_DICT</span><span class="p">[</span><span class="n">variable</span><span class="p">][</span><span class="s2">&quot;mean&quot;</span><span class="p">])</span>
        <span class="n">train_std</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">TRAIN_SCALE_DICT</span><span class="p">[</span><span class="n">variable</span><span class="p">][</span><span class="s2">&quot;std&quot;</span><span class="p">])</span>
        <span class="n">train_x</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">z2</span><span class="p">(</span><span class="n">train_x</span><span class="p">[:,</span> <span class="n">i</span><span class="p">],</span> <span class="n">mean</span><span class="o">=</span><span class="n">train_mean</span><span class="p">,</span> <span class="n">std</span><span class="o">=</span><span class="n">train_std</span><span class="p">)</span>
        <span class="n">test_x</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">z2</span><span class="p">(</span><span class="n">test_x</span><span class="p">[:,</span> <span class="n">i</span><span class="p">],</span> <span class="n">mean</span><span class="o">=</span><span class="n">train_mean</span><span class="p">,</span> <span class="n">std</span><span class="o">=</span><span class="n">train_std</span><span class="p">)</span>
        <span class="n">valid_x</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">z2</span><span class="p">(</span><span class="n">valid_x</span><span class="p">[:,</span> <span class="n">i</span><span class="p">],</span> <span class="n">mean</span><span class="o">=</span><span class="n">train_mean</span><span class="p">,</span> <span class="n">std</span><span class="o">=</span><span class="n">train_std</span><span class="p">)</span>
    <span class="k">yield</span> <span class="n">train_x</span>
    <span class="k">yield</span> <span class="n">test_x</span>
    <span class="k">yield</span> <span class="n">valid_x</span>


<span class="c1"># @memory.cache</span>
<span class="k">def</span> <span class="nf">apply_z_to_targets</span><span class="p">(</span><span class="n">train_t</span><span class="p">,</span> <span class="n">test_t</span><span class="p">,</span> <span class="n">valid_t</span><span class="p">):</span>
    <span class="n">train_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">train_t</span><span class="p">)</span>
    <span class="n">train_std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">train_t</span><span class="p">)</span>
    <span class="n">train_t_</span> <span class="o">=</span> <span class="n">z2</span><span class="p">(</span><span class="n">train_t</span><span class="p">,</span> <span class="n">mean</span><span class="o">=</span><span class="n">train_mean</span><span class="p">,</span> <span class="n">std</span><span class="o">=</span><span class="n">train_std</span><span class="p">)</span>
    <span class="n">test_t_</span> <span class="o">=</span> <span class="n">z2</span><span class="p">(</span><span class="n">test_t</span><span class="p">,</span> <span class="n">mean</span><span class="o">=</span><span class="n">train_mean</span><span class="p">,</span> <span class="n">std</span><span class="o">=</span><span class="n">train_std</span><span class="p">)</span>
    <span class="n">valid_t_</span> <span class="o">=</span> <span class="n">z2</span><span class="p">(</span><span class="n">valid_t</span><span class="p">,</span> <span class="n">mean</span><span class="o">=</span><span class="n">train_mean</span><span class="p">,</span> <span class="n">std</span><span class="o">=</span><span class="n">train_std</span><span class="p">)</span>

    <span class="k">yield</span> <span class="n">train_t_</span>
    <span class="k">yield</span> <span class="n">test_t_</span>
    <span class="k">yield</span> <span class="n">valid_t_</span>


<span class="c1"># @utils.debug</span>
<span class="k">def</span> <span class="nf">save_model</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">PATH</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
    <span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span> <span class="n">PATH</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">trained model dictionary saved in </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">PATH</span><span class="p">)</span>


<span class="c1"># @utils.debug</span>
<span class="k">def</span> <span class="nf">load_model</span><span class="p">(</span><span class="n">PATH</span><span class="p">,</span> <span class="n">PARAMS</span><span class="p">):</span>
    <span class="c1"># n_layers = int(BEST_PARAMS[&quot;n_layers&quot;])</span>
    <span class="c1"># hidden_size = int(BEST_PARAMS[&quot;hidden_size&quot;])</span>
    <span class="c1"># dropout = float(BEST_PARAMS[&quot;dropout&quot;])</span>
    <span class="c1"># optimizer_name = BEST_PARAMS[&quot;optimizer_name&quot;].to_string().split()[1]</span>
    <span class="c1"># learning_rate =  float(BEST_PARAMS[&quot;learning_rate&quot;])</span>
    <span class="c1"># batch_size = int(BEST_PARAMS[&quot;batch_size&quot;])</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">RegularizedRegressionModel</span><span class="p">(</span>
        <span class="n">nfeatures</span><span class="o">=</span><span class="n">NFEATURES</span><span class="p">,</span>
        <span class="n">ntargets</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">nlayers</span><span class="o">=</span><span class="n">PARAMS</span><span class="p">[</span><span class="s2">&quot;n_layers&quot;</span><span class="p">],</span>
        <span class="n">hidden_size</span><span class="o">=</span><span class="n">PARAMS</span><span class="p">[</span><span class="s2">&quot;hidden_size&quot;</span><span class="p">],</span>
        <span class="n">dropout_1</span><span class="o">=</span><span class="n">PARAMS</span><span class="p">[</span><span class="s2">&quot;dropout_1&quot;</span><span class="p">],</span>
        <span class="n">dropout_2</span><span class="o">=</span><span class="n">PARAMS</span><span class="p">[</span><span class="s2">&quot;dropout_2&quot;</span><span class="p">],</span>
        <span class="n">activation</span><span class="o">=</span><span class="n">PARAMS</span><span class="p">[</span><span class="s2">&quot;activation&quot;</span><span class="p">],</span>
    <span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">PATH</span><span class="p">))</span>
    <span class="c1"># OR</span>
    <span class="c1"># model=torch.load(PATH)#BUT HERE IT WILL BE A DICT (CANT BE EVALUATED RIGHT AWAY) DISCOURAGED! Also, use dictionary &quot;.pth&quot; which has both the model state dict and the PARAMS dict</span>
    <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">model</span>


<span class="c1"># @memory.cache</span>
<span class="k">def</span> <span class="nf">simple_eval</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">test_x_z_scaled</span><span class="p">):</span>
    <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
    <span class="c1"># evaluate on the scaled features</span>
    <span class="n">valid_x_tensor</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">test_x_z_scaled</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>
    <span class="c1"># valid_x_tensor=torch.from_numpy(train_x).float()</span>
    <span class="n">pred</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">valid_x_tensor</span><span class="p">)</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">pred</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
    <span class="c1"># if USE_BRADEN_SCALING:</span>
    <span class="c1">#     fig, ax = plt.subplots(1,1)</span>
    <span class="c1">#     label=FIELDS[target][&#39;ylabel&#39;]</span>
    <span class="c1">#     ax.hist(p, label=f&#39;Predicted post-z ratio for {label}&#39;, alpha=0.4, density=True)</span>
    <span class="c1">#     # orig_ratio = z(T(&#39;m&#39;, scaled_df=scaled_train_data))</span>
    <span class="c1">#     orig_ratio = z(T(&#39;m&#39;, scaled_df=scaled_test_data))</span>
    <span class="c1">#     print(orig_ratio[:5])</span>
    <span class="c1">#     ax.hist(orig_ratio, label = f&#39;original post-z ratio for {label}&#39;, alpha=0.4,density=True)</span>
    <span class="c1">#     ax.grid()</span>
    <span class="c1">#     set_axes(ax, xlabel=&#39;predicted $T$&#39;)</span>
    <span class="c1"># print(&#39;predicted ratio shape: &#39;, p.shape)</span>
    <span class="k">return</span> <span class="n">p</span>




<span class="c1"># @memory.cache</span>
<span class="k">def</span> <span class="nf">get_hist</span><span class="p">(</span><span class="n">label</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;label could be &quot;pT&quot;, &quot;eta&quot;, &quot;phi&quot;, &quot;m&quot; &quot;&quot;&quot;</span>
    <span class="n">predicted_label_counts</span><span class="p">,</span> <span class="n">label_edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span>
        <span class="n">JETS_DICT</span><span class="p">[</span><span class="s2">&quot;Predicted_RecoData&quot;</span> <span class="o">+</span> <span class="n">label</span><span class="p">][</span><span class="s2">&quot;dist&quot;</span><span class="p">],</span>
        <span class="nb">range</span><span class="o">=</span><span class="n">JETS_DICT</span><span class="p">[</span><span class="s2">&quot;Predicted_RecoData&quot;</span> <span class="o">+</span> <span class="n">label</span><span class="p">][</span><span class="s2">&quot;range&quot;</span><span class="p">],</span>
        <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">real_label_counts</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span>
        <span class="n">JETS_DICT</span><span class="p">[</span><span class="s2">&quot;Real_RecoData&quot;</span> <span class="o">+</span> <span class="n">label</span><span class="p">][</span><span class="s2">&quot;dist&quot;</span><span class="p">],</span>
        <span class="nb">range</span><span class="o">=</span><span class="n">JETS_DICT</span><span class="p">[</span><span class="s2">&quot;Real_RecoData&quot;</span> <span class="o">+</span> <span class="n">label</span><span class="p">][</span><span class="s2">&quot;range&quot;</span><span class="p">],</span>
        <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">label_edges</span> <span class="o">=</span> <span class="n">label_edges</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">label_edges</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span>

    <span class="k">return</span> <span class="n">real_label_counts</span><span class="p">,</span> <span class="n">predicted_label_counts</span><span class="p">,</span> <span class="n">label_edges</span>


<span class="c1"># @memory.cache</span>
<span class="k">def</span> <span class="nf">get_hist_simple</span><span class="p">(</span><span class="n">predicted_dist</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
    
    <span class="n">range_</span> <span class="o">=</span> <span class="p">(</span><span class="n">FIELDS</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="s2">&quot;xmin&quot;</span><span class="p">],</span> <span class="n">FIELDS</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="s2">&quot;xmax&quot;</span><span class="p">])</span>
    <span class="n">bins</span><span class="o">=</span><span class="mi">50</span>
    <span class="n">predicted_label_counts</span><span class="p">,</span> <span class="n">label_edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span>
        <span class="n">predicted_dist</span><span class="p">,</span> <span class="nb">range</span><span class="o">=</span><span class="n">range_</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bins</span>
    <span class="p">)</span>
    
    
    <span class="n">real_label_counts</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">REAL_DIST</span><span class="p">,</span> <span class="nb">range</span><span class="o">=</span><span class="n">range_</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">)</span>
    <span class="n">label_edges</span> <span class="o">=</span> <span class="n">label_edges</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">label_edges</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="k">return</span> <span class="n">real_label_counts</span><span class="p">,</span> <span class="n">predicted_label_counts</span><span class="p">,</span> <span class="n">label_edges</span>


<span class="c1"># @memory.cache</span>
<span class="k">def</span> <span class="nf">plot_one</span><span class="p">(</span>
    <span class="n">target</span><span class="p">,</span> <span class="n">real_edges</span><span class="p">,</span> <span class="n">real_counts</span><span class="p">,</span> <span class="n">predicted_counts</span><span class="p">,</span> <span class="n">save_plot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">PARAMS</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">JUPYTER</span><span class="o">=</span><span class="kc">True</span>
<span class="p">):</span>
    <span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span>
        <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mf">3.5</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">/</span> <span class="mf">2.5</span><span class="p">,</span> <span class="mf">3.8</span><span class="p">),</span> <span class="n">gridspec_kw</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;height_ratios&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">]}</span>
    <span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">step</span><span class="p">(</span>
        <span class="n">real_edges</span><span class="p">,</span> <span class="n">real_counts</span> <span class="o">/</span> <span class="n">norm_data</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="s2">&quot;mid&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span>
    <span class="p">)</span>  <span class="c1"># step real_count_pt</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">step</span><span class="p">(</span>
        <span class="n">real_edges</span><span class="p">,</span>
        <span class="n">predicted_label_counts_m</span> <span class="o">/</span> <span class="n">norm_IQN</span><span class="p">,</span>
        <span class="n">where</span><span class="o">=</span><span class="s2">&quot;mid&quot;</span><span class="p">,</span>
        <span class="n">color</span><span class="o">=</span><span class="s2">&quot;#D7301F&quot;</span><span class="p">,</span>
        <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
    <span class="p">)</span>  <span class="c1"># step predicted_count_pt</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
        <span class="n">real_edges</span><span class="p">,</span>
        <span class="n">real_counts</span> <span class="o">/</span> <span class="n">norm_data</span><span class="p">,</span>
        <span class="n">label</span><span class="o">=</span><span class="s2">&quot;reco&quot;</span><span class="p">,</span>
        <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span>
        <span class="n">facecolors</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span>
        <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;o&quot;</span><span class="p">,</span>
        <span class="n">s</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
        <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
        <span class="n">real_edges</span><span class="p">,</span>
        <span class="n">predicted_counts</span> <span class="o">/</span> <span class="n">norm_IQN</span><span class="p">,</span>
        <span class="n">label</span><span class="o">=</span><span class="s2">&quot;predicted&quot;</span><span class="p">,</span>
        <span class="n">color</span><span class="o">=</span><span class="s2">&quot;#D7301F&quot;</span><span class="p">,</span>
        <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">,</span>
        <span class="n">s</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
        <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">range_</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">predicted_counts</span> <span class="o">/</span> <span class="n">norm_IQN</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1.1</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;counts&quot;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([])</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper right&quot;</span><span class="p">)</span>

    <span class="n">ratio</span> <span class="o">=</span> <span class="p">(</span><span class="n">predicted_counts</span> <span class="o">/</span> <span class="n">norm_IQN</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">real_counts</span> <span class="o">/</span> <span class="n">norm_data</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
        <span class="n">real_edges</span><span class="p">,</span> <span class="n">ratio</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span>
    <span class="p">)</span>  <span class="c1"># PREDICTED (IQN)/Reco (Data)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
        <span class="n">real_edges</span><span class="p">,</span>
        <span class="n">ratio</span> <span class="o">/</span> <span class="n">ratio</span><span class="p">,</span>
        <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span>
        <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;o&quot;</span><span class="p">,</span>
        <span class="n">facecolors</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span>
        <span class="n">s</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
        <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">range_</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">FIELDS</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="s2">&quot;xlabel&quot;</span><span class="p">])</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span>
        <span class="sa">r</span><span class="s2">&quot;$\frac{\textnormal</span><span class="si">{predicted}</span><span class="s2">}{\textnormal</span><span class="si">{reco}</span><span class="s2">}$&quot;</span>
        <span class="c1">#    , fontsize=10</span>
    <span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">((</span><span class="n">YLIM</span><span class="p">))</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">range_</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">([])</span>
    <span class="k">if</span> <span class="n">JUPYTER</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">wspace</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">hspace</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">wspace</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">hspace</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>

    <span class="c1"># plt.gca().set_position([0, 0, 1, 1])</span>
    <span class="k">if</span> <span class="n">save_plot</span><span class="p">:</span>
        <span class="n">plot_filename</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_model_filename</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">PARAMS</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.dict&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;.png&quot;</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">IQN_BASE</span><span class="p">,</span> <span class="s2">&quot;JupyterBook&quot;</span><span class="p">,</span> <span class="s2">&quot;Cluster&quot;</span><span class="p">,</span> <span class="s2">&quot;EVALUATE&quot;</span><span class="p">,</span> <span class="n">plot_filename</span><span class="p">)</span>
        <span class="p">)</span>

    
    <span class="c1"># fig.show()</span>
    <span class="c1"># plt.show();</span>
    <span class="c1"># plt.axis(&quot;off&quot;)</span>
    <span class="c1"># plt.gca().set_position([0, 0, 1, 1])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">raw_train_data</span><span class="p">,</span> <span class="n">raw_test_data</span><span class="p">,</span> <span class="n">raw_valid_data</span> <span class="o">=</span> <span class="n">load_raw_data</span><span class="p">()</span>

<span class="c1"># Load scaled data</span>
<span class="n">scaled_train_data</span><span class="p">,</span> <span class="n">scaled_test_data</span><span class="p">,</span> <span class="n">scaled_valid_data</span> <span class="o">=</span> <span class="n">load_scaled_dataframes</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>SUBSAMPLE = None


 RAW TRAIN DATA

(8000000, 9)

 RAW TEST DATA

(1000000, 9)
</pre></div>
</div>
</div>
</div>
</section>
<section id="evaluate-mass">
<h2>3.3: Evaluate Mass<a class="headerlink" href="#evaluate-mass" title="Permalink to this headline">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">target</span> <span class="o">=</span> <span class="s2">&quot;RecoDatam&quot;</span>
<span class="n">source</span> <span class="o">=</span> <span class="n">FIELDS</span><span class="p">[</span><span class="n">target</span><span class="p">]</span>
<span class="n">features</span> <span class="o">=</span> <span class="n">source</span><span class="p">[</span><span class="s2">&quot;inputs&quot;</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Training Features:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">features</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Target = &quot;</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
<span class="n">AUTOREGRESSIVE_DIST_NAME</span> <span class="o">=</span> <span class="s2">&quot;AUTOREGRESSIVE_m_Prime.csv&quot;</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;USING NEW DATASET</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="c1">######################################</span>
<span class="n">USE_BRADEN_SCALING</span> <span class="o">=</span> <span class="kc">False</span>
<span class="c1">#####################################</span>
<span class="c1">################################### CONFIGURATIONS ###################################</span>

<span class="n">JUPYTER</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">use_subsample</span> <span class="o">=</span> <span class="kc">False</span>
<span class="c1"># use_subsample = True</span>
<span class="k">if</span> <span class="n">use_subsample</span><span class="p">:</span>
    <span class="n">SUBSAMPLE</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span>
        <span class="mf">1e5</span>
    <span class="p">)</span>  <span class="c1"># subsample use for development - in production use whole dataset</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">SUBSAMPLE</span> <span class="o">=</span> <span class="kc">None</span>

<span class="c1">########################################################################################</span>
<span class="c1"># Get targets and features</span>
<span class="k">if</span> <span class="n">USE_BRADEN_SCALING</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;spliting data for </span><span class="si">{</span><span class="n">target</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">train_t</span><span class="p">,</span> <span class="n">train_x</span> <span class="o">=</span> <span class="n">split_t_x</span><span class="p">(</span>
        <span class="n">df</span><span class="o">=</span><span class="n">scaled_train_data</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="n">target</span><span class="p">,</span> <span class="n">input_features</span><span class="o">=</span><span class="n">features</span>
    <span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;train_t shape = &quot;</span><span class="p">,</span> <span class="n">train_t</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="s2">&quot;train_x shape = &quot;</span><span class="p">,</span> <span class="n">train_x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> Training features:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">train_x</span><span class="p">)</span>
    <span class="n">valid_t</span><span class="p">,</span> <span class="n">valid_x</span> <span class="o">=</span> <span class="n">split_t_x</span><span class="p">(</span>
        <span class="n">df</span><span class="o">=</span><span class="n">scaled_valid_data</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="n">target</span><span class="p">,</span> <span class="n">input_features</span><span class="o">=</span><span class="n">features</span>
    <span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;valid_t shape = &quot;</span><span class="p">,</span> <span class="n">valid_t</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="s2">&quot;valid_x shape = &quot;</span><span class="p">,</span> <span class="n">valid_x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">test_t</span><span class="p">,</span> <span class="n">test_x</span> <span class="o">=</span> <span class="n">split_t_x</span><span class="p">(</span>
        <span class="n">df</span><span class="o">=</span><span class="n">scaled_test_data</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="n">target</span><span class="p">,</span> <span class="n">input_features</span><span class="o">=</span><span class="n">features</span>
    <span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;test_t shape = &quot;</span><span class="p">,</span> <span class="n">test_t</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="s2">&quot;test_x shape = &quot;</span><span class="p">,</span> <span class="n">test_x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;spliting data for </span><span class="si">{</span><span class="n">target</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">train_t</span><span class="p">,</span> <span class="n">train_x</span> <span class="o">=</span> <span class="n">normal_split_t_x</span><span class="p">(</span>
        <span class="n">df</span><span class="o">=</span><span class="n">raw_train_data</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="n">target</span><span class="p">,</span> <span class="n">input_features</span><span class="o">=</span><span class="n">features</span>
    <span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;train_t shape = &quot;</span><span class="p">,</span> <span class="n">train_t</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="s2">&quot;train_x shape = &quot;</span><span class="p">,</span> <span class="n">train_x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> Training features:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">train_x</span><span class="p">)</span>
    <span class="n">valid_t</span><span class="p">,</span> <span class="n">valid_x</span> <span class="o">=</span> <span class="n">normal_split_t_x</span><span class="p">(</span>
        <span class="n">df</span><span class="o">=</span><span class="n">raw_valid_data</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="n">target</span><span class="p">,</span> <span class="n">input_features</span><span class="o">=</span><span class="n">features</span>
    <span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;valid_t shape = &quot;</span><span class="p">,</span> <span class="n">valid_t</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="s2">&quot;valid_x shape = &quot;</span><span class="p">,</span> <span class="n">valid_x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">test_t</span><span class="p">,</span> <span class="n">test_x</span> <span class="o">=</span> <span class="n">normal_split_t_x</span><span class="p">(</span>
        <span class="n">df</span><span class="o">=</span><span class="n">raw_test_data</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="n">target</span><span class="p">,</span> <span class="n">input_features</span><span class="o">=</span><span class="n">features</span>
    <span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;test_t shape = &quot;</span><span class="p">,</span> <span class="n">test_t</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="s2">&quot;test_x shape = &quot;</span><span class="p">,</span> <span class="n">test_x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;no need to train_test_split since we already have the split dataframes&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">valid_x</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">valid_x</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">train_x</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">train_x</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">valid_t</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">valid_t</span><span class="o">.</span><span class="n">std</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="n">train_t</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">train_t</span><span class="o">.</span><span class="n">std</span><span class="p">())</span>
<span class="c1">######################################################</span>

<span class="c1"># Apply z scaling to features and targets</span>
<span class="c1"># to features</span>

<span class="n">NFEATURES</span> <span class="o">=</span> <span class="n">train_x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">TRAIN_SCALE_DICT</span> <span class="o">=</span> <span class="n">get_train_scale_dict</span><span class="p">(</span><span class="n">USE_BRADEN_SCALING</span><span class="p">)</span>
<span class="c1"># to features</span>
<span class="n">apply_z_generator</span> <span class="o">=</span> <span class="n">apply_z_to_features</span><span class="p">(</span><span class="n">TRAIN_SCALE_DICT</span><span class="p">,</span> <span class="n">train_x</span><span class="p">,</span> <span class="n">test_x</span><span class="p">,</span> <span class="n">valid_x</span><span class="p">)</span>
<span class="n">train_x_z_scaled</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">apply_z_generator</span><span class="p">)</span>
<span class="n">test_x_z_scaled</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">apply_z_generator</span><span class="p">)</span>
<span class="n">valid_x_z_scaled</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">apply_z_generator</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">valid_x_z_scaled</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">valid_x_z_scaled</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">train_x_z_scaled</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">train_x_z_scaled</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
<span class="c1"># to targets</span>
<span class="n">apply_z_to_targets_generator</span> <span class="o">=</span> <span class="n">apply_z_to_targets</span><span class="p">(</span><span class="n">train_t</span><span class="p">,</span> <span class="n">test_t</span><span class="p">,</span> <span class="n">valid_t</span><span class="p">)</span>
<span class="n">train_t_z_scaled</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">apply_z_to_targets_generator</span><span class="p">)</span>
<span class="n">test_t_z_scaled</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">apply_z_to_targets_generator</span><span class="p">)</span>
<span class="n">valid_t_z_scaled</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">apply_z_to_targets_generator</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">valid_t_z_scaled</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">valid_t_z_scaled</span><span class="o">.</span><span class="n">std</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="n">train_t_z_scaled</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">train_t_z_scaled</span><span class="o">.</span><span class="n">std</span><span class="p">())</span>

<span class="c1">###########################################################</span>
<span class="c1"># Get the  parameters for this model and training</span>
<span class="n">PARAMS_m</span> <span class="o">=</span> <span class="p">{</span>
<span class="s2">&quot;n_layers&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span>
<span class="s2">&quot;hidden_size&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span>
<span class="s2">&quot;dropout_1&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="mf">0.6</span><span class="p">),</span>
<span class="s2">&quot;dropout_2&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="mf">0.1</span><span class="p">),</span>
<span class="s2">&quot;activation&quot;</span><span class="p">:</span> <span class="s2">&quot;LeakyReLU&quot;</span><span class="p">,</span>
    <span class="s1">&#39;optimizer_name&#39;</span><span class="p">:</span><span class="s1">&#39;Adam&#39;</span><span class="p">,</span>
    <span class="s1">&#39;starting_learning_rate&#39;</span><span class="p">:</span><span class="nb">float</span><span class="p">(</span><span class="mf">1e-3</span><span class="p">),</span>
    <span class="s1">&#39;momentum&#39;</span><span class="p">:</span><span class="nb">float</span><span class="p">(</span><span class="mf">0.6</span><span class="p">),</span>
    <span class="s1">&#39;batch_size&#39;</span><span class="p">:</span><span class="nb">int</span><span class="p">(</span><span class="mi">1024</span><span class="p">),</span>
    <span class="s1">&#39;n_iterations&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="mf">3e5</span><span class="p">),</span>
<span class="p">}</span>

<span class="n">optimizer_name</span> <span class="o">=</span> <span class="n">PARAMS_m</span><span class="p">[</span><span class="s2">&quot;optimizer_name&quot;</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">optimizer_name</span><span class="p">))</span>
<span class="c1"># optimizer_name = BEST_PARAMS[&quot;optimizer_name&quot;].to_string().split()[1]</span>
<span class="n">NITERATIONS</span> <span class="o">=</span> <span class="n">PARAMS_m</span><span class="p">[</span><span class="s2">&quot;n_iterations&quot;</span><span class="p">]</span>
<span class="n">BATCHSIZE</span> <span class="o">=</span> <span class="n">PARAMS_m</span><span class="p">[</span><span class="s2">&quot;batch_size&quot;</span><span class="p">]</span>
<span class="n">comment</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

<span class="c1"># N_epochs X N_train_examples = N_iterations X batch_size</span>
<span class="n">N_epochs</span> <span class="o">=</span> <span class="p">(</span><span class="n">NITERATIONS</span> <span class="o">*</span> <span class="n">BATCHSIZE</span><span class="p">)</span> <span class="o">/</span> <span class="nb">int</span><span class="p">(</span><span class="n">train_x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span>
    <span class="sa">f</span><span class="s2">&quot;This model was trained for </span><span class="si">{</span><span class="n">NITERATIONS</span><span class="si">}</span><span class="s2"> iteration, which is  </span><span class="si">{</span><span class="n">N_epochs</span><span class="si">}</span><span class="s2"> epochs&quot;</span>
<span class="p">)</span>

<span class="c1"># &#39;Trained_IQNx4_%s_TUNED.dict&#39; % target</span>
<span class="n">filename_model</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_model_filename</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">PARAMS_m</span><span class="p">)</span>
<span class="c1"># OR, if you know a model filename directly, you can also specify it, but you have to make sure its parameters are the same</span>
<span class="c1"># Nominal one is &#39;Trained_IQNx4_RecoDatam_ 8_layer5_hiddenLeakyReLU_activation1024_batchsize300_Kiteration.dict&#39;, also in backup</span>
<span class="n">filename_model</span><span class="o">=</span><span class="s1">&#39;Trained_IQNx4_RecoDatam_ 8_layer5_hiddenLeakyReLU_activation1024_batchsize300_Kiteration.dict&#39;</span>
<span class="n">trained_models_dir</span> <span class="o">=</span> <span class="s2">&quot;trained_models&quot;</span>
<span class="n">utils</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">trained_models_dir</span><span class="p">)</span>
<span class="c1"># on cluster, Im using another TRAIN directory</span>
<span class="n">PATH_model</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
    <span class="n">IQN_BASE</span><span class="p">,</span>  <span class="c1"># the loaction of the repo</span>
    <span class="s2">&quot;JupyterBook&quot;</span><span class="p">,</span>  <span class="c1"># up tp TRAIN could be combined in a srs dicretory</span>
    <span class="s2">&quot;Cluster&quot;</span><span class="p">,</span>
    <span class="s2">&quot;TRAIN&quot;</span><span class="p">,</span>
    <span class="n">trained_models_dir</span><span class="p">,</span>  <span class="c1"># /trained_models</span>
    <span class="n">filename_model</span><span class="p">,</span>  <span class="c1"># utils.get_model_filename has the saved file format</span>
<span class="p">)</span>

<span class="c1"># Load trained model</span>
<span class="n">IQN_m</span> <span class="o">=</span> <span class="n">load_model</span><span class="p">(</span><span class="n">PATH_model</span><span class="p">,</span> <span class="n">PARAMS_m</span><span class="p">)</span>
<span class="c1"># Get predicted distribution</span>
<span class="n">p</span> <span class="o">=</span> <span class="n">simple_eval</span><span class="p">(</span><span class="n">IQN_m</span><span class="p">,</span> <span class="n">test_x_z_scaled</span><span class="p">)</span>

<span class="n">range_</span> <span class="o">=</span> <span class="p">(</span><span class="n">FIELDS</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="s2">&quot;xmin&quot;</span><span class="p">],</span> <span class="n">FIELDS</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="s2">&quot;xmax&quot;</span><span class="p">])</span>
<span class="n">bins</span> <span class="o">=</span> <span class="mi">50</span>
<span class="n">REAL_RAW_DATA</span> <span class="o">=</span> <span class="n">raw_test_data</span>

<span class="n">YLIM</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.8</span><span class="p">,</span> <span class="mf">1.2</span><span class="p">)</span>
<span class="c1">###########GET REAL DIST###########</span>
<span class="n">REAL_RAW_DATA</span> <span class="o">=</span> <span class="n">REAL_RAW_DATA</span><span class="p">[</span>
    <span class="p">[</span><span class="s2">&quot;RecoDatapT&quot;</span><span class="p">,</span> <span class="s2">&quot;RecoDataeta&quot;</span><span class="p">,</span> <span class="s2">&quot;RecoDataphi&quot;</span><span class="p">,</span> <span class="s2">&quot;RecoDatam&quot;</span><span class="p">]</span>
<span class="p">]</span>
<span class="n">REAL_RAW_DATA</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;realpT&quot;</span><span class="p">,</span> <span class="s2">&quot;realeta&quot;</span><span class="p">,</span> <span class="s2">&quot;realphi&quot;</span><span class="p">,</span> <span class="s2">&quot;realm&quot;</span><span class="p">]</span>
<span class="n">REAL_DIST</span> <span class="o">=</span> <span class="n">REAL_RAW_DATA</span><span class="p">[</span><span class="s2">&quot;realm&quot;</span><span class="p">]</span>
<span class="n">norm_data</span> <span class="o">=</span> <span class="n">REAL_RAW_DATA</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="c1">#############GET EVALUATION DIST#############</span>
<span class="n">raw_test_data</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>
<span class="n">m_reco</span> <span class="o">=</span> <span class="n">raw_test_data</span><span class="p">[</span><span class="s2">&quot;RecoDatam&quot;</span><span class="p">]</span>
<span class="n">m_gen</span> <span class="o">=</span> <span class="n">raw_test_data</span><span class="p">[</span><span class="s2">&quot;genDatam&quot;</span><span class="p">]</span>
<span class="c1"># plt.hist(m_reco,label=r&#39;$m_{gen}^{test \ data}$&#39;);plt.legend();plt.show()</span>


<span class="k">def</span> <span class="nf">descale_Braden_scaled_prediction</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">p</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Label could be m. p is the outcome of the model evaluation, e.g. </span>
<span class="sd">    IQN_m = load_model(PATH_model, PARAMS_m)</span>
<span class="sd">    p = simple_eval(IQN_m, test_x_z_scaled)</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># make sure you&#39;ve set braden scaling global variable to use this function.</span>
    <span class="k">assert</span> <span class="n">USE_BRADEN_SCALING</span><span class="o">==</span><span class="kc">True</span>
    <span class="n">orig_ratio</span> <span class="o">=</span> <span class="n">T</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">scaled_df</span><span class="o">=</span><span class="n">scaled_train_data</span><span class="p">)</span>
    <span class="n">z_inv_f</span> <span class="o">=</span> <span class="n">z_inverse</span><span class="p">(</span><span class="n">xprime</span><span class="o">=</span><span class="n">p</span><span class="p">,</span> <span class="n">mean</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">orig_ratio</span><span class="p">),</span> <span class="n">std</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">orig_ratio</span><span class="p">))</span>
    <span class="n">L_obs</span> <span class="o">=</span> <span class="n">L</span><span class="p">(</span><span class="n">orig_observable</span><span class="o">=</span><span class="n">m_gen</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">)</span>
    <span class="n">z_inv_f</span> <span class="o">=</span> <span class="n">z_inv_f</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">z_inv_f</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

    <span class="n">factor</span> <span class="o">=</span> <span class="p">(</span><span class="n">z_inv_f</span> <span class="o">*</span> <span class="p">(</span><span class="n">L_obs</span> <span class="o">+</span> <span class="mi">10</span><span class="p">))</span> <span class="o">-</span> <span class="mi">10</span>
    <span class="n">label_pred</span> <span class="o">=</span> <span class="n">L_inverse</span><span class="p">(</span><span class="n">L_observable</span><span class="o">=</span><span class="n">factor</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">label_pred</span>
    
    
<span class="n">m_pred</span> <span class="o">=</span> <span class="n">z_inverse2</span><span class="p">(</span>
    <span class="n">xprime</span><span class="o">=</span><span class="n">p</span><span class="p">,</span>
    <span class="n">train_mean</span><span class="o">=</span><span class="n">TRAIN_SCALE_DICT</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="s2">&quot;mean&quot;</span><span class="p">],</span>
    <span class="n">train_std</span><span class="o">=</span><span class="n">TRAIN_SCALE_DICT</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="s2">&quot;std&quot;</span><span class="p">],</span>
<span class="p">)</span>
<span class="n">m_pred</span> <span class="o">=</span> <span class="n">m_pred</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

<span class="c1"># Get histogram of predicted distribution</span>
<span class="n">real_label_counts_m</span><span class="p">,</span> <span class="n">predicted_label_counts_m</span><span class="p">,</span> <span class="n">label_edges_m</span> <span class="o">=</span> <span class="n">get_hist_simple</span><span class="p">(</span>
    <span class="n">predicted_dist</span><span class="o">=</span><span class="n">m_pred</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="n">target</span>
<span class="p">)</span>
<span class="c1"># eval_data=pd.read_csv(DATA_DIR+&#39;/test_data_10M_2.csv&#39;)</span>
<span class="c1"># Get evaluation data</span>
<span class="n">eval_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">DATA_DIR</span> <span class="o">+</span> <span class="s2">&quot;/test_data_10M_2.csv&quot;</span><span class="p">)</span>
<span class="n">ev_features</span> <span class="o">=</span> <span class="n">features</span>
<span class="n">eval_data</span> <span class="o">=</span> <span class="n">eval_data</span><span class="p">[</span><span class="n">ev_features</span><span class="p">]</span>
<span class="c1"># save new distribution (m) in the eval data as autoregressive eval for next IQN</span>
<span class="n">eval_data</span><span class="p">[</span><span class="n">target</span><span class="p">]</span> <span class="o">=</span> <span class="n">m_pred</span>

<span class="n">new_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">target</span><span class="p">]</span> <span class="o">+</span> <span class="n">features</span>
<span class="n">eval_data</span> <span class="o">=</span> <span class="n">eval_data</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">new_cols</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;EVALUATION DATA NEW INDEX</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">eval_data</span><span class="o">.</span><span class="n">head</span><span class="p">())</span>

<span class="n">eval_data</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span>
    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
        <span class="n">IQN_BASE</span><span class="p">,</span> <span class="s2">&quot;JupyterBook&quot;</span><span class="p">,</span> <span class="s2">&quot;Cluster&quot;</span><span class="p">,</span> <span class="s2">&quot;EVALUATE&quot;</span><span class="p">,</span> <span class="n">AUTOREGRESSIVE_DIST_NAME</span>
    <span class="p">)</span>
<span class="p">)</span>

<span class="c1"># Load this saved predited autoregressive distribution</span>
<span class="n">AUTOREGRESSIVE_DIST</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>
    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
        <span class="n">IQN_BASE</span><span class="p">,</span> <span class="s2">&quot;JupyterBook&quot;</span><span class="p">,</span> <span class="s2">&quot;Cluster&quot;</span><span class="p">,</span> <span class="s2">&quot;EVALUATE&quot;</span><span class="p">,</span> <span class="n">AUTOREGRESSIVE_DIST_NAME</span>
    <span class="p">)</span>
<span class="p">)</span>

<span class="c1"># norm_IQN=AUTOREGRESSIVE_DIST.shape[0]</span>
<span class="c1"># get normalization values</span>
<span class="n">norm_autoregressive</span> <span class="o">=</span> <span class="n">AUTOREGRESSIVE_DIST</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">norm_IQN</span> <span class="o">=</span> <span class="n">norm_autoregressive</span>
<span class="nb">print</span><span class="p">(</span>
    <span class="s2">&quot;norm_data&quot;</span><span class="p">,</span>
    <span class="n">norm_data</span><span class="p">,</span>
    <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">norm IQN&quot;</span><span class="p">,</span>
    <span class="n">norm_IQN</span><span class="p">,</span>
    <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">norm_autoregressive&quot;</span><span class="p">,</span>
    <span class="n">norm_autoregressive</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># Finally, plot predicted distribution</span>

<span class="n">plot_one</span><span class="p">(</span>
    <span class="n">target</span><span class="o">=</span><span class="n">target</span><span class="p">,</span>
    <span class="n">real_edges</span><span class="o">=</span><span class="n">label_edges_m</span><span class="p">,</span>
    <span class="n">real_counts</span><span class="o">=</span><span class="n">real_label_counts_m</span><span class="p">,</span>
    <span class="n">predicted_counts</span><span class="o">=</span><span class="n">predicted_label_counts_m</span><span class="p">,</span>
    <span class="n">save_plot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">PARAMS</span><span class="o">=</span><span class="n">PARAMS_m</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Training Features:
 [&#39;genDatapT&#39;, &#39;genDataeta&#39;, &#39;genDataphi&#39;, &#39;genDatam&#39;, &#39;tau&#39;]

Target =  RecoDatam
USING NEW DATASET

spliting data for RecoDatam
train_t shape =  (8000000,) train_x shape =  (8000000, 5)

 Training features:

[[29.4452      0.828187    2.90213     2.85348     0.36130954]
 [24.3193     -1.16351     0.636469    5.83685     0.12689925]
 [24.3193     -1.16351     0.636469    5.83685     0.96230681]
 ...
 [41.4192     -2.23358    -2.81921     7.19348     0.08421659]
 [35.4637     -1.12318     0.356494    6.06597     0.05535172]
 [26.5586     -1.09427    -1.49334     4.25409     0.07489863]]
valid_t shape =  (1000000,) valid_x shape =  (1000000, 5)
test_t shape =  (1000000,) test_x shape =  (1000000, 5)
no need to train_test_split since we already have the split dataframes
[ 3.27223764e+01  6.98189368e-04 -8.95543973e-04  6.96116528e+00
  5.00485136e-01] [15.19914133  2.20425356  1.81362773  2.78097831  0.28852734]
[ 3.26952341e+01 -1.78188172e-03 -3.83090331e-04  6.96299435e+00
  4.99915289e-01] [14.93793254  2.20430976  1.81382516  2.78133203  0.28867295]
5.5514112643334546 2.664124544901276
5.555567451922438 2.664339857066051
NORMAL UNSCALED DICTIONARY
{&#39;genDatapT&#39;: {&#39;mean&#39;: 32.695234084987476, &#39;std&#39;: 14.937932540562551}, &#39;genDataeta&#39;: {&#39;mean&#39;: -0.0017818817154031672, &#39;std&#39;: 2.204309760627079}, &#39;genDataphi&#39;: {&#39;mean&#39;: -0.0003830903308450233, &#39;std&#39;: 1.8138251604791067}, &#39;genDatam&#39;: {&#39;mean&#39;: 6.962994352358474, &#39;std&#39;: 2.781332025286383}, &#39;RecoDatapT&#39;: {&#39;mean&#39;: 32.86720151648752, &#39;std&#39;: 15.829355769531851}, &#39;RecoDataeta&#39;: {&#39;mean&#39;: -0.0017898858568513964, &#39;std&#39;: 2.197968491495457}, &#39;RecoDataphi&#39;: {&#39;mean&#39;: -0.0004719170328962474, &#39;std&#39;: 1.8144739820043825}, &#39;RecoDatam&#39;: {&#39;mean&#39;: 5.555567451922438, &#39;std&#39;: 2.664339857066051}}



[ 1.81700902e-03  1.12510099e-03 -2.82526482e-04 -6.57626105e-04
  5.00485136e-01] [1.01748627 0.9999745  0.99989115 0.99987283 0.28852734]
[ 1.61650249e-15 -1.10134124e-18 -3.12905257e-17  5.01036723e-15
  4.99915289e-01] [1.         1.         1.         1.         0.28867295]
-0.0015599314696879494 0.9999191874249058
6.996216939114674e-16 1.0000000000000002
&lt;class &#39;str&#39;&gt;
This model was trained for 300000 iteration, which is  38.4 epochs
RegularizedRegressionModel(
  (model): Sequential(
    (0): Linear(in_features=5, out_features=5, bias=True)
    (1): LeakyReLU(negative_slope=0.3)
    (2): Linear(in_features=5, out_features=5, bias=True)
    (3): BatchNorm1d(5, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
    (4): LeakyReLU(negative_slope=0.3)
    (5): Linear(in_features=5, out_features=5, bias=True)
    (6): BatchNorm1d(5, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
    (7): LeakyReLU(negative_slope=0.3)
    (8): Linear(in_features=5, out_features=5, bias=True)
    (9): BatchNorm1d(5, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
    (10): LeakyReLU(negative_slope=0.3)
    (11): Linear(in_features=5, out_features=5, bias=True)
    (12): BatchNorm1d(5, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
    (13): LeakyReLU(negative_slope=0.3)
    (14): Linear(in_features=5, out_features=5, bias=True)
    (15): BatchNorm1d(5, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
    (16): LeakyReLU(negative_slope=0.3)
    (17): Linear(in_features=5, out_features=5, bias=True)
    (18): BatchNorm1d(5, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
    (19): LeakyReLU(negative_slope=0.3)
    (20): Linear(in_features=5, out_features=5, bias=True)
    (21): BatchNorm1d(5, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
    (22): LeakyReLU(negative_slope=0.3)
    (23): Linear(in_features=5, out_features=1, bias=True)
  )
)
EVALUATION DATA NEW INDEX
    RecoDatam  genDatapT  genDataeta  genDataphi  genDatam       tau
0   4.786460    43.6113    0.824891    -1.26949   5.93310  0.250046
1   6.979283    43.6113    0.824891    -1.26949   5.93310  0.847493
2   5.452590    26.0153    3.529970     1.55495   7.41270  0.851995
3   3.426970    28.4944   -1.159650     1.82602   7.84157  0.052378
4   3.526737    21.9840    2.747660     2.03085   5.18315  0.542549
norm_data 1000000 
norm IQN 1000000 
norm_autoregressive 1000000
</pre></div>
</div>
<img alt="_images/3_Autoregressive_Evaluation_8_1.png" src="_images/3_Autoregressive_Evaluation_8_1.png" />
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;Figure size 432x288 with 0 Axes&gt;
</pre></div>
</div>
</div>
</div>
</section>
<section id="evaluate-p-t">
<h2>3.4: Evaluate <span class="math notranslate nohighlight">\(p_T\)</span><a class="headerlink" href="#evaluate-p-t" title="Permalink to this headline">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">target</span> <span class="o">=</span> <span class="s2">&quot;RecoDatapT&quot;</span>
<span class="n">source</span> <span class="o">=</span> <span class="n">FIELDS</span><span class="p">[</span><span class="n">target</span><span class="p">]</span>
<span class="n">features</span> <span class="o">=</span> <span class="n">source</span><span class="p">[</span><span class="s2">&quot;inputs&quot;</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Training Features:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">features</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Target = &quot;</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
<span class="n">PREVIOUS_AUTOREGRESSIVE_DIST_NAME</span> <span class="o">=</span> <span class="s2">&quot;AUTOREGRESSIVE_m_Prime.csv&quot;</span>
<span class="n">AUTOREGRESSIVE_DIST_NAME</span> <span class="o">=</span> <span class="s2">&quot;AUTOREGRESSIVE_m_Prime_pT_Prime.csv&quot;</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;USING NEW DATASET</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="c1">######################################</span>
<span class="n">USE_BRADEN_SCALING</span> <span class="o">=</span> <span class="kc">False</span>

<span class="c1">########################################################################################</span>
<span class="n">raw_train_data</span><span class="p">,</span> <span class="n">raw_test_data</span><span class="p">,</span> <span class="n">raw_valid_data</span> <span class="o">=</span> <span class="n">load_raw_data</span><span class="p">(</span><span class="n">AUTOREGRESSIVE_DIST_NAME</span><span class="o">=</span><span class="n">PREVIOUS_AUTOREGRESSIVE_DIST_NAME</span><span class="p">)</span>
<span class="c1"># Load scaled data</span>
<span class="c1"># scaled_train_data, scaled_test_data, scaled_valid_data = load_scaled_dataframes()</span>


<span class="c1">################################################## Load Evaluation Data</span>
    
<span class="c1"># eval_data = pd.read_csv(</span>
<span class="c1">#     os.path.join(</span>
<span class="c1">#         IQN_BASE,</span>
<span class="c1">#         &quot;JupyterBook&quot;,</span>
<span class="c1">#         &quot;Cluster&quot;,</span>
<span class="c1">#         &quot;EVALUATE&quot;,</span>
<span class="c1">#         PREVIOUS_AUTOREGRESSIVE_DIST_NAME,</span>
<span class="c1">#     )</span>
<span class="c1"># )</span>

<span class="c1"># Or test on actual test (evaluation) data for development</span>
<span class="c1"># eval_data=pd.read_csv(DATA_DIR+&#39;/test_data_10M_2.csv&#39;)</span>

<span class="c1"># Get targets and features</span>
<span class="k">if</span> <span class="n">USE_BRADEN_SCALING</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;spliting data for </span><span class="si">{</span><span class="n">target</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">train_t</span><span class="p">,</span> <span class="n">train_x</span> <span class="o">=</span> <span class="n">split_t_x</span><span class="p">(</span>
        <span class="n">df</span><span class="o">=</span><span class="n">scaled_train_data</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="n">target</span><span class="p">,</span> <span class="n">input_features</span><span class="o">=</span><span class="n">features</span>
    <span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;train_t shape = &quot;</span><span class="p">,</span> <span class="n">train_t</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="s2">&quot;train_x shape = &quot;</span><span class="p">,</span> <span class="n">train_x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> Training features:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">train_x</span><span class="p">)</span>
    <span class="n">valid_t</span><span class="p">,</span> <span class="n">valid_x</span> <span class="o">=</span> <span class="n">split_t_x</span><span class="p">(</span>
        <span class="n">df</span><span class="o">=</span><span class="n">scaled_valid_data</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="n">target</span><span class="p">,</span> <span class="n">input_features</span><span class="o">=</span><span class="n">features</span>
    <span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;valid_t shape = &quot;</span><span class="p">,</span> <span class="n">valid_t</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="s2">&quot;valid_x shape = &quot;</span><span class="p">,</span> <span class="n">valid_x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        
    <span class="c1">##### WHAT MATTERS IS TEST (EVALUATION)</span>

    <span class="n">test_t</span><span class="p">,</span> <span class="n">test_x</span> <span class="o">=</span> <span class="n">split_t_x</span><span class="p">(</span>
        <span class="n">df</span><span class="o">=</span><span class="n">scaled_test_data</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="n">target</span><span class="p">,</span> <span class="n">input_features</span><span class="o">=</span><span class="n">features</span>
    <span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;test_t shape = &quot;</span><span class="p">,</span> <span class="n">test_t</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="s2">&quot;test_x shape = &quot;</span><span class="p">,</span> <span class="n">test_x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;spliting autoregressive evaluation data for </span><span class="si">{</span><span class="n">target</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">train_t</span><span class="p">,</span> <span class="n">train_x</span> <span class="o">=</span> <span class="n">normal_split_t_x</span><span class="p">(</span>
            <span class="n">df</span><span class="o">=</span><span class="n">raw_train_data</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="n">target</span><span class="p">,</span> <span class="n">input_features</span><span class="o">=</span><span class="n">features</span>
        <span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;train_t shape = &quot;</span><span class="p">,</span> <span class="n">train_t</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="s2">&quot;train_x shape = &quot;</span><span class="p">,</span> <span class="n">train_x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> Training features:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">train_x</span><span class="p">)</span>
    <span class="n">valid_t</span><span class="p">,</span> <span class="n">valid_x</span> <span class="o">=</span> <span class="n">normal_split_t_x</span><span class="p">(</span>
        <span class="n">df</span><span class="o">=</span><span class="n">raw_valid_data</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="n">target</span><span class="p">,</span> <span class="n">input_features</span><span class="o">=</span><span class="n">features</span>
    <span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;valid_t shape = &quot;</span><span class="p">,</span> <span class="n">valid_t</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="s2">&quot;valid_x shape = &quot;</span><span class="p">,</span> <span class="n">valid_x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="c1">##### WHAT MATTERS IS TEST (EVALUATION)</span>
    <span class="n">test_t</span><span class="p">,</span> <span class="n">test_x</span> <span class="o">=</span> <span class="n">normal_split_t_x</span><span class="p">(</span>
        <span class="n">df</span><span class="o">=</span><span class="n">raw_test_data</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="n">target</span><span class="p">,</span> <span class="n">input_features</span><span class="o">=</span><span class="n">features</span>
    <span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;test_t shape = &quot;</span><span class="p">,</span> <span class="n">test_t</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="s2">&quot;test_x shape = &quot;</span><span class="p">,</span> <span class="n">test_x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;no need to train_test_split since we already have the split dataframes&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">valid_x</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">valid_x</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">train_x</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">train_x</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">valid_t</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">valid_t</span><span class="o">.</span><span class="n">std</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="n">train_t</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">train_t</span><span class="o">.</span><span class="n">std</span><span class="p">())</span>
<span class="c1">######################################################</span>
<span class="c1"># Replace test_x with eval_data</span>

<span class="c1"># ev_features = features</span>
<span class="c1"># eval_data_df = eval_data[ev_features]</span>
<span class="c1"># eval_data = np.array(eval_data_df)</span>
<span class="c1"># test_x = eval_data</span>

<span class="c1"># eval_data=pd.read_csv(DATA_DIR+&#39;/test_data_10M_2.csv&#39;)</span>
    
<span class="c1"># eval_data=raw_train_data[:raw_test_data.shape[0]]</span>
<span class="c1"># test_x = np.array</span>

<span class="c1"># Apply z scaling to features and targets</span>
<span class="c1"># to features</span>

<span class="n">NFEATURES</span> <span class="o">=</span> <span class="n">train_x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">TRAIN_SCALE_DICT</span> <span class="o">=</span> <span class="n">get_train_scale_dict</span><span class="p">(</span><span class="n">USE_BRADEN_SCALING</span><span class="p">)</span>
<span class="c1"># to features</span>
<span class="n">apply_z_generator</span> <span class="o">=</span> <span class="n">apply_z_to_features</span><span class="p">(</span><span class="n">TRAIN_SCALE_DICT</span><span class="p">,</span> <span class="n">train_x</span><span class="p">,</span> <span class="n">test_x</span><span class="p">,</span> <span class="n">valid_x</span><span class="p">)</span>
<span class="n">train_x_z_scaled</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">apply_z_generator</span><span class="p">)</span>
<span class="n">test_x_z_scaled</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">apply_z_generator</span><span class="p">)</span>
<span class="n">valid_x_z_scaled</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">apply_z_generator</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">valid_x_z_scaled</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">valid_x_z_scaled</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">train_x_z_scaled</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">train_x_z_scaled</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
<span class="c1"># to targets</span>
<span class="n">apply_z_to_targets_generator</span> <span class="o">=</span> <span class="n">apply_z_to_targets</span><span class="p">(</span><span class="n">train_t</span><span class="p">,</span> <span class="n">test_t</span><span class="p">,</span> <span class="n">valid_t</span><span class="p">)</span>
<span class="n">train_t_z_scaled</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">apply_z_to_targets_generator</span><span class="p">)</span>
<span class="n">test_t_z_scaled</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">apply_z_to_targets_generator</span><span class="p">)</span>
<span class="n">valid_t_z_scaled</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">apply_z_to_targets_generator</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">valid_t_z_scaled</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">valid_t_z_scaled</span><span class="o">.</span><span class="n">std</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="n">train_t_z_scaled</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">train_t_z_scaled</span><span class="o">.</span><span class="n">std</span><span class="p">())</span>

<span class="c1">###########################################################</span>
<span class="c1"># Get the  parameters for this model and training</span>
<span class="n">PARAMS_pT</span> <span class="o">=</span>  <span class="p">{</span>
<span class="s2">&quot;n_layers&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="mi">15</span><span class="p">),</span>
<span class="s2">&quot;hidden_size&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span>
<span class="s2">&quot;dropout_1&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="mf">0.6</span><span class="p">),</span>
<span class="s2">&quot;dropout_2&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="mf">0.1</span><span class="p">),</span>
<span class="s2">&quot;activation&quot;</span><span class="p">:</span> <span class="s2">&quot;LeakyReLU&quot;</span><span class="p">,</span>
    <span class="s1">&#39;optimizer_name&#39;</span><span class="p">:</span><span class="s1">&#39;Adam&#39;</span><span class="p">,</span>
    <span class="s1">&#39;starting_learning_rate&#39;</span><span class="p">:</span><span class="nb">float</span><span class="p">(</span><span class="mf">1e-3</span><span class="p">),</span>
    <span class="s1">&#39;momentum&#39;</span><span class="p">:</span><span class="nb">float</span><span class="p">(</span><span class="mf">0.6</span><span class="p">),</span>
    <span class="s1">&#39;batch_size&#39;</span><span class="p">:</span><span class="nb">int</span><span class="p">(</span><span class="mi">1024</span><span class="p">),</span>
    <span class="s1">&#39;n_iterations&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="mf">2e5</span><span class="p">),</span>
<span class="p">}</span>

<span class="n">optimizer_name</span> <span class="o">=</span> <span class="n">PARAMS_pT</span><span class="p">[</span><span class="s2">&quot;optimizer_name&quot;</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">optimizer_name</span><span class="p">))</span>
<span class="c1"># optimizer_name = BEST_PARAMS[&quot;optimizer_name&quot;].to_string().split()[1]</span>
<span class="n">NITERATIONS</span> <span class="o">=</span> <span class="n">PARAMS_pT</span><span class="p">[</span><span class="s2">&quot;n_iterations&quot;</span><span class="p">]</span>
<span class="n">BATCHSIZE</span> <span class="o">=</span> <span class="n">PARAMS_pT</span><span class="p">[</span><span class="s2">&quot;batch_size&quot;</span><span class="p">]</span>
<span class="n">comment</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

<span class="c1"># N_epochs X N_train_examples = N_iterations X batch_size</span>
<span class="n">N_epochs</span> <span class="o">=</span> <span class="p">(</span><span class="n">NITERATIONS</span> <span class="o">*</span> <span class="n">BATCHSIZE</span><span class="p">)</span> <span class="o">/</span> <span class="nb">int</span><span class="p">(</span><span class="n">train_x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span>
    <span class="sa">f</span><span class="s2">&quot;This model was trained for </span><span class="si">{</span><span class="n">NITERATIONS</span><span class="si">}</span><span class="s2"> iteration, which is  </span><span class="si">{</span><span class="n">N_epochs</span><span class="si">}</span><span class="s2"> epochs&quot;</span>
<span class="p">)</span>


<span class="n">filename_model</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_model_filename</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">PARAMS_pT</span><span class="p">)</span>
<span class="c1"># filename_model = &#39;Trained_IQNx4_RecoDatapT_11_layer5_hiddenLeakyReLU_activation1024_batchsize200_Kiteration.dict&#39;</span>
<span class="n">trained_models_dir</span> <span class="o">=</span> <span class="s2">&quot;trained_models&quot;</span>
<span class="n">utils</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">trained_models_dir</span><span class="p">)</span>
<span class="c1"># on cluster, Im using another TRAIN directory</span>
<span class="n">PATH_model</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
    <span class="n">IQN_BASE</span><span class="p">,</span>  <span class="c1"># the loaction of the repo</span>
    <span class="s2">&quot;JupyterBook&quot;</span><span class="p">,</span>  <span class="c1"># up tp TRAIN could be combined in a srs dicretory</span>
    <span class="s2">&quot;Cluster&quot;</span><span class="p">,</span>
    <span class="s2">&quot;TRAIN&quot;</span><span class="p">,</span>
    <span class="n">trained_models_dir</span><span class="p">,</span>  <span class="c1"># /trained_models</span>
    <span class="n">filename_model</span><span class="p">,</span>  <span class="c1"># utils.get_model_filename has the saved file format</span>
<span class="p">)</span>

<span class="c1"># Load trained model</span>
<span class="n">IQN_pT</span> <span class="o">=</span> <span class="n">load_model</span><span class="p">(</span><span class="n">PATH_model</span><span class="p">,</span> <span class="n">PARAMS_pT</span><span class="p">)</span>
<span class="c1"># Get predicted distribution</span>
<span class="n">p</span> <span class="o">=</span> <span class="n">simple_eval</span><span class="p">(</span><span class="n">IQN_pT</span><span class="p">,</span> <span class="n">test_x_z_scaled</span><span class="p">)</span>

<span class="n">range_</span> <span class="o">=</span> <span class="p">(</span><span class="n">FIELDS</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="s2">&quot;xmin&quot;</span><span class="p">],</span> <span class="n">FIELDS</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="s2">&quot;xmax&quot;</span><span class="p">])</span>
<span class="n">bins</span> <span class="o">=</span> <span class="mi">50</span>
<span class="n">REAL_RAW_DATA</span> <span class="o">=</span> <span class="n">raw_test_data</span>

<span class="n">YLIM</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.8</span><span class="p">,</span> <span class="mf">1.2</span><span class="p">)</span>
<span class="c1">###########GET REAL DIST###########</span>
<span class="n">REAL_RAW_DATA</span> <span class="o">=</span> <span class="n">REAL_RAW_DATA</span><span class="p">[</span>
    <span class="p">[</span><span class="s2">&quot;RecoDatapT&quot;</span><span class="p">,</span> <span class="s2">&quot;RecoDataeta&quot;</span><span class="p">,</span> <span class="s2">&quot;RecoDataphi&quot;</span><span class="p">,</span> <span class="s2">&quot;RecoDatam&quot;</span><span class="p">]</span>
<span class="p">]</span>
<span class="n">REAL_RAW_DATA</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;realpT&quot;</span><span class="p">,</span> <span class="s2">&quot;realeta&quot;</span><span class="p">,</span> <span class="s2">&quot;realphi&quot;</span><span class="p">,</span> <span class="s2">&quot;realm&quot;</span><span class="p">]</span>
<span class="n">REAL_DIST</span> <span class="o">=</span> <span class="n">REAL_RAW_DATA</span><span class="p">[</span><span class="s2">&quot;realpT&quot;</span><span class="p">]</span>
<span class="n">norm_data</span> <span class="o">=</span> <span class="n">REAL_RAW_DATA</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="c1">#############GET EVALUATION DIST#############</span>
<span class="n">raw_test_data</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>
<span class="n">pT_reco</span> <span class="o">=</span> <span class="n">raw_test_data</span><span class="p">[</span><span class="s2">&quot;RecoDatapT&quot;</span><span class="p">]</span>
<span class="n">pT_gen</span> <span class="o">=</span> <span class="n">raw_test_data</span><span class="p">[</span><span class="s2">&quot;genDatapT&quot;</span><span class="p">]</span>
<span class="c1"># plt.hist(m_reco,label=r&#39;$m_{gen}^{test \ data}$&#39;);plt.legend();plt.show()</span>

<span class="k">def</span> <span class="nf">descale_Braden_scaled_prediction</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">p</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Label could be m. p is the outcome of the model evaluation, e.g. </span>
<span class="sd">    IQN_m = load_model(PATH_model, PARAMS_m)</span>
<span class="sd">    p = simple_eval(IQN_m, test_x_z_scaled)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># make sure you&#39;ve set braden scaling global variable to use this function.</span>
    <span class="k">assert</span> <span class="n">USE_BRADEN_SCALING</span><span class="o">==</span><span class="kc">True</span>
    <span class="n">orig_ratio</span> <span class="o">=</span> <span class="n">T</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">scaled_df</span><span class="o">=</span><span class="n">scaled_train_data</span><span class="p">)</span>
    <span class="n">z_inv_f</span> <span class="o">=</span> <span class="n">z_inverse</span><span class="p">(</span><span class="n">xprime</span><span class="o">=</span><span class="n">p</span><span class="p">,</span> <span class="n">mean</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">orig_ratio</span><span class="p">),</span> <span class="n">std</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">orig_ratio</span><span class="p">))</span>
    <span class="n">L_obs</span> <span class="o">=</span> <span class="n">L</span><span class="p">(</span><span class="n">orig_observable</span><span class="o">=</span><span class="n">pT_gen</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">)</span>
    <span class="n">z_inv_f</span> <span class="o">=</span> <span class="n">z_inv_f</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">z_inv_f</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

    <span class="n">factor</span> <span class="o">=</span> <span class="p">(</span><span class="n">z_inv_f</span> <span class="o">*</span> <span class="p">(</span><span class="n">L_obs</span> <span class="o">+</span> <span class="mi">10</span><span class="p">))</span> <span class="o">-</span> <span class="mi">10</span>
    <span class="n">label_pred</span> <span class="o">=</span> <span class="n">L_inverse</span><span class="p">(</span><span class="n">L_observable</span><span class="o">=</span><span class="n">factor</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">label_pred</span>


<span class="n">pT_pred</span> <span class="o">=</span> <span class="n">z_inverse2</span><span class="p">(</span>
    <span class="n">xprime</span><span class="o">=</span><span class="n">p</span><span class="p">,</span>
    <span class="n">train_mean</span><span class="o">=</span><span class="n">TRAIN_SCALE_DICT</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="s2">&quot;mean&quot;</span><span class="p">],</span>
    <span class="n">train_std</span><span class="o">=</span><span class="n">TRAIN_SCALE_DICT</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="s2">&quot;std&quot;</span><span class="p">],</span>
<span class="p">)</span>
<span class="n">pT_pred</span> <span class="o">=</span> <span class="n">pT_pred</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

<span class="c1"># Get histogram of predicted distribution</span>
<span class="n">real_label_counts_pT</span><span class="p">,</span> <span class="n">predicted_label_counts_pT</span><span class="p">,</span> <span class="n">label_edges_pT</span> <span class="o">=</span> <span class="n">get_hist_simple</span><span class="p">(</span>
    <span class="n">predicted_dist</span><span class="o">=</span><span class="n">pT_pred</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="n">target</span>
<span class="p">)</span>

<span class="c1"># Get evaluation data as test data for development</span>

<span class="n">eval_data_df</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">DATA_DIR</span><span class="o">+</span><span class="s1">&#39;/test_data_10M_2.csv&#39;</span><span class="p">)[</span><span class="n">features</span><span class="p">]</span>


<span class="c1"># save new distribution (m) in the eval data as autoregressive eval for next IQN</span>
<span class="c1"># eval_data_df[target] = pT_pred</span>

<span class="n">new_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;RecoDatam&quot;</span><span class="p">,</span> <span class="n">target</span><span class="p">]</span> <span class="o">+</span> <span class="n">X</span>
<span class="n">eval_data_df</span> <span class="o">=</span> <span class="n">eval_data_df</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">new_cols</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;EVALUATION DATA NEW INDEX</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">eval_data_df</span><span class="o">.</span><span class="n">head</span><span class="p">())</span>

<span class="n">eval_data_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span>
    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
        <span class="n">IQN_BASE</span><span class="p">,</span> <span class="s2">&quot;JupyterBook&quot;</span><span class="p">,</span> <span class="s2">&quot;Cluster&quot;</span><span class="p">,</span> <span class="s2">&quot;EVALUATE&quot;</span><span class="p">,</span> <span class="n">AUTOREGRESSIVE_DIST_NAME</span>
    <span class="p">)</span>
<span class="p">)</span>

<span class="c1"># Load this saved predited autoregressive distribution</span>
<span class="n">AUTOREGRESSIVE_DIST</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>
    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
        <span class="n">IQN_BASE</span><span class="p">,</span> <span class="s2">&quot;JupyterBook&quot;</span><span class="p">,</span> <span class="s2">&quot;Cluster&quot;</span><span class="p">,</span> <span class="s2">&quot;EVALUATE&quot;</span><span class="p">,</span> <span class="n">AUTOREGRESSIVE_DIST_NAME</span>
    <span class="p">)</span>
<span class="p">)</span>

<span class="c1"># norm_IQN=AUTOREGRESSIVE_DIST.shape[0]</span>
<span class="c1"># get normalization values</span>
<span class="n">norm_autoregressive</span> <span class="o">=</span> <span class="n">AUTOREGRESSIVE_DIST</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">norm_IQN</span> <span class="o">=</span> <span class="n">norm_autoregressive</span>
<span class="nb">print</span><span class="p">(</span>
    <span class="s2">&quot;norm_data&quot;</span><span class="p">,</span>
    <span class="n">norm_data</span><span class="p">,</span>
    <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">norm IQN&quot;</span><span class="p">,</span>
    <span class="n">norm_IQN</span><span class="p">,</span>
    <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">norm_autoregressive&quot;</span><span class="p">,</span>
    <span class="n">norm_autoregressive</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># Finally, plot predicted distribution</span>
<span class="n">plot_one</span><span class="p">(</span>
    <span class="n">target</span><span class="o">=</span><span class="n">target</span><span class="p">,</span>
    <span class="n">real_edges</span><span class="o">=</span><span class="n">label_edges_pT</span><span class="p">,</span>
    <span class="n">real_counts</span><span class="o">=</span><span class="n">real_label_counts_pT</span><span class="p">,</span>
    <span class="n">predicted_counts</span><span class="o">=</span><span class="n">predicted_label_counts_pT</span><span class="p">,</span>
    <span class="n">save_plot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">PARAMS</span><span class="o">=</span><span class="n">PARAMS_pT</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Training Features:
 [&#39;RecoDatam&#39;, &#39;genDatapT&#39;, &#39;genDataeta&#39;, &#39;genDataphi&#39;, &#39;genDatam&#39;, &#39;tau&#39;]

Target =  RecoDatapT
USING NEW DATASET


SUBSAMPLE = None


 RAW TRAIN DATA

(8000000, 9)

 RAW TEST DATA

(1000000, 9)
spliting autoregressive evaluation data for RecoDatapT
train_t shape =  (8000000,) train_x shape =  (8000000, 6)

 Training features:

[[ 2.59587    29.4452      0.828187    2.90213     2.85348     0.36130954]
 [ 5.35538    24.3193     -1.16351     0.636469    5.83685     0.12689925]
 [ 5.35538    24.3193     -1.16351     0.636469    5.83685     0.96230681]
 ...
 [ 6.25659    41.4192     -2.23358    -2.81921     7.19348     0.08421659]
 [ 6.11213    35.4637     -1.12318     0.356494    6.06597     0.05535172]
 [ 4.17483    26.5586     -1.09427    -1.49334     4.25409     0.07489863]]
valid_t shape =  (1000000,) valid_x shape =  (1000000, 6)
test_t shape =  (1000000,) test_x shape =  (1000000, 6)
no need to train_test_split since we already have the split dataframes
[ 5.55141126e+00  3.27223764e+01  6.98189368e-04 -8.95543973e-04
  6.96116528e+00  5.00485136e-01] [ 2.66412454 15.19914133  2.20425356  1.81362773  2.78097831  0.28852734]
[ 5.55556745e+00  3.26952341e+01 -1.78188172e-03 -3.83090331e-04
  6.96299435e+00  4.99915289e-01] [ 2.66433986 14.93793254  2.20430976  1.81382516  2.78133203  0.28867295]
32.881453465999996 16.02400426348493
32.86720151648752 15.829355769531851
NORMAL UNSCALED DICTIONARY
{&#39;genDatapT&#39;: {&#39;mean&#39;: 32.695234084987476, &#39;std&#39;: 14.937932540562551}, &#39;genDataeta&#39;: {&#39;mean&#39;: -0.0017818817154031672, &#39;std&#39;: 2.204309760627079}, &#39;genDataphi&#39;: {&#39;mean&#39;: -0.0003830903308450233, &#39;std&#39;: 1.8138251604791067}, &#39;genDatam&#39;: {&#39;mean&#39;: 6.962994352358474, &#39;std&#39;: 2.781332025286383}, &#39;RecoDatapT&#39;: {&#39;mean&#39;: 32.86720151648752, &#39;std&#39;: 15.829355769531851}, &#39;RecoDataeta&#39;: {&#39;mean&#39;: -0.0017898858568513964, &#39;std&#39;: 2.197968491495457}, &#39;RecoDataphi&#39;: {&#39;mean&#39;: -0.0004719170328962474, &#39;std&#39;: 1.8144739820043825}, &#39;RecoDatam&#39;: {&#39;mean&#39;: 5.555567451922438, &#39;std&#39;: 2.664339857066051}}



[-1.81710707e+00  1.48455353e+01  5.96132264e-04 -2.50379668e+00
 -1.63658184e+00  5.00485136e-01] [0.17834627 6.89519305 1.2152514  0.65207164 0.17568487 0.28852734]
[-1.81682884e+00  1.48332220e+01 -7.71183141e-04 -2.50361243e+00
 -1.63646629e+00  4.99915289e-01] [0.17836068 6.77669391 1.21528238 0.65214262 0.17570722 0.28867295]
0.0009003493079555966 1.0122966781963252
-1.2048033681821834e-15 1.0000000000000002
&lt;class &#39;str&#39;&gt;
This model was trained for 200000 iteration, which is  25.6 epochs
RegularizedRegressionModel(
  (model): Sequential(
    (0): Linear(in_features=6, out_features=5, bias=True)
    (1): LeakyReLU(negative_slope=0.3)
    (2): Linear(in_features=5, out_features=5, bias=True)
    (3): BatchNorm1d(5, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
    (4): LeakyReLU(negative_slope=0.3)
    (5): Linear(in_features=5, out_features=5, bias=True)
    (6): BatchNorm1d(5, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
    (7): LeakyReLU(negative_slope=0.3)
    (8): Linear(in_features=5, out_features=5, bias=True)
    (9): BatchNorm1d(5, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
    (10): LeakyReLU(negative_slope=0.3)
    (11): Linear(in_features=5, out_features=5, bias=True)
    (12): BatchNorm1d(5, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
    (13): LeakyReLU(negative_slope=0.3)
    (14): Linear(in_features=5, out_features=5, bias=True)
    (15): BatchNorm1d(5, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
    (16): LeakyReLU(negative_slope=0.3)
    (17): Linear(in_features=5, out_features=5, bias=True)
    (18): BatchNorm1d(5, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
    (19): LeakyReLU(negative_slope=0.3)
    (20): Linear(in_features=5, out_features=5, bias=True)
    (21): BatchNorm1d(5, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
    (22): LeakyReLU(negative_slope=0.3)
    (23): Linear(in_features=5, out_features=5, bias=True)
    (24): BatchNorm1d(5, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
    (25): LeakyReLU(negative_slope=0.3)
    (26): Linear(in_features=5, out_features=5, bias=True)
    (27): BatchNorm1d(5, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
    (28): LeakyReLU(negative_slope=0.3)
    (29): Linear(in_features=5, out_features=5, bias=True)
    (30): BatchNorm1d(5, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
    (31): LeakyReLU(negative_slope=0.3)
    (32): Linear(in_features=5, out_features=5, bias=True)
    (33): BatchNorm1d(5, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
    (34): LeakyReLU(negative_slope=0.3)
    (35): Linear(in_features=5, out_features=5, bias=True)
    (36): BatchNorm1d(5, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
    (37): LeakyReLU(negative_slope=0.3)
    (38): Linear(in_features=5, out_features=5, bias=True)
    (39): BatchNorm1d(5, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
    (40): LeakyReLU(negative_slope=0.3)
    (41): Linear(in_features=5, out_features=5, bias=True)
    (42): BatchNorm1d(5, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
    (43): LeakyReLU(negative_slope=0.3)
    (44): Linear(in_features=5, out_features=1, bias=True)
  )
)
EVALUATION DATA NEW INDEX
    RecoDatam  RecoDatapT  genDatapT  genDataeta  genDataphi  genDatam  \
0    5.80270         NaN    43.6113    0.824891    -1.26949   5.93310   
1    5.80270         NaN    43.6113    0.824891    -1.26949   5.93310   
2    4.81403         NaN    26.0153    3.529970     1.55495   7.41270   
3    7.06425         NaN    28.4944   -1.159650     1.82602   7.84157   
4    4.08061         NaN    21.9840    2.747660     2.03085   5.18315   

        tau  
0  0.250046  
1  0.847493  
2  0.851995  
3  0.052378  
4  0.542549  
norm_data 1000000 
norm IQN 1000000 
norm_autoregressive 1000000
</pre></div>
</div>
<img alt="_images/3_Autoregressive_Evaluation_10_1.png" src="_images/3_Autoregressive_Evaluation_10_1.png" />
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;Figure size 432x288 with 0 Axes&gt;
</pre></div>
</div>
</div>
</div>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
            </main>
            <footer class="footer-article noprint">
                
    <!-- Previous / next buttons -->
<div class='prev-next-area'>
    <a class='left-prev' id="prev-link" href="2_Train_all_IQNs.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">2.1 Imports and Configurations</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="4_SupplementaryMaterials_OptunaTuning_Theory_ML_Background.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Chapter 4: Optional Supplementary Material</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
            </footer>
        </div>
    </div>
    <div class="footer-content row">
        <footer class="col footer"><p>
  
    By Ali Al Kadhim<br/>
  
      &copy; Copyright 2022.<br/>
</p>
        </footer>
    </div>
    
</div>


      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>


  </body>
</html>