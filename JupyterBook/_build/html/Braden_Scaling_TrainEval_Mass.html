
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Braden-Scaling IQNx4: 1.Mass (UNDER CONSTRUCTION!) &#8212; torchIQNx4</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">

    
  <link rel="stylesheet"
    href="_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" href="_static/styles/sphinx-book-theme.css?digest=5115cc725059bd94278eecd172e13a965bf8f5a9" type="text/css" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="_static/design-style.b7bb847fb20b106c3d81b95245e65545.min.css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">

    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/clipboard.min.js"></script>
    <script src="_static/copybutton.js"></script>
    <script src="_static/scripts/sphinx-book-theme.js?digest=9c920249402e914e316237a7dbc6769907cce411"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="_static/sphinx-thebe.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="prev" title="Welcome to the torchIQNx4" href="intro.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
<!-- Checkboxes to toggle the left sidebar -->
<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle navigation sidebar">
<label class="overlay overlay-navbar" for="__navigation">
    <div class="visually-hidden">Toggle navigation sidebar</div>
</label>
<!-- Checkboxes to toggle the in-page toc -->
<input type="checkbox" class="sidebar-toggle" name="__page-toc" id="__page-toc" aria-label="Toggle in-page Table of Contents">
<label class="overlay overlay-pagetoc" for="__page-toc">
    <div class="visually-hidden">Toggle in-page Table of Contents</div>
</label>
<!-- Headers at the top -->
<div class="announcement header-item noprint"></div>
<div class="header header-item noprint"></div>

    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<!-- Sidebar -->
<div class="bd-sidebar noprint" id="site-navigation">
    <div class="bd-sidebar__content">
        <div class="bd-sidebar__top"><div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="index.html">
      
      
      
      <h1 class="site-logo" id="site-title">torchIQNx4</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="intro.html">
                    Welcome to the torchIQNx4
                </a>
            </li>
        </ul>
        <ul class="current nav bd-sidenav">
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   Braden-Scaling IQNx4: 1.Mass (UNDER CONSTRUCTION!)
  </a>
 </li>
</ul>

    </div>
</nav></div>
        <div class="bd-sidebar__bottom">
             <!-- To handle the deprecated key -->
            
            <div class="navbar_extra_footer">
            Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
            </div>
            
        </div>
    </div>
    <div id="rtd-footer-container"></div>
</div>


          


          
<!-- A tiny helper pixel to detect if we've scrolled -->
<div class="sbt-scroll-pixel-helper"></div>
<!-- Main content -->
<div class="col py-0 content-container">
    
    <div class="header-article row sticky-top noprint">
        



<div class="col py-1 d-flex header-article-main">
    <div class="header-article__left">
        
        <label for="__navigation"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="right"
title="Toggle navigation"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-bars"></i>
  </span>

</label>

        
    </div>
    <div class="header-article__right">
<div class="menu-dropdown menu-dropdown-launch-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Launch interactive content">
      <i class="fas fa-rocket"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="https://mybinder.org/v2/gh/AliAlkadhim/torchQN/master?urlpath=tree/JupyterBook/Braden_Scaling_TrainEval_Mass.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Launch on Binder"
>
  

<span class="headerbtn__icon-container">
  
    <img src="_static/images/logo_binder.svg">
  </span>
<span class="headerbtn__text-container">Binder</span>
</a>

      </li>
      
    </ul>
  </div>
</div>

<button onclick="toggleFullScreen()"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="bottom"
title="Fullscreen mode"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>

<div class="menu-dropdown menu-dropdown-download-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Download this page">
      <i class="fas fa-download"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="_sources/Braden_Scaling_TrainEval_Mass.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Download source file"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="headerbtn__text-container">.ipynb</span>
</a>

      </li>
      
      <li>
        
<button onclick="printPdf(this)"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="left"
title="Print to PDF"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="headerbtn__text-container">.pdf</span>
</button>

      </li>
      
    </ul>
  </div>
</div>
<label for="__page-toc"
  class="headerbtn headerbtn-page-toc"
  
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-list"></i>
  </span>

</label>

    </div>
</div>

<!-- Table of contents -->
<div class="col-md-3 bd-toc show noprint">
    <div class="tocsection onthispage pt-5 pb-3">
        <i class="fas fa-list"></i> Contents
    </div>
    <nav id="bd-toc-nav" aria-label="Page">
        <ul class="visible nav section-nav flex-column">
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#">
   Braden-Scaling IQNx4: 1.Mass (UNDER CONSTRUCTION!)
  </a>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#do-source-setup-sh-before-trying-to-run-this-notebook">
   Do
   <code class="docutils literal notranslate">
    <span class="pre">
     source
    </span>
    <span class="pre">
     setup.sh
    </span>
   </code>
   before trying to run this notebook!
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#external-imports">
     External Imports
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#import-utils-and-set-environemnt-variables">
     Import utils, and set environemnt variables
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#a-user-is-competent-enought-to-do-source-setup-sh-on-a-setup-sh-script-that-comes-in-the-repo-such-as-the-next-cell-uncommented">
       A user is competent enought to do
       <code class="docutils literal notranslate">
        <span class="pre">
         source
        </span>
        <span class="pre">
         setup.sh
        </span>
       </code>
       on a
       <code class="docutils literal notranslate">
        <span class="pre">
         setup.sh
        </span>
       </code>
       script that comes in the repo, such as the next cell uncommented
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#set-arguments-and-configurations">
     Set arguments and configurations
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#import-the-numpy-data-convert-to-dataframe-and-save-if-you-haven-t-saved-the-dataframes">
       Import the numpy data, convert to dataframe and save (if you haven’t saved the dataframes)
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#explore-the-dataframe-and-preprocess">
   Explore the Dataframe and preprocess
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#results-prior-to-braden-scaling">
     Results prior to Braden-scaling
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#scale-the-data-accoding-to-the-braden-kronheim-scaling">
     Scale the data accoding to the “Braden Kronheim scaling” :
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#ml">
   ML
  </a>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#train-mass">
   Train Mass
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#batches-validation-losses-and-plotting-of-losses-functions">
     Batches, validation, losses, and plotting of losses functions
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#get-training-and-testing-features-and-targets">
     Get training and testing features and targets
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#training-and-running-of-training-functions">
     Training and running-of-training functions
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#define-basic-nn-model">
     Define basic NN model
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#run-training">
     Run training
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#evalute-model-and-save-evaluated-data">
     Evalute model and save evaluated data
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#plot-predicted-vs-real-reco-in-our-paper-s-format">
   Plot predicted vs real reco (in our paper’s format)
  </a>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#train-p-t-using-saved-variables-above">
   Train
   <span class="math notranslate nohighlight">
    \(p_T\)
   </span>
   using saved variables above
  </a>
 </li>
</ul>

    </nav>
</div>
    </div>
    <div class="article row">
        <div class="col pl-md-3 pl-lg-5 content-container">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>Braden-Scaling IQNx4: 1.Mass (UNDER CONSTRUCTION!)</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#">
   Braden-Scaling IQNx4: 1.Mass (UNDER CONSTRUCTION!)
  </a>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#do-source-setup-sh-before-trying-to-run-this-notebook">
   Do
   <code class="docutils literal notranslate">
    <span class="pre">
     source
    </span>
    <span class="pre">
     setup.sh
    </span>
   </code>
   before trying to run this notebook!
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#external-imports">
     External Imports
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#import-utils-and-set-environemnt-variables">
     Import utils, and set environemnt variables
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#a-user-is-competent-enought-to-do-source-setup-sh-on-a-setup-sh-script-that-comes-in-the-repo-such-as-the-next-cell-uncommented">
       A user is competent enought to do
       <code class="docutils literal notranslate">
        <span class="pre">
         source
        </span>
        <span class="pre">
         setup.sh
        </span>
       </code>
       on a
       <code class="docutils literal notranslate">
        <span class="pre">
         setup.sh
        </span>
       </code>
       script that comes in the repo, such as the next cell uncommented
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#set-arguments-and-configurations">
     Set arguments and configurations
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#import-the-numpy-data-convert-to-dataframe-and-save-if-you-haven-t-saved-the-dataframes">
       Import the numpy data, convert to dataframe and save (if you haven’t saved the dataframes)
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#explore-the-dataframe-and-preprocess">
   Explore the Dataframe and preprocess
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#results-prior-to-braden-scaling">
     Results prior to Braden-scaling
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#scale-the-data-accoding-to-the-braden-kronheim-scaling">
     Scale the data accoding to the “Braden Kronheim scaling” :
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#ml">
   ML
  </a>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#train-mass">
   Train Mass
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#batches-validation-losses-and-plotting-of-losses-functions">
     Batches, validation, losses, and plotting of losses functions
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#get-training-and-testing-features-and-targets">
     Get training and testing features and targets
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#training-and-running-of-training-functions">
     Training and running-of-training functions
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#define-basic-nn-model">
     Define basic NN model
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#run-training">
     Run training
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#evalute-model-and-save-evaluated-data">
     Evalute model and save evaluated data
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#plot-predicted-vs-real-reco-in-our-paper-s-format">
   Plot predicted vs real reco (in our paper’s format)
  </a>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#train-p-t-using-saved-variables-above">
   Train
   <span class="math notranslate nohighlight">
    \(p_T\)
   </span>
   using saved variables above
  </a>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            <main id="main-content" role="main">
                
              <div>
                
  <section class="tex2jax_ignore mathjax_ignore" id="braden-scaling-iqnx4-1-mass-under-construction">
<h1>Braden-Scaling IQNx4: 1.Mass (UNDER CONSTRUCTION!)<a class="headerlink" href="#braden-scaling-iqnx4-1-mass-under-construction" title="Permalink to this headline">#</a></h1>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="do-source-setup-sh-before-trying-to-run-this-notebook">
<h1>Do <code class="docutils literal notranslate"><span class="pre">source</span> <span class="pre">setup.sh</span></code> before trying to run this notebook!<a class="headerlink" href="#do-source-setup-sh-before-trying-to-run-this-notebook" title="Permalink to this headline">#</a></h1>
<section id="external-imports">
<h2>External Imports<a class="headerlink" href="#external-imports" title="Permalink to this headline">#</a></h2>
<p>If you don’t have some of these packages installed, you can also use the conda environment that has all of the packages by doing <code class="docutils literal notranslate"><span class="pre">conda</span> <span class="pre">env</span> <span class="pre">create</span> <span class="pre">-f</span> <span class="pre">IQN_env.yml</span> <span class="pre">&amp;&amp;</span> <span class="pre">conda</span> <span class="pre">activate</span> <span class="pre">IQN_env</span></code></p>
<p>There is also a <code class="docutils literal notranslate"><span class="pre">requirements.txt</span></code> here so that it can be run on an interactive website, eg binder or people can <code class="docutils literal notranslate"><span class="pre">pip</span> <span class="pre">install</span></code> it.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span><span class="p">;</span> <span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">scipy</span> <span class="k">as</span> <span class="nn">sp</span><span class="p">;</span> <span class="kn">import</span> <span class="nn">scipy.stats</span> <span class="k">as</span> <span class="nn">st</span>
<span class="kn">import</span> <span class="nn">torch</span><span class="p">;</span> <span class="kn">import</span> <span class="nn">torch.nn</span> <span class="k">as</span> <span class="nn">nn</span><span class="p">;</span> <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;using torch version </span><span class="si">{</span><span class="n">torch</span><span class="o">.</span><span class="n">__version__</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="c1">#use numba&#39;s just-in-time compiler to speed things up</span>
<span class="kn">from</span> <span class="nn">numba</span> <span class="kn">import</span> <span class="n">njit</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">StandardScaler</span><span class="p">;</span> <span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>
<span class="kn">import</span> <span class="nn">matplotlib</span> <span class="k">as</span> <span class="nn">mp</span><span class="p">;</span> <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span><span class="p">;</span> 
<span class="c1">#reset matplotlib stle/parameters</span>
<span class="kn">import</span> <span class="nn">matplotlib</span> <span class="k">as</span> <span class="nn">mpl</span>
<span class="c1">#reset matplotlib parameters to their defaults</span>
<span class="n">mpl</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">mpl</span><span class="o">.</span><span class="n">rcParamsDefault</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;seaborn-deep&#39;</span><span class="p">)</span>
<span class="n">mp</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;agg.path.chunksize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">10000</span>
<span class="n">font_legend</span> <span class="o">=</span> <span class="mi">15</span><span class="p">;</span> <span class="n">font_axes</span><span class="o">=</span><span class="mi">15</span>
<span class="c1"># %matplotlib inline</span>
<span class="kn">import</span> <span class="nn">copy</span><span class="p">;</span> <span class="kn">import</span> <span class="nn">sys</span><span class="p">;</span> <span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">Image</span><span class="p">,</span> <span class="n">display</span>
<span class="kn">from</span> <span class="nn">importlib</span> <span class="kn">import</span> <span class="n">import_module</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">optuna</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;using (optional) optuna version </span><span class="si">{</span><span class="n">optuna</span><span class="o">.</span><span class="n">__version__</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;optuna is only used for hyperparameter tuning, not critical!&#39;</span><span class="p">)</span>
    <span class="k">pass</span>
<span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="c1"># import sympy as sy</span>
<span class="kn">import</span> <span class="nn">ipywidgets</span> <span class="k">as</span> <span class="nn">wid</span><span class="p">;</span> 
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>using torch version 1.9.0
using (optional) optuna version 2.8.0
</pre></div>
</div>
</div>
</div>
</section>
<section id="import-utils-and-set-environemnt-variables">
<h2>Import utils, and set environemnt variables<a class="headerlink" href="#import-utils-and-set-environemnt-variables" title="Permalink to this headline">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">try</span><span class="p">:</span>
    <span class="n">IQN_BASE</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;IQN_BASE&#39;</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;BASE directoy properly set = &#39;</span><span class="p">,</span> <span class="n">IQN_BASE</span><span class="p">)</span>
    <span class="n">utils_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">IQN_BASE</span><span class="p">,</span> <span class="s1">&#39;utils&#39;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">utils_dir</span><span class="p">)</span>
    <span class="kn">import</span> <span class="nn">utils</span>
    <span class="c1">#usually its not recommended to import everything from a module, but we know</span>
    <span class="c1">#whats in it so its fine</span>
    <span class="kn">from</span> <span class="nn">utils</span> <span class="kn">import</span> <span class="o">*</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;DATA directory also properly set, in </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;DATA_DIR&#39;</span><span class="p">])</span>
<span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span><span class="se">\n</span><span class="s2">BASE directory not properly set. Read repo README.</span><span class="se">\</span>
<span class="s2">    If you need a function from utils, use the decorator below, or add utils to sys.path</span><span class="se">\n</span><span class="s2"></span>
<span class="s2">    You can also do os.environ[&#39;IQN_BASE&#39;]=&lt;ABSOLUTE PATH FOR THE IQN REPO&gt;&quot;&quot;&quot;</span><span class="p">)</span>
    <span class="k">pass</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>BASE directoy properly set =  /home/ali/Desktop/Pulled_Github_Repositories/torchQN
DATA directory also properly set, in /home/ali/Desktop/Pulled_Github_Repositories/IQN_HEP/Davidson/data
</pre></div>
</div>
</div>
</div>
<section id="a-user-is-competent-enought-to-do-source-setup-sh-on-a-setup-sh-script-that-comes-in-the-repo-such-as-the-next-cell-uncommented">
<h3>A user is competent enought to do <code class="docutils literal notranslate"><span class="pre">source</span> <span class="pre">setup.sh</span></code> on a <code class="docutils literal notranslate"><span class="pre">setup.sh</span></code> script that comes in the repo, such as the next cell uncommented<a class="headerlink" href="#a-user-is-competent-enought-to-do-source-setup-sh-on-a-setup-sh-script-that-comes-in-the-repo-such-as-the-next-cell-uncommented" title="Permalink to this headline">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># %%writefile setup.sh</span>
<span class="c1"># #!/bin/bash</span>
<span class="c1"># export IQN_BASE=/home/ali/Desktop/Pulled_Github_Repositories/torchQN</span>
<span class="c1"># #DAVIDSON</span>
<span class="c1"># #export DATA_DIR=&#39;/home/DAVIDSON/alalkadhim.visitor/IQN/DAVIDSON_NEW/data&#39;</span>
<span class="c1"># #LOCAL</span>
<span class="c1"># export DATA_DIR=&#39;/home/ali/Desktop/Pulled_Github_Repositories/IQN_HEP/Davidson/data&#39;</span>
<span class="c1"># echo &#39;DATA DIR&#39;</span>
<span class="c1"># ls -l $DATA_DIR</span>
<span class="c1"># #ln -s $DATA_DIR $IQN_BASE, if you want</span>
<span class="c1"># #conda create env -n torch_env -f torch_env.yml</span>
<span class="c1"># #conda activate torch_env</span>
<span class="c1"># mkdir -p ${IQN_BASE}/images/loss_plots ${IQN_BASE}/trained_models  ${IQN_BASE}/hyperparameters ${IQN_BASE}/predicted_data</span>
<span class="c1"># tree $IQN_BASE</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># update fonts</span>
<span class="n">FONTSIZE</span> <span class="o">=</span> <span class="mi">14</span>
<span class="n">font</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;family&#39;</span> <span class="p">:</span> <span class="s1">&#39;serif&#39;</span><span class="p">,</span>
        <span class="s1">&#39;weight&#39;</span> <span class="p">:</span> <span class="s1">&#39;normal&#39;</span><span class="p">,</span>
        <span class="s1">&#39;size&#39;</span>   <span class="p">:</span> <span class="n">FONTSIZE</span><span class="p">}</span>
<span class="n">mp</span><span class="o">.</span><span class="n">rc</span><span class="p">(</span><span class="s1">&#39;font&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">font</span><span class="p">)</span>

<span class="c1"># set usetex = False if LaTex is not </span>
<span class="c1"># available on your system or if the </span>
<span class="c1"># rendering is too slow</span>
<span class="n">mp</span><span class="o">.</span><span class="n">rc</span><span class="p">(</span><span class="s1">&#39;text&#39;</span><span class="p">,</span> <span class="n">usetex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># set a seed to ensure reproducibility</span>
<span class="n">seed</span> <span class="o">=</span> <span class="mi">128</span>
<span class="n">rnd</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">RandomState</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
<span class="c1">#sometimes jupyter doesnt initialize MathJax automatically for latex, so do this:</span>
<span class="n">wid</span><span class="o">.</span><span class="n">HTMLMath</span><span class="p">(</span><span class="s1">&#39;$\LaTeX$&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id": "b7acbb1c684641159e817ccbb6311ae3", "version_major": 2, "version_minor": 0}
</script></div>
</div>
</section>
</section>
<section id="set-arguments-and-configurations">
<h2>Set arguments and configurations<a class="headerlink" href="#set-arguments-and-configurations" title="Permalink to this headline">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">################################### ARGUMENTS ###################################</span>
<span class="n">parser</span><span class="o">=</span><span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s1">&#39;train for different targets&#39;</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--N&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;&#39;&#39;size of the dataset you want to use. </span>
<span class="s1">                    Options are 10M and 100K and 10M_2, the default is 10M_2&#39;&#39;&#39;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">default</span><span class="o">=</span><span class="s1">&#39;10M_2&#39;</span><span class="p">)</span>
<span class="c1">#N_epochs X N_train_examples = N_iterations X batch_size</span>
<span class="c1"># N_iterations = (N_epochs * train_data.shape[0])/batch_size</span>
<span class="c1">#N_iterations = (N_epochs * train_data.shape[0])/64 = 125000 for 1 epoch</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--n_iterations&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;&#39;&#39;The number of iterations for training, </span>
<span class="s1">                    the default is&#39;&#39;&#39;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">default</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
<span class="c1">#default=5000000 )</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--n_layers&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;&#39;&#39;The number of layers in your NN, </span>
<span class="s1">                    the default is 5&#39;&#39;&#39;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">default</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--n_hidden&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;&#39;&#39;The number of hidden layers in your NN, </span>
<span class="s1">                    the default is 5&#39;&#39;&#39;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">default</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--starting_learning_rate&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;&#39;&#39;Starting learning rate, </span>
<span class="s1">                    the defulat is 10^-3&#39;&#39;&#39;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">default</span><span class="o">=</span><span class="mf">1.e-2</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--show_loss_plots&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">bool</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;&#39;&#39;Boolean to show the loss plots, </span>
<span class="s1">                    default is False&#39;&#39;&#39;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--save_model&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">bool</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;&#39;&#39;Boolean to save the trained model dictionary&#39;&#39;&#39;</span><span class="p">,</span> 
                    <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--save_loss_plots&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">bool</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;&#39;&#39;Boolean to save the loss plots&#39;&#39;&#39;</span><span class="p">,</span> 
                    <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>


<span class="c1">################################### CONFIGURATIONS ###################################</span>
<span class="n">DATA_DIR</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;DATA_DIR&#39;</span><span class="p">]</span>
<span class="n">JUPYTER</span><span class="o">=</span><span class="kc">True</span>

<span class="k">if</span> <span class="n">JUPYTER</span><span class="p">:</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="p">[])</span>
    <span class="n">N</span> <span class="o">=</span> <span class="s1">&#39;10M_2&#39;</span>
    <span class="n">n_iterations</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mf">1e4</span><span class="p">)</span>
    <span class="n">n_layers</span><span class="p">,</span> <span class="n">n_hidden</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
    <span class="n">starting_learning_rate</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="mf">1.e-2</span><span class="p">)</span>
    <span class="n">show_loss_plots</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">save_model</span><span class="o">=</span><span class="kc">False</span>
    <span class="n">save_loss_plots</span> <span class="o">=</span> <span class="kc">False</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
    <span class="n">N</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">N</span>
    <span class="n">n_iterations</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">n_iterations</span>
    <span class="n">n_layers</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">n_layers</span>
    <span class="n">n_hidden</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">n_hidden</span>
    <span class="n">starting_learning_rate</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">starting_learning_rate</span>
    <span class="n">show_loss_plots</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">show_loss_plots</span>
    <span class="n">save_model</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">save_model</span>
    <span class="n">save_loss_plots</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">save_loss_plots</span>

<span class="n">dropout</span><span class="o">=</span><span class="mf">0.2</span>

<span class="k">def</span> <span class="nf">get_model_params</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">n_iterations</span><span class="p">,</span> <span class="n">n_layers</span><span class="p">,</span> <span class="n">n_hidden</span><span class="p">,</span> <span class="n">starting_learning_rate</span><span class="p">,</span> <span class="n">dropout</span>
</pre></div>
</div>
</div>
</div>
<section id="import-the-numpy-data-convert-to-dataframe-and-save-if-you-haven-t-saved-the-dataframes">
<h3>Import the numpy data, convert to dataframe and save (if you haven’t saved the dataframes)<a class="headerlink" href="#import-the-numpy-data-convert-to-dataframe-and-save-if-you-haven-t-saved-the-dataframes" title="Permalink to this headline">#</a></h3>
</section>
</section>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="explore-the-dataframe-and-preprocess">
<h1>Explore the Dataframe and preprocess<a class="headerlink" href="#explore-the-dataframe-and-preprocess" title="Permalink to this headline">#</a></h1>
<p>another flowchart for how IQN works autoregressively to get <span class="math notranslate nohighlight">\(p_T'\)</span>, etc</p>
<p>Plotting</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">show_jupyter_image</span><span class="p">(</span><span class="n">image_filename</span><span class="p">,</span> <span class="n">width</span> <span class="o">=</span> <span class="mi">1300</span><span class="p">,</span> <span class="n">height</span> <span class="o">=</span> <span class="mi">300</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Show a saved image directly in jupyter. Make sure image_filename is in your IQN_BASE !&quot;&quot;&quot;</span>
    <span class="n">display</span><span class="p">(</span><span class="n">Image</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">IQN_BASE</span><span class="p">,</span><span class="n">image_filename</span><span class="p">),</span> <span class="n">width</span> <span class="o">=</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span> <span class="o">=</span> <span class="n">height</span>  <span class="p">))</span>
    
    
<span class="k">def</span> <span class="nf">use_svg_display</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Use the svg format to display a plot in Jupyter (better quality)&quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">matplotlib_inline</span> <span class="kn">import</span> <span class="n">backend_inline</span>
    <span class="n">backend_inline</span><span class="o">.</span><span class="n">set_matplotlib_formats</span><span class="p">(</span><span class="s1">&#39;svg&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">reset_plt_params</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;reset matplotlib parameters - often useful&quot;&quot;&quot;</span>
    <span class="n">use_svg_display</span><span class="p">()</span>
    <span class="n">mpl</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">mpl</span><span class="o">.</span><span class="n">rcParamsDefault</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">show_plot</span><span class="p">(</span><span class="n">legend</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">use_svg_display</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">();</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">legend</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;best&#39;</span><span class="p">)</span>
        
<span class="k">def</span> <span class="nf">set_figsize</span><span class="p">(</span><span class="n">get_axes</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">7</span><span class="p">)):</span>
    <span class="n">use_svg_display</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;figure.figsize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">figsize</span>
    <span class="k">if</span> <span class="n">get_axes</span><span class="p">:</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span>
    
<span class="k">def</span> <span class="nf">set_axes</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">xlabel</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">xmin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">xmax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ymin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ymax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;saves a lot of time in explicitly difining each axis, its title and labels: do them all in one go&quot;&quot;&quot;</span>
    <span class="n">use_svg_display</span><span class="p">()</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">xlabel</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="n">font_axes</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ylabel</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">ylabel</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="n">font_axes</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">xmin</span> <span class="ow">and</span> <span class="n">xmax</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_title</span><span class="p">()</span>  <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="c1">#if the axes (plot) does have a title (which is non-empty string), display it </span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">():</span>
        <span class="c1">#if an axis has a legned label, display it</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;best&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="n">font_legend</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ymin</span> <span class="ow">and</span> <span class="n">ymax</span><span class="p">:</span>
        <span class="c1">#sometimes we dont have ylimits since we do a lot of histograms, but if an axis has ylimits, set them</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span><span class="p">)</span>
    
    <span class="k">try</span><span class="p">:</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">use_svg_display</span><span class="p">()</span>
<span class="n">show_jupyter_image</span><span class="p">(</span><span class="s1">&#39;images/pythia_ppt_diagram.png&#39;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">2000</span><span class="p">,</span><span class="n">height</span><span class="o">=</span><span class="mi">500</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/Braden_Scaling_TrainEval_Mass_16_0.png" src="_images/Braden_Scaling_TrainEval_Mass_16_0.png" />
</div>
</div>
<!-- For Davidson team, please read try to all the code/comments before asking me questions! --><div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">################################### SET DATA CONFIGURATIONS ###################################</span>
<span class="n">X</span>       <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;genDatapT&#39;</span><span class="p">,</span> <span class="s1">&#39;genDataeta&#39;</span><span class="p">,</span> <span class="s1">&#39;genDataphi&#39;</span><span class="p">,</span> <span class="s1">&#39;genDatam&#39;</span><span class="p">,</span> <span class="s1">&#39;tau&#39;</span><span class="p">]</span>

<span class="n">FIELDS</span>  <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;RecoDatam&#39;</span> <span class="p">:</span> <span class="p">{</span><span class="s1">&#39;inputs&#39;</span><span class="p">:</span> <span class="n">X</span><span class="p">,</span> 
                           <span class="s1">&#39;xlabel&#39;</span><span class="p">:</span>  <span class="sa">r</span><span class="s1">&#39;$m$ (GeV)&#39;</span><span class="p">,</span> 
                           <span class="s1">&#39;xmin&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> 
                           <span class="s1">&#39;xmax&#39;</span><span class="p">:</span> <span class="mi">25</span><span class="p">},</span>
           
           <span class="s1">&#39;RecoDatapT&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;inputs&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;RecoDatam&#39;</span><span class="p">]</span><span class="o">+</span><span class="n">X</span><span class="p">,</span> 
                           <span class="s1">&#39;xlabel&#39;</span><span class="p">:</span>  <span class="sa">r</span><span class="s1">&#39;$p_T$ (GeV)&#39;</span> <span class="p">,</span> 
                           <span class="s1">&#39;xmin&#39;</span>  <span class="p">:</span> <span class="mi">20</span><span class="p">,</span> 
                           <span class="s1">&#39;xmax&#39;</span>  <span class="p">:</span>  <span class="mi">80</span><span class="p">},</span>
           
           <span class="s1">&#39;RecoDataeta&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;inputs&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;RecoDatam&#39;</span><span class="p">,</span><span class="s1">&#39;RecoDatapT&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">X</span><span class="p">,</span> 
                           <span class="s1">&#39;xlabel&#39;</span><span class="p">:</span> <span class="sa">r</span><span class="s1">&#39;$\eta$&#39;</span><span class="p">,</span>
                           <span class="s1">&#39;xmin&#39;</span>  <span class="p">:</span> <span class="o">-</span><span class="mi">5</span><span class="p">,</span>
                           <span class="s1">&#39;xmax&#39;</span>  <span class="p">:</span>  <span class="mi">5</span><span class="p">},</span>
           
           <span class="s1">&#39;RecoDataphi&#39;</span>  <span class="p">:</span> <span class="p">{</span><span class="s1">&#39;inputs&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;RecoDatam&#39;</span><span class="p">,</span> <span class="s1">&#39;RecodatapT&#39;</span><span class="p">,</span> <span class="s1">&#39;RecoDataeta&#39;</span><span class="p">]</span><span class="o">+</span><span class="n">X</span><span class="p">,</span>
                           <span class="s1">&#39;xlabel&#39;</span><span class="p">:</span> <span class="sa">r</span><span class="s1">&#39;$\phi$&#39;</span> <span class="p">,</span>
                           <span class="s1">&#39;xmin&#39;</span>  <span class="p">:</span> <span class="o">-</span><span class="mf">3.2</span><span class="p">,</span> 
                           <span class="s1">&#39;xmax&#39;</span>  <span class="p">:</span><span class="mf">3.2</span><span class="p">}</span>
          <span class="p">}</span>

<span class="c1">###############################################################################################</span>
<span class="n">y_label_dict</span> <span class="o">=</span><span class="p">{</span><span class="s1">&#39;RecoDatapT&#39;</span><span class="p">:</span><span class="s1">&#39;$p(p_T)$&#39;</span><span class="o">+</span><span class="s1">&#39; [ GeV&#39;</span><span class="o">+</span><span class="s1">&#39;$^{-1} $&#39;</span><span class="o">+</span><span class="s1">&#39;]&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;RecoDataeta&#39;</span><span class="p">:</span><span class="s1">&#39;$p(\eta)$&#39;</span><span class="p">,</span> <span class="s1">&#39;RecoDataphi&#39;</span><span class="p">:</span><span class="s1">&#39;$p(\phi)$&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;RecoDatam&#39;</span><span class="p">:</span><span class="s1">&#39;$p(m)$&#39;</span><span class="o">+</span><span class="s1">&#39; [ GeV&#39;</span><span class="o">+</span><span class="s1">&#39;$^{-1} $&#39;</span><span class="o">+</span><span class="s1">&#39;]&#39;</span><span class="p">}</span>

<span class="n">loss_y_label_dict</span> <span class="o">=</span><span class="p">{</span><span class="s1">&#39;RecoDatapT&#39;</span><span class="p">:</span><span class="s1">&#39;$p_T^</span><span class="si">{reco}</span><span class="s1">$&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;RecoDataeta&#39;</span><span class="p">:</span><span class="s1">&#39;$\eta^</span><span class="si">{reco}</span><span class="s1">$&#39;</span><span class="p">,</span> <span class="s1">&#39;RecoDataphi&#39;</span><span class="p">:</span><span class="s1">&#39;$\phi^</span><span class="si">{reco}</span><span class="s1">$&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;RecoDatam&#39;</span><span class="p">:</span><span class="s1">&#39;$m^</span><span class="si">{reco}</span><span class="s1">$&#39;</span><span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">all_variable_cols</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;genDatapT&#39;</span><span class="p">,</span> <span class="s1">&#39;genDataeta&#39;</span><span class="p">,</span> <span class="s1">&#39;genDataphi&#39;</span><span class="p">,</span> <span class="s1">&#39;genDatam&#39;</span><span class="p">,</span><span class="s1">&#39;RecoDatapT&#39;</span><span class="p">,</span> <span class="s1">&#39;RecoDataeta&#39;</span><span class="p">,</span> <span class="s1">&#39;RecoDataphi&#39;</span><span class="p">,</span> <span class="s1">&#39;RecoDatam&#39;</span><span class="p">]</span>
<span class="n">all_cols</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;genDatapT&#39;</span><span class="p">,</span> <span class="s1">&#39;genDataeta&#39;</span><span class="p">,</span> <span class="s1">&#39;genDataphi&#39;</span><span class="p">,</span> <span class="s1">&#39;genDatam&#39;</span><span class="p">,</span><span class="s1">&#39;RecoDatapT&#39;</span><span class="p">,</span> <span class="s1">&#39;RecoDataeta&#39;</span><span class="p">,</span> <span class="s1">&#39;RecoDataphi&#39;</span><span class="p">,</span> <span class="s1">&#39;RecoDatam&#39;</span><span class="p">,</span> <span class="s1">&#39;tau&#39;</span><span class="p">]</span>
<span class="c1">################################### Load unscaled dataframes ###################################</span>
<span class="n">SUBSAMPLE</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="mf">1e4</span><span class="p">)</span><span class="c1">#subsample use for development - in production use whole dataset</span>
<span class="n">train_data</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">DATA_DIR</span><span class="p">,</span><span class="s1">&#39;train_data_10M_2.csv&#39;</span><span class="p">),</span>
                      <span class="n">usecols</span><span class="o">=</span><span class="n">all_cols</span><span class="p">,</span>
                      <span class="n">nrows</span><span class="o">=</span><span class="n">SUBSAMPLE</span>
                      <span class="p">)</span>

<span class="n">test_data</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">DATA_DIR</span><span class="p">,</span><span class="s1">&#39;test_data_10M_2.csv&#39;</span><span class="p">),</span>
                      <span class="n">usecols</span><span class="o">=</span><span class="n">all_cols</span><span class="p">,</span>
                     <span class="n">nrows</span><span class="o">=</span><span class="n">SUBSAMPLE</span>
                     <span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">explore_data</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">scaled</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span> <span class="p">)</span>
    <span class="c1"># df = df[[&#39;genDatapT&#39;, &#39;genDataeta&#39;, &#39;genDataphi&#39;, &#39;genDatam&#39;,&#39;RecoDatapT&#39;, &#39;RecoDataeta&#39;, &#39;RecoDataphi&#39;, &#39;RecoDatam&#39;]]</span>
    <span class="n">levels</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;RecoData&#39;</span><span class="p">,</span> <span class="s1">&#39;genData&#39;</span><span class="p">]</span>
    <span class="n">kinematics</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;pT&#39;</span><span class="p">,</span><span class="s1">&#39;eta&#39;</span><span class="p">,</span><span class="s1">&#39;phi&#39;</span><span class="p">,</span><span class="s1">&#39;m&#39;</span><span class="p">]</span>
    <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">level</span><span class="o">+</span><span class="n">k</span> <span class="k">for</span> <span class="n">level</span> <span class="ow">in</span> <span class="n">levels</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">kinematics</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">columns</span><span class="p">)</span>
    <span class="n">columns</span> <span class="o">=</span> <span class="n">columns</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;tau&#39;</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">columns</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">columns</span><span class="p">]</span>
    
    <span class="k">for</span> <span class="n">k_i</span><span class="p">,</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">kinematics</span><span class="p">):</span>
        <span class="n">Reco_var</span> <span class="o">=</span> <span class="n">levels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">k</span>
        <span class="n">gen_var</span> <span class="o">=</span> <span class="n">levels</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">k</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Reco_var: &#39;</span><span class="p">,</span> <span class="n">Reco_var</span><span class="p">,</span> <span class="s1">&#39;, </span><span class="se">\t</span><span class="s1"> gen_var: &#39;</span><span class="p">,</span> <span class="n">gen_var</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="n">k_i</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">Reco_var</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">Reco_var</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.35</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="n">k_i</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">gen_var</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">gen_var</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.35</span><span class="p">)</span>
        <span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span> <span class="o">=</span> <span class="n">FIELDS</span><span class="p">[</span><span class="n">Reco_var</span><span class="p">][</span><span class="s1">&#39;xmin&#39;</span><span class="p">],</span> <span class="n">FIELDS</span><span class="p">[</span><span class="n">Reco_var</span><span class="p">][</span><span class="s1">&#39;xmax&#39;</span><span class="p">]</span>
        <span class="n">xlabel</span><span class="o">=</span><span class="n">FIELDS</span><span class="p">[</span><span class="n">Reco_var</span><span class="p">][</span><span class="s1">&#39;xlabel&#39;</span><span class="p">]</span>
        <span class="n">ax</span><span class="p">[</span><span class="n">k_i</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span> <span class="p">(</span><span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">)</span> <span class="p">)</span>
        <span class="c1"># set_axes(ax[k_i], xlabel=xlabel, ylabel=&#39;&#39;, xmin=xmin, xmax=xmax)</span>
        <span class="n">ax</span><span class="p">[</span><span class="n">k_i</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">xlabel</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">26</span><span class="p">)</span>
        
        
                  
        <span class="k">if</span> <span class="n">scaled</span><span class="p">:</span>
            <span class="n">ax</span><span class="p">[</span><span class="n">k_i</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">gen_var</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span><span class="n">df</span><span class="p">[</span><span class="n">gen_var</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="p">)</span>
        
        <span class="n">ax</span><span class="p">[</span><span class="n">k_i</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;best&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">13</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;tau&#39;</span><span class="p">],</span><span class="n">bins</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;$\tau$&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;best&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">13</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
    <span class="n">show_plot</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">explore_data</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">train_data</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Unscaled Dataframe&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;RecoDatapT&#39;, &#39;RecoDataeta&#39;, &#39;RecoDataphi&#39;, &#39;RecoDatam&#39;, &#39;genDatapT&#39;, &#39;genDataeta&#39;, &#39;genDataphi&#39;, &#39;genDatam&#39;]
[&#39;RecoDatapT&#39;, &#39;RecoDataeta&#39;, &#39;RecoDataphi&#39;, &#39;RecoDatam&#39;, &#39;genDatapT&#39;, &#39;genDataeta&#39;, &#39;genDataphi&#39;, &#39;genDatam&#39;, &#39;tau&#39;]
Reco_var:  RecoDatapT , 	 gen_var:  genDatapT
Reco_var:  RecoDataeta , 	 gen_var:  genDataeta
Reco_var:  RecoDataphi , 	 gen_var:  genDataphi
Reco_var:  RecoDatam , 	 gen_var:  genDatam
</pre></div>
</div>
<img alt="_images/Braden_Scaling_TrainEval_Mass_21_1.svg" src="_images/Braden_Scaling_TrainEval_Mass_21_1.svg" /></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">train_data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">train_data</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span><span class="c1">#unscaled</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(10000, 9)
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>genDatapT</th>
      <th>genDataeta</th>
      <th>genDataphi</th>
      <th>genDatam</th>
      <th>RecoDatapT</th>
      <th>RecoDataeta</th>
      <th>RecoDataphi</th>
      <th>RecoDatam</th>
      <th>tau</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>count</th>
      <td>10000.000000</td>
      <td>10000.000000</td>
      <td>10000.000000</td>
      <td>10000.000000</td>
      <td>10000.000000</td>
      <td>10000.000000</td>
      <td>10000.000000</td>
      <td>10000.000000</td>
      <td>10000.000000</td>
    </tr>
    <tr>
      <th>mean</th>
      <td>32.748727</td>
      <td>-0.007169</td>
      <td>0.004215</td>
      <td>6.980037</td>
      <td>32.982230</td>
      <td>-0.007198</td>
      <td>0.004905</td>
      <td>5.531751</td>
      <td>0.501375</td>
    </tr>
    <tr>
      <th>std</th>
      <td>14.374873</td>
      <td>2.209883</td>
      <td>1.809176</td>
      <td>2.751696</td>
      <td>15.626337</td>
      <td>2.202264</td>
      <td>1.809657</td>
      <td>2.639882</td>
      <td>0.288104</td>
    </tr>
    <tr>
      <th>min</th>
      <td>20.004600</td>
      <td>-5.053690</td>
      <td>-3.140890</td>
      <td>0.136333</td>
      <td>11.532200</td>
      <td>-4.936930</td>
      <td>-3.351365</td>
      <td>-0.000022</td>
      <td>0.000014</td>
    </tr>
    <tr>
      <th>25%</th>
      <td>23.693450</td>
      <td>-1.636940</td>
      <td>-1.556042</td>
      <td>5.119607</td>
      <td>23.495425</td>
      <td>-1.637945</td>
      <td>-1.555673</td>
      <td>3.780315</td>
      <td>0.252924</td>
    </tr>
    <tr>
      <th>50%</th>
      <td>28.400000</td>
      <td>-0.012826</td>
      <td>-0.023519</td>
      <td>6.547370</td>
      <td>29.017050</td>
      <td>-0.018205</td>
      <td>-0.023471</td>
      <td>5.087130</td>
      <td>0.501390</td>
    </tr>
    <tr>
      <th>75%</th>
      <td>36.486850</td>
      <td>1.633903</td>
      <td>1.552912</td>
      <td>8.363860</td>
      <td>37.877825</td>
      <td>1.629590</td>
      <td>1.557280</td>
      <td>6.772220</td>
      <td>0.751112</td>
    </tr>
    <tr>
      <th>max</th>
      <td>183.448000</td>
      <td>5.039390</td>
      <td>3.140640</td>
      <td>35.081300</td>
      <td>185.426000</td>
      <td>4.998390</td>
      <td>3.381455</td>
      <td>33.813600</td>
      <td>0.999968</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>standarization is someimes done in the following way:
$<span class="math notranslate nohighlight">\( X' = \frac{X-X_{min}}{X_{max}-X_{min}} \qquad \rightarrow \qquad X= X' (X_{max}-X_{min}) + X_{min}\)</span>$</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># def standarize(values):</span>
<span class="c1">#     expected_min, expected_max = values.min(), values.max()</span>
<span class="c1">#     scale_factor = expected_max - expected_min</span>
<span class="c1">#     offset = expected_min</span>
<span class="c1">#     standarized_values = (values - offset)/scale_factor </span>
<span class="c1">#     return standarized_values</span>
</pre></div>
</div>
</div>
</div>
<p>Or by taking z-score:
$<span class="math notranslate nohighlight">\( X'=\frac{X-E[X]}{\sigma_{X}}  \qquad \rightarrow \qquad X = X' \sigma_{X} + E[X]\)</span>$</p>
<section id="results-prior-to-braden-scaling">
<h2>Results prior to Braden-scaling<a class="headerlink" href="#results-prior-to-braden-scaling" title="Permalink to this headline">#</a></h2>
<p>Recall that the best IQNx4 autoregressive results that I attained prior to trying the Braden scaling was the following (which was implemented in the Davidson cluster here: <code class="docutils literal notranslate"><span class="pre">/home/DAVIDSON/alalkadhim.visitor/IQN/DAVIDSON_NEW/OCT_7/*.py</span></code> and copied to my repo <a class="reference external" href="https://github.com/AliAlkadhim/torchQN/tree/master/OCT_7">here</a>):</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">show_jupyter_image</span><span class="p">(</span><span class="s1">&#39;OCT_7/AUTOREGRESSIVE_RESULTS_OCT7.png&#39;</span><span class="p">,</span><span class="n">width</span> <span class="o">=</span> <span class="mi">800</span><span class="p">,</span> <span class="n">height</span> <span class="o">=</span> <span class="mi">100</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/Braden_Scaling_TrainEval_Mass_27_0.png" src="_images/Braden_Scaling_TrainEval_Mass_27_0.png" />
</div>
</div>
</section>
<section id="scale-the-data-accoding-to-the-braden-kronheim-scaling">
<h2>Scale the data accoding to the “Braden Kronheim scaling” :<a class="headerlink" href="#scale-the-data-accoding-to-the-braden-kronheim-scaling" title="Permalink to this headline">#</a></h2>
<div class="math notranslate nohighlight">
\[\mathbb{T}(p_T) = z(\log p_T), \qquad \mathbb{T}(\eta) = z(\eta), \qquad \mathbb{T}(\phi) = z(\phi), \qquad \mathbb{T}(m) = z(\log (m + 2))\]</div>
<div class="math notranslate nohighlight">
\[ \mathbb{T}(\tau) = 6\tau - 3 \]</div>
<p>For a jet observable <span class="math notranslate nohighlight">\(\mathcal{O}\)</span> (or <span class="math notranslate nohighlight">\(\tau\)</span>), the data is first scaled according to:</p>
<div class="math notranslate nohighlight">
\[\begin{split}
\begin{align}
    \mathbb{L} (\mathcal{O}) &amp;=
    \begin{cases}
        \log{\mathcal{O}}, \qquad &amp; \text{if } \mathcal{O}= p_T \\
        \mathcal{O}, \qquad &amp; \text{if } \mathcal{O}=\eta \\
        \log (\mathcal{O} + 2), \qquad &amp; \text{if } \mathcal{O}=m \\
        \mathcal{O}, \qquad &amp; \text{if } \mathcal{O}=\phi \\
        6 \mathcal{O} -3, \qquad &amp; \text{if } \mathcal{O}=\tau
    \end{cases}
\end{align}
\end{split}\]</div>
<p>Then the predicted target for a desired reco observable <span class="math notranslate nohighlight">\(\mathcal{O}\)</span> is chosen to be the following function</p>
<div class="math notranslate nohighlight">
\[
    \mathbb{T}(O) = z \left( \frac{\mathbb{L} (\mathcal{O}^{\text{reco}}) +10 }{\mathbb{L}(\mathcal{O}^{\text{gen}}) +10} \right),
\]</div>
<p>where for a random variable <span class="math notranslate nohighlight">\(x\)</span>, <span class="math notranslate nohighlight">\(z\)</span> is the standardization function (z-score):</p>
<div class="math notranslate nohighlight">
\[
   x'= z (x) \equiv \frac{x-\bar{x}}{\sigma_{x}}.
\]</div>
<p>Such that its inverse is
$<span class="math notranslate nohighlight">\( z^{-1}(x') = x' \ \sigma_x + \bar{x} \)</span><span class="math notranslate nohighlight">\(
If we do this on the data, after training, the NN \)</span>f_{\text{IQN}}<span class="math notranslate nohighlight">\( will not estimate the observable, \)</span>\mathcal{O}^{\text{predicted}} \ne \mathcal{O}^{\text{reco}}$, but will instead estimate</p>
<div class="math notranslate nohighlight">
\[
        f_{\text{IQN}} (\mathcal{O}) =  z \left( \frac{\mathbb{L} (\mathcal{O}^{\text{reco}}) +10 }{\mathbb{L}(\mathcal{O}^{\text{gen}}) +10} \right),
\]</div>
<p>which needs to be de-scaled (when evaluated on the data that which has been scaled according to <span class="math notranslate nohighlight">\(\mathbb{T}(\text{evaluation data}) = z \left( \frac{\mathbb{L} (\text{data}^{\text{reco}}) +10 }{\mathbb{L}(\text{data}^{\text{gen}}) +10} \right) \)</span>
)
in order to copare with <span class="math notranslate nohighlight">\(\mathcal{O}\)</span> directly. The descaling for <span class="math notranslate nohighlight">\(\mathcal{O}=p_T\)</span> (as an example) would be:
$<span class="math notranslate nohighlight">\(
    p_T^{\text{predicted}} = \mathbb{L}^{-1} \left[ z^{-1} (f_{\text{IQN}} ) \left[ \mathbb{L} (p_T^\text{gen})+10 \right] -10 \right]
\)</span>$</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">z</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">x</span><span class="p">))</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">z_inverse</span><span class="p">(</span><span class="n">xprime</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">xprime</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">L</span><span class="p">(</span><span class="n">orig_observable</span><span class="p">,</span> <span class="n">label</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">label</span><span class="o">==</span><span class="s1">&#39;pT&#39;</span><span class="p">:</span>
        <span class="n">const</span><span class="o">=</span><span class="mi">0</span>
        <span class="n">log_pT_</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">orig_observable</span><span class="p">)</span> 
        <span class="n">L_observable</span> <span class="o">=</span> <span class="n">log_pT_</span>
    <span class="k">if</span> <span class="n">label</span><span class="o">==</span><span class="s1">&#39;eta&#39;</span><span class="p">:</span>
        <span class="n">const</span><span class="o">=</span><span class="mi">0</span>
        <span class="n">L_observable</span><span class="o">=</span><span class="n">orig_observable</span>
    <span class="k">if</span> <span class="n">label</span><span class="o">==</span><span class="s1">&#39;m&#39;</span><span class="p">:</span>
        <span class="n">const</span><span class="o">=</span><span class="mi">2</span>
        <span class="n">L_observable</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">orig_observable</span> <span class="o">+</span> <span class="n">const</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">label</span><span class="o">==</span><span class="s1">&#39;phi&#39;</span><span class="p">:</span>
        <span class="n">L_observable</span><span class="o">=</span><span class="n">orig_observable</span>
    <span class="k">if</span> <span class="n">label</span><span class="o">==</span><span class="s1">&#39;tau&#39;</span><span class="p">:</span>
        <span class="n">L_observable</span> <span class="o">=</span> <span class="p">(</span><span class="mi">6</span><span class="o">*</span><span class="n">orig_observable</span><span class="p">)</span> <span class="o">-</span> <span class="mi">3</span>
        
    <span class="k">return</span> <span class="n">L_observable</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">L_inverse</span><span class="p">(</span><span class="n">L_observable</span><span class="p">,</span> <span class="n">label</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">label</span><span class="o">==</span><span class="s1">&#39;pT&#39;</span><span class="p">:</span>
        <span class="n">const</span><span class="o">=</span><span class="mi">0</span>
        <span class="n">L_inverse_observable</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">L_observable</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">label</span><span class="o">==</span><span class="s1">&#39;eta&#39;</span><span class="p">:</span>
        <span class="n">L_inverse_observable</span> <span class="o">=</span> <span class="n">L_observable</span>
    <span class="k">if</span> <span class="n">label</span><span class="o">==</span><span class="s1">&#39;m&#39;</span><span class="p">:</span>
        <span class="n">const</span><span class="o">=</span><span class="mi">2</span>
        <span class="n">L_inverse_observable</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">L_observable</span><span class="p">)</span> <span class="o">-</span> <span class="n">const</span>
    <span class="k">if</span> <span class="n">label</span><span class="o">==</span><span class="s1">&#39;tau&#39;</span><span class="p">:</span>
        <span class="n">L_inverse_observable</span> <span class="o">=</span> <span class="p">(</span><span class="n">L_observable</span><span class="o">+</span><span class="mi">3</span><span class="p">)</span><span class="o">/</span><span class="mi">6</span>
        
    <span class="k">return</span> <span class="n">L_inverse_observable</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">T</span><span class="p">(</span><span class="n">variable</span><span class="p">,</span> <span class="n">scaled_df</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">variable</span><span class="o">==</span><span class="s1">&#39;pT&#39;</span><span class="p">:</span>
        <span class="n">L_pT_gen</span><span class="o">=</span><span class="n">scaled_df</span><span class="p">[</span><span class="s1">&#39;genDatapT&#39;</span><span class="p">]</span>
        <span class="n">L_pT_reco</span> <span class="o">=</span> <span class="n">scaled_df</span><span class="p">[</span><span class="s1">&#39;RecoDatapT&#39;</span><span class="p">]</span>
        <span class="n">target</span> <span class="o">=</span> <span class="n">z</span><span class="p">(</span> <span class="p">(</span><span class="n">L_pT_reco</span><span class="o">+</span><span class="mi">10</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">L_pT_gen</span><span class="o">+</span><span class="mi">10</span><span class="p">)</span> <span class="p">)</span>
    <span class="k">if</span> <span class="n">variable</span><span class="o">==</span><span class="s1">&#39;eta&#39;</span><span class="p">:</span>
        <span class="n">L_eta_gen</span><span class="o">=</span><span class="n">scaled_df</span><span class="p">[</span><span class="s1">&#39;genDataeta&#39;</span><span class="p">]</span>
        <span class="n">L_eta_reco</span> <span class="o">=</span> <span class="n">scaled_df</span><span class="p">[</span><span class="s1">&#39;RecoDataeta&#39;</span><span class="p">]</span>
        <span class="n">target</span> <span class="o">=</span> <span class="n">z</span><span class="p">(</span> <span class="p">(</span><span class="n">L_eta_reco</span><span class="o">+</span><span class="mi">10</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">L_eta_gen</span><span class="o">+</span><span class="mi">10</span><span class="p">)</span> <span class="p">)</span>
    <span class="k">if</span> <span class="n">variable</span><span class="o">==</span><span class="s1">&#39;phi&#39;</span><span class="p">:</span>
        <span class="n">L_phi_gen</span><span class="o">=</span><span class="n">scaled_df</span><span class="p">[</span><span class="s1">&#39;genDataphi&#39;</span><span class="p">]</span>
        <span class="n">L_phi_reco</span> <span class="o">=</span> <span class="n">scaled_df</span><span class="p">[</span><span class="s1">&#39;RecoDataphi&#39;</span><span class="p">]</span>
        <span class="n">target</span> <span class="o">=</span> <span class="n">z</span><span class="p">(</span> <span class="p">(</span><span class="n">L_phi_reco</span><span class="o">+</span><span class="mi">10</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">L_phi_gen</span><span class="o">+</span><span class="mi">10</span><span class="p">)</span> <span class="p">)</span>
    <span class="k">if</span> <span class="n">variable</span><span class="o">==</span><span class="s1">&#39;m&#39;</span><span class="p">:</span>
        <span class="n">L_m_gen</span><span class="o">=</span><span class="n">scaled_df</span><span class="p">[</span><span class="s1">&#39;genDatam&#39;</span><span class="p">]</span>
        <span class="n">L_m_reco</span> <span class="o">=</span> <span class="n">scaled_df</span><span class="p">[</span><span class="s1">&#39;RecoDatam&#39;</span><span class="p">]</span>
        <span class="n">target</span> <span class="o">=</span> <span class="n">z</span><span class="p">(</span> <span class="p">(</span><span class="n">L_m_reco</span><span class="o">+</span><span class="mi">10</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">L_m_gen</span><span class="o">+</span><span class="mi">10</span><span class="p">)</span> <span class="p">)</span>
    
    <span class="k">return</span> <span class="n">target</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">L_scale_df</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="c1">#scale</span>
    <span class="n">SUBSAMPLE</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="mf">1e4</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">all_cols</span><span class="p">]</span><span class="c1">#[:SUBSAMPLE]</span>
    <span class="c1"># print(df.head())</span>
    <span class="n">scaled_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
    <span class="c1">#select the columns by index: </span>
    <span class="c1"># 0:genDatapT, 1:genDataeta, 2:genDataphi, 3:genDatam, </span>
    <span class="c1"># 4:RecoDatapT, 5:RecoDataeta, 6:RecoDataphi, 7: Recodatam</span>
    <span class="n">scaled_df</span><span class="p">[</span><span class="s1">&#39;genDatapT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">L</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;pT&#39;</span><span class="p">)</span>
    <span class="n">scaled_df</span><span class="p">[</span><span class="s1">&#39;RecoDatapT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">L</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="mi">4</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;pT&#39;</span><span class="p">)</span>
    
    <span class="n">scaled_df</span><span class="p">[</span><span class="s1">&#39;genDataeta&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">L</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;eta&#39;</span><span class="p">)</span>
    <span class="n">scaled_df</span><span class="p">[</span><span class="s1">&#39;RecoDataeta&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">L</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="mi">5</span><span class="p">],</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;eta&#39;</span><span class="p">)</span>
    
    
    <span class="n">scaled_df</span><span class="p">[</span><span class="s1">&#39;genDataphi&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">L</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="mi">2</span><span class="p">],</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;phi&#39;</span><span class="p">)</span>
    <span class="n">scaled_df</span><span class="p">[</span><span class="s1">&#39;RecoDataphi&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">L</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="mi">6</span><span class="p">],</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;phi&#39;</span><span class="p">)</span>

    <span class="n">scaled_df</span><span class="p">[</span><span class="s1">&#39;genDatam&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">L</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="mi">3</span><span class="p">],</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;m&#39;</span><span class="p">)</span>
    <span class="n">scaled_df</span><span class="p">[</span><span class="s1">&#39;RecoDatam&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">L</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="mi">7</span><span class="p">],</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;m&#39;</span><span class="p">)</span>
    <span class="c1">#why scale tau?</span>
    <span class="c1"># scaled_df[&#39;tau&#39;] = 6 * df.iloc[:,8] - 3</span>
    <span class="n">scaled_df</span><span class="p">[</span><span class="s1">&#39;tau&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">L</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="mi">8</span><span class="p">],</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;tau&#39;</span><span class="p">)</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="n">scaled_df</span><span class="o">.</span><span class="n">describe</span><span class="p">())</span>
    
    <span class="k">if</span> <span class="n">save</span><span class="p">:</span>
        <span class="n">scaled_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">DATA_DIR</span><span class="p">,</span> <span class="n">title</span><span class="p">)</span> <span class="p">)</span>
    <span class="k">return</span> <span class="n">scaled_df</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">scaled_train_data</span> <span class="o">=</span> <span class="n">L_scale_df</span><span class="p">(</span><span class="n">train_data</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;scaled_train_data_10M_2.csv&#39;</span><span class="p">,</span>
                             <span class="n">save</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">scaled_test_data</span> <span class="o">=</span> <span class="n">L_scale_df</span><span class="p">(</span><span class="n">test_data</span><span class="p">,</span>  <span class="n">title</span><span class="o">=</span><span class="s1">&#39;scaled_test_data_10M_2.csv&#39;</span><span class="p">,</span>
                            <span class="n">save</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">explore_data</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">scaled_train_data</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Braden Kronheim-L-scaled Dataframe&#39;</span><span class="p">,</span> <span class="n">scaled</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>          genDatapT    RecoDatapT    genDataeta   RecoDataeta    genDataphi  \
count  10000.000000  10000.000000  10000.000000  10000.000000  10000.000000   
mean       3.423686      3.415715     -0.007169     -0.007198      0.004215   
std        0.335502      0.380772      2.209883      2.202264      1.809176   
min        2.995962      2.445143     -5.053690     -4.936930     -3.140890   
25%        3.165199      3.156806     -1.636940     -1.637945     -1.556042   
50%        3.346389      3.367884     -0.012826     -0.018205     -0.023519   
75%        3.596952      3.634366      1.633903      1.629590      1.552912   
max        5.211931      5.222656      5.039390      4.998390      3.140640   

        RecoDataphi      genDatam     RecoDatam           tau  
count  10000.000000  10000.000000  10000.000000  10000.000000  
mean       0.004905      2.153090      1.964980      0.008250  
std        1.809657      0.286049      0.326472      1.728625  
min       -3.351365      0.759091      0.693136     -2.999914  
25%       -1.555673      1.962853      1.754458     -1.482457  
50%       -0.023471      2.145624      1.958280      0.008340  
75%        1.557280      2.338325      2.171590      1.506673  
max        3.381455      3.613113      3.578328      2.999809  



          genDatapT    RecoDatapT    genDataeta   RecoDataeta    genDataphi  \
count  10000.000000  10000.000000  10000.000000  10000.000000  10000.000000   
mean       3.432007      3.420870      0.032961      0.032736      0.026741   
std        0.341107      0.390866      2.211242      2.206106      1.819197   
min        2.995847      2.443520     -5.129500     -4.988500     -3.141430   
25%        3.177347      3.163957     -1.623770     -1.617640     -1.543545   
50%        3.357637      3.378399      0.079263      0.083027      0.040577   
75%        3.605775      3.640936      1.659910      1.656760      1.620092   
max        6.026646      5.989788      5.044860      4.937680      3.140370   

        RecoDataphi      genDatam     RecoDatam           tau  
count  10000.000000  10000.000000  10000.000000  10000.000000  
mean       0.026698      2.153702      1.967499      0.045356  
std        1.818557      0.288388      0.329008      1.744457  
min       -3.269625      1.092228      0.693130     -2.999923  
25%       -1.539700      1.967410      1.756333     -1.444432  
50%        0.039632      2.150878      1.967679      0.066719  
75%        1.618740      2.335998      2.175048      1.572519  
max        3.285325      4.301086      4.285335      2.999933  
[&#39;RecoDatapT&#39;, &#39;RecoDataeta&#39;, &#39;RecoDataphi&#39;, &#39;RecoDatam&#39;, &#39;genDatapT&#39;, &#39;genDataeta&#39;, &#39;genDataphi&#39;, &#39;genDatam&#39;]
[&#39;RecoDatapT&#39;, &#39;RecoDataeta&#39;, &#39;RecoDataphi&#39;, &#39;RecoDatam&#39;, &#39;genDatapT&#39;, &#39;genDataeta&#39;, &#39;genDataphi&#39;, &#39;genDatam&#39;, &#39;tau&#39;]
Reco_var:  RecoDatapT , 	 gen_var:  genDatapT
Reco_var:  RecoDataeta , 	 gen_var:  genDataeta
Reco_var:  RecoDataphi , 	 gen_var:  genDataphi
Reco_var:  RecoDatam , 	 gen_var:  genDatam
</pre></div>
</div>
<img alt="_images/Braden_Scaling_TrainEval_Mass_35_1.svg" src="_images/Braden_Scaling_TrainEval_Mass_35_1.svg" /></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;pT&#39;</span><span class="p">,</span> <span class="s1">&#39;eta&#39;</span><span class="p">,</span><span class="s1">&#39;phi&#39;</span><span class="p">,</span><span class="s1">&#39;m&#39;</span><span class="p">]</span>
<span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">labels</span><span class="p">:</span>
    <span class="n">target</span> <span class="o">=</span> <span class="n">T</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">scaled_df</span><span class="o">=</span><span class="n">scaled_train_data</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;$T($&#39;</span> <span class="o">+</span><span class="n">label</span><span class="o">+</span> <span class="s1">&#39;$)$&#39;</span> <span class="p">)</span>
<span class="c1"># target_pT = T(&#39;pT&#39;, scaled_df=scaled_train_data)</span>
<span class="c1"># target_eta = T(&#39;eta&#39;, scaled_df=scaled_train_data)</span>
<span class="c1"># target_phi = T(&#39;phi&#39;, scaled_df=scaled_train_data)</span>
<span class="c1"># target_m = T(&#39;m&#39;, scaled_df=scaled_train_data)</span>
<span class="c1"># plt.hist(target_pT, label=&#39;$T(p_T)$&#39;)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">();</span><span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/Braden_Scaling_TrainEval_Mass_36_0.svg" src="_images/Braden_Scaling_TrainEval_Mass_36_0.svg" /></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">scaled_train_data</span> <span class="o">=</span> <span class="n">L_scale_df</span><span class="p">(</span><span class="n">train_data</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;scaled_train_data_10M_2.csv&#39;</span><span class="p">,</span>
                             <span class="n">save</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">scaled_test_data</span> <span class="o">=</span> <span class="n">L_scale_df</span><span class="p">(</span><span class="n">test_data</span><span class="p">,</span>  <span class="n">title</span><span class="o">=</span><span class="s1">&#39;scaled_test_data_10M_2.csv&#39;</span><span class="p">,</span>
                            <span class="n">save</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">explore_data</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">scaled_train_data</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Braden Kronheim-$L$-scaled Dataframe: standarize_IQN&#39;</span><span class="p">,</span> <span class="n">scaled</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>          genDatapT    RecoDatapT    genDataeta   RecoDataeta    genDataphi  \
count  10000.000000  10000.000000  10000.000000  10000.000000  10000.000000   
mean       3.423686      3.415715     -0.007169     -0.007198      0.004215   
std        0.335502      0.380772      2.209883      2.202264      1.809176   
min        2.995962      2.445143     -5.053690     -4.936930     -3.140890   
25%        3.165199      3.156806     -1.636940     -1.637945     -1.556042   
50%        3.346389      3.367884     -0.012826     -0.018205     -0.023519   
75%        3.596952      3.634366      1.633903      1.629590      1.552912   
max        5.211931      5.222656      5.039390      4.998390      3.140640   

        RecoDataphi      genDatam     RecoDatam           tau  
count  10000.000000  10000.000000  10000.000000  10000.000000  
mean       0.004905      2.153090      1.964980      0.008250  
std        1.809657      0.286049      0.326472      1.728625  
min       -3.351365      0.759091      0.693136     -2.999914  
25%       -1.555673      1.962853      1.754458     -1.482457  
50%       -0.023471      2.145624      1.958280      0.008340  
75%        1.557280      2.338325      2.171590      1.506673  
max        3.381455      3.613113      3.578328      2.999809  



          genDatapT    RecoDatapT    genDataeta   RecoDataeta    genDataphi  \
count  10000.000000  10000.000000  10000.000000  10000.000000  10000.000000   
mean       3.432007      3.420870      0.032961      0.032736      0.026741   
std        0.341107      0.390866      2.211242      2.206106      1.819197   
min        2.995847      2.443520     -5.129500     -4.988500     -3.141430   
25%        3.177347      3.163957     -1.623770     -1.617640     -1.543545   
50%        3.357637      3.378399      0.079263      0.083027      0.040577   
75%        3.605775      3.640936      1.659910      1.656760      1.620092   
max        6.026646      5.989788      5.044860      4.937680      3.140370   

        RecoDataphi      genDatam     RecoDatam           tau  
count  10000.000000  10000.000000  10000.000000  10000.000000  
mean       0.026698      2.153702      1.967499      0.045356  
std        1.818557      0.288388      0.329008      1.744457  
min       -3.269625      1.092228      0.693130     -2.999923  
25%       -1.539700      1.967410      1.756333     -1.444432  
50%        0.039632      2.150878      1.967679      0.066719  
75%        1.618740      2.335998      2.175048      1.572519  
max        3.285325      4.301086      4.285335      2.999933  
[&#39;RecoDatapT&#39;, &#39;RecoDataeta&#39;, &#39;RecoDataphi&#39;, &#39;RecoDatam&#39;, &#39;genDatapT&#39;, &#39;genDataeta&#39;, &#39;genDataphi&#39;, &#39;genDatam&#39;]
[&#39;RecoDatapT&#39;, &#39;RecoDataeta&#39;, &#39;RecoDataphi&#39;, &#39;RecoDatam&#39;, &#39;genDatapT&#39;, &#39;genDataeta&#39;, &#39;genDataphi&#39;, &#39;genDatam&#39;, &#39;tau&#39;]
Reco_var:  RecoDatapT , 	 gen_var:  genDatapT
Reco_var:  RecoDataeta , 	 gen_var:  genDataeta
Reco_var:  RecoDataphi , 	 gen_var:  genDataphi
Reco_var:  RecoDatam , 	 gen_var:  genDatam
</pre></div>
</div>
<img alt="_images/Braden_Scaling_TrainEval_Mass_37_1.svg" src="_images/Braden_Scaling_TrainEval_Mass_37_1.svg" /></div>
</div>
<hr class="docutils" />
</section>
</section>
<hr class="docutils" />
<section class="tex2jax_ignore mathjax_ignore" id="ml">
<h1>ML<a class="headerlink" href="#ml" title="Permalink to this headline">#</a></h1>
<p>Note that this ideas is very powerful and has the potential to replace the use of Delphes/GEANT for most people. According to the <a class="reference external" href="https://arxiv.org/pdf/2111.11415.pdf">previous paper</a> this method already works for a single IQN.</p>
<p>It’s important to remember “the master formula” of all of machine learning:</p>
<div class="math notranslate nohighlight">
\[\int \frac{\partial L}{\partial f} p(y|x) dy  = 0 \tag{1}\]</div>
<p>or, equivalently,</p>
<div class="math notranslate nohighlight">
\[ \frac{\delta R}{\delta f}=0,\]</div>
<p>where <span class="math notranslate nohighlight">\(L\)</span> is the loss function, <span class="math notranslate nohighlight">\(f\)</span> is the model (in this case IQN) (implicitly parameterized by potentially a  gazillion parameters), <span class="math notranslate nohighlight">\(y\)</span> is the target(s) that we want to estimate, <span class="math notranslate nohighlight">\(x\)</span> is the (set of) training features, <span class="math notranslate nohighlight">\(R\)</span> is the risk functional:</p>
<div class="math notranslate nohighlight">
\[ R[f] = \int \cdots \int \, p(t, \mathbf{x}) \, L(t, f(\mathbf{x}, \theta)) \, dt \, d\mathbf{x}\]</div>
<p>So, for IQNs,</p>
<div class="math notranslate nohighlight">
\[\begin{split} L_{\text{IQN}}(f, y)=\left\{\begin{array}{ll}
\tau(y-f(\boldsymbol{x}, \tau ; \boldsymbol{\theta})) &amp; y \geq f(\boldsymbol{x}, \tau ; \boldsymbol{\theta}) \\
(1-\tau)(f(\boldsymbol{x}, \tau ; \boldsymbol{\theta})-y) &amp; y&lt;f(\boldsymbol{x}, \tau ; \boldsymbol{\theta})
\end{array},\right.\end{split}\]</div>
<p>Means that what was done previously is that the risk functional, which is generally a functional of many models <span class="math notranslate nohighlight">\(f\)</span>, was a only a functional of a single model: <span class="math notranslate nohighlight">\(R[f_1,..., f_n] = f[f_1]\)</span>. Here we have 4 models</p>
<div class="math notranslate nohighlight">
\[R_{\text{IQN}x4} =R_{\text{IQN}}[f_m, f_{p_T}, f_\eta, f_\phi], \]</div>
<p>and since we’re choosing the evaluation order:</p>
<div class="math notranslate nohighlight">
\[\begin{split}
\begin{align}
    p(\mathbf{y} | \mathbf{x}) &amp; = 
    p(m'|\mathbf{x} )\nonumber\\
    &amp; \times p(p_T'|\mathbf{x}, m' )\nonumber\\
    &amp; \times p(\eta'| \mathbf{x}, m', p_T' )\nonumber\\
      &amp; \times p(\phi' |  \mathbf{x}, m', p_T', \eta' ) ,
\end{align}\end{split}\]</div>
<div class="math notranslate nohighlight">
\[\begin{split} \begin{align}
R_{\text{IQN}x4} &amp;= \int L_\text{IQN} \left( f_m (\mathbf{x_m},\tau), \mathbf{y_m} \right) p(\mathbf{x_m, y_m})  d \mathbf{x_m} d \mathbf{y_m} \\
&amp;\times \  ... \times \\ 
&amp;\times \int L_\text{IQN} \left( f_\phi (\mathbf{x_\phi},\tau), \mathbf{y_\phi} \right) p(\mathbf{x_\phi, y_\phi})  d \mathbf{x_\phi} d \mathbf{y_\phi}
\end{align},\end{split}\]</div>
<p>where, again, each model <span class="math notranslate nohighlight">\(f_i\)</span> is also dependent on a set of parameters <span class="math notranslate nohighlight">\(\theta_i\)</span> (dropped for simplicity)</p>
<p>Our risk functional is minimized for</p>
<div class="math notranslate nohighlight">
\[\frac{\delta R_{\text{IQN}x4} }{\delta f_m}=0\tag{5}\]</div>
<p>(which is basically what’s done in the training process to get <span class="math notranslate nohighlight">\(f_m^{*}\)</span> whose weights/parameters minimize the loss). Suppose we factorize the risk as</p>
<div class="math notranslate nohighlight">
\[ R_{\text{IQN}x4}  = R_{\text{IQN}}^m \ R_{\text{IQN}}^{p_T}  \ R_{\text{IQN}}^\eta \ R_{\text{IQN}}^\phi \tag{6},\]</div>
<p>then, by Eq (4),</p>
<div class="math notranslate nohighlight">
\[R_{\text{IQN}}^m \equiv \int L_\text{IQN} \left( f_m (\mathbf{x_m},\tau), \mathbf{y_m} \right) p(\mathbf{x_m, y_m,\tau})  d \mathbf{x_m} d \mathbf{y_m} d \mathbf{\tau},
\]</div>
<p>and by Eq (5)
$<span class="math notranslate nohighlight">\(\int d \mathbf{x_m} d \mathbf{y_m} d \mathbf{\tau} \ p(\mathbf{x_m, y_m,\tau})   \ \frac{ \delta L_\text{IQN} \left( f_m (\mathbf{x_m},\tau), \mathbf{y_m} \right) }{\delta f_m} = 0\)</span>$</p>
<p>and by Eq (2)</p>
<div class="math notranslate nohighlight">
\[
\int d \mathbf{x_m} d \mathbf{y_m} d \mathbf{\tau} \ p(\mathbf{x_m, y_m,\tau})   \ \frac{ \delta L_\text{IQN} \left( f_m (\mathbf{x_m},\tau), \mathbf{y_m} \right) }{\delta f_m} = 0 \tag{7}
\]</div>
<blockquote>
<div><blockquote>
<div><p>…
<br></p>
</div></blockquote>
</div></blockquote>
<p>Expand Eq (2) in Eq (7) and integrate wrt y to see that  <span class="math notranslate nohighlight">\(f(\mathbf{x},\mathbf{\tau})\)</span> is the quantile function for <span class="math notranslate nohighlight">\(p(\mathbf{y}|\mathbf{x})\)</span>, i.e. (I believe) that IQNx4 should work basically exactly.</p>
<div class="math notranslate nohighlight">
\[R_{\text{IQN}x4} = [ L \left( f_m( \{ p_T^{\text{gen}}, \eta^{\text{gen}}, \phi^{\text{gen}}, m^{\text{gen}} , \tau \}, m^\text{reco} ) \]</div>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="train-mass">
<h1>Train Mass<a class="headerlink" href="#train-mass" title="Permalink to this headline">#</a></h1>
<p>for mass, <span class="math notranslate nohighlight">\(\mathbf{y_m}=m_{\text{reco}}\)</span> and <span class="math notranslate nohighlight">\(\mathbf{x_m}=\{p_T^{\text{gen}}, \eta^{\text{gen}}, \phi^{\text{gen}}, m^{\text{gen}} , \tau \}\)</span>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">show_jupyter_image</span><span class="p">(</span><span class="s1">&#39;images/IQN_training_flowchart.png&#39;</span><span class="p">,</span><span class="n">width</span><span class="o">=</span><span class="mi">2000</span><span class="p">,</span><span class="n">height</span><span class="o">=</span><span class="mi">600</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/Braden_Scaling_TrainEval_Mass_41_0.png" src="_images/Braden_Scaling_TrainEval_Mass_41_0.png" />
</div>
</div>
<section id="batches-validation-losses-and-plotting-of-losses-functions">
<h2>Batches, validation, losses, and plotting of losses functions<a class="headerlink" href="#batches-validation-losses-and-plotting-of-losses-functions" title="Permalink to this headline">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_batch</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">):</span>
    <span class="c1"># the numpy function choice(length, number)</span>
    <span class="c1"># selects at random &quot;batch_size&quot; integers from </span>
    <span class="c1"># the range [0, length-1] corresponding to the</span>
    <span class="c1"># row indices.</span>
    <span class="n">rows</span>    <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">batch_size</span><span class="p">)</span>
    <span class="n">batch_x</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">rows</span><span class="p">]</span>
    <span class="n">batch_t</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="n">rows</span><span class="p">]</span>
    <span class="c1"># batch_x.T[-1] = np.random.uniform(0, 1, batch_size)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">batch_x</span><span class="p">,</span> <span class="n">batch_t</span><span class="p">)</span>

<span class="c1"># Note: there are several average loss functions available </span>
<span class="c1"># in pytorch, but it&#39;s useful to know how to create your own.</span>
<span class="k">def</span> <span class="nf">average_quadratic_loss</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
    <span class="c1"># f and t must be of the same shape</span>
    <span class="k">return</span>  <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">((</span><span class="n">f</span> <span class="o">-</span> <span class="n">t</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">average_cross_entropy_loss</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
    <span class="c1"># f and t must be of the same shape</span>
    <span class="n">loss</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">t</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">f</span><span class="p">),</span> <span class="n">torch</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">f</span><span class="p">))</span>
    <span class="k">return</span> <span class="o">-</span><span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">loss</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">average_quantile_loss</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
    <span class="c1"># f and t must be of the same shape</span>
    <span class="n">tau</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="c1"># last column is tau.</span>
    <span class="c1">#Eq (2)</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">t</span> <span class="o">&gt;=</span> <span class="n">f</span><span class="p">,</span> 
                                  <span class="n">tau</span> <span class="o">*</span> <span class="p">(</span><span class="n">t</span> <span class="o">-</span> <span class="n">f</span><span class="p">),</span> 
                                  <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">tau</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">f</span> <span class="o">-</span> <span class="n">t</span><span class="p">)))</span>

<span class="c1"># function to validate model during training.</span>
<span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">avloss</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">targets</span><span class="p">):</span>
    <span class="c1"># make sure we set evaluation mode so that any training specific</span>
    <span class="c1"># operations are disabled.</span>
    <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span> <span class="c1"># evaluation mode</span>
    
    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span> <span class="c1"># no need to compute gradients wrt. x and t</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">targets</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>
        <span class="c1"># remember to reshape!</span>
        <span class="n">o</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">avloss</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">mkdir</span><span class="p">(</span><span class="n">dir_</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;make a directory without overwriting what&#39;s in it if it exists&quot;&quot;&quot;</span>
    <span class="c1"># assert isinstance(dir_, str)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s1">&#39;mkdir -p </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">dir_</span><span class="p">)</span> <span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">pass</span>


<span class="k">def</span> <span class="nf">plot_average_loss</span><span class="p">(</span><span class="n">traces</span><span class="p">,</span> <span class="n">ftsize</span><span class="o">=</span><span class="mi">18</span><span class="p">,</span><span class="n">save_loss_plots</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">show_loss_plots</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    
    <span class="n">xx</span><span class="p">,</span> <span class="n">yy_t</span><span class="p">,</span> <span class="n">yy_v</span><span class="p">,</span> <span class="n">yy_v_avg</span> <span class="o">=</span> <span class="n">traces</span>
    
    <span class="c1"># create an empty figure</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mf">4.5</span><span class="p">))</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    
    <span class="c1"># add a subplot to it</span>
    <span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span>
    <span class="n">ax</span>  <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">nrows</span><span class="p">,</span><span class="n">ncols</span><span class="p">,</span><span class="n">index</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Average loss&quot;</span><span class="p">)</span>
    
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">yy_t</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Training&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">yy_v</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Validation&#39;</span><span class="p">)</span>
    <span class="c1">#ax.plot(xx, yy_v_avg, &#39;g&#39;, lw=2, label=&#39;Running average&#39;)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Iterations&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">ftsize</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;average loss&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">ftsize</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s2">&quot;both&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper right&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">save_loss_plots</span><span class="p">:</span>
        <span class="n">filename</span><span class="o">=</span><span class="s1">&#39;IQNx4_</span><span class="si">%s</span><span class="s1">_Loss.png&#39;</span> <span class="o">%</span> <span class="n">target</span> 
        <span class="n">mkdir</span><span class="p">(</span><span class="s1">&#39;images/loss_plots&#39;</span><span class="p">)</span>
        <span class="n">PATH</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">IQN_BASE</span><span class="p">,</span> <span class="s1">&#39;images&#39;</span><span class="p">,</span> <span class="s1">&#39;loss_plots&#39;</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;images/loss_curves/IQN_&#39;</span><span class="o">+</span><span class="n">N</span><span class="o">+</span><span class="n">T</span><span class="o">+</span><span class="s1">&#39;_Consecutive_2.png&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">loss curve saved in images/loss_curves/IQN_&#39;</span><span class="o">+</span><span class="n">N</span><span class="o">+</span><span class="n">target</span><span class="o">+</span><span class="s1">&#39;_Consecutive.png&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">show_loss_plots</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">SUBSAMPLE</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="mf">1e4</span><span class="p">)</span>
<span class="n">target</span> <span class="o">=</span> <span class="s1">&#39;RecoDatam&#39;</span>
<span class="n">source</span>  <span class="o">=</span> <span class="n">FIELDS</span><span class="p">[</span><span class="n">target</span><span class="p">]</span>
<span class="n">features</span><span class="o">=</span> <span class="n">source</span><span class="p">[</span><span class="s1">&#39;inputs&#39;</span><span class="p">]</span>
<span class="c1">########</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;USING NEW DATASET</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="c1">#UNSCALED</span>
<span class="c1"># train_data_m=pd.read_csv(os.path.join(DATA_DIR,&#39;train_data_10M_2.csv&#39;),</span>
<span class="c1">#                        usecols=features,</span>
<span class="c1">#                        nrows=SUBSAMPLE)</span>

<span class="c1"># print(&#39;TRAINING FEATURES\n&#39;, train_data.head())</span>

<span class="c1"># test_data_m= pd.read_csv(os.path.join(DATA_DIR,&#39;test_data_10M_2.csv&#39;),</span>
<span class="c1">#                        usecols=features,</span>
<span class="c1">#                        nrows=SUBSAMPLE)</span>
<span class="c1"># print(&#39;\nTESTING FEATURES\n&#39;, test_data.head())</span>
<span class="c1"># valid_data= pd.read_csv(os.path.join(DATA_DIR,&#39;valid_data_10M_2.csv&#39;),</span>
<span class="c1">#                        usecols=features,</span>
<span class="c1">#                        nrows=SUBSAMPLE)</span>


<span class="c1"># SCALED</span>
<span class="n">train_data_m</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">DATA_DIR</span><span class="p">,</span><span class="s1">&#39;scaled_train_data_10M_2.csv&#39;</span><span class="p">),</span>
                       <span class="n">usecols</span><span class="o">=</span><span class="n">all_cols</span><span class="p">,</span>
                       <span class="n">nrows</span><span class="o">=</span><span class="n">SUBSAMPLE</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;TRAINING FEATURES</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">train_data_m</span><span class="o">.</span><span class="n">head</span><span class="p">())</span>

<span class="n">test_data_m</span><span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">DATA_DIR</span><span class="p">,</span><span class="s1">&#39;scaled_test_data_10M_2.csv&#39;</span><span class="p">),</span>
                       <span class="n">usecols</span><span class="o">=</span><span class="n">all_cols</span><span class="p">,</span>
                       <span class="n">nrows</span><span class="o">=</span><span class="n">SUBSAMPLE</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">TESTING FEATURES</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">test_data_m</span><span class="o">.</span><span class="n">head</span><span class="p">())</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">train set shape:&#39;</span><span class="p">,</span>  <span class="n">train_data_m</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">test set shape:  &#39;</span><span class="p">,</span> <span class="n">test_data_m</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="c1"># print(&#39;validation set shape:&#39;, valid_data.shape)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>USING NEW DATASET

TRAINING FEATURES
    genDatapT  RecoDatapT  genDataeta  RecoDataeta  genDataphi  RecoDataphi  \
0   3.382531    3.463020    0.828187     0.817082    2.902130     2.919510   
1   3.191270    3.308764   -1.163510    -1.151020    0.636469     0.652153   
2   3.191270    3.308764   -1.163510    -1.151020    0.636469     0.652153   
3   3.191270    3.308764   -1.163510    -1.151020    0.636469     0.652153   
4   3.004211    3.187005    1.844410     1.837910   -0.186685    -0.160621   

   genDatam  RecoDatam       tau  
0  1.579696   1.525158 -0.832143  
1  2.058837   1.995432 -2.238604  
2  2.058837   1.995432  2.773841  
3  2.058837   1.995432 -0.256307  
4  2.040038   1.886115  2.045169  

TESTING FEATURES
    genDatapT  RecoDatapT  genDataeta  RecoDataeta  genDataphi  RecoDataphi  \
0   3.775316    3.791603    0.824891     0.824645    -1.26949     -1.26117   
1   3.775316    3.791603    0.824891     0.824645    -1.26949     -1.26117   
2   3.258685    3.313277    3.529970     3.590390     1.55495      1.52062   
3   3.349708    3.522816   -1.159650    -1.139940     1.82602      1.76254   
4   3.090315    3.149058    2.747660     2.775790     2.03085      2.10209   

   genDatam  RecoDatam       tau  
0  2.071044   2.054470 -1.499727  
1  2.071044   2.054470  2.084955  
2  2.242060   1.918984  2.111972  
3  2.286615   2.204338 -2.685729  
4  1.971738   1.805105  0.255292  

train set shape: (10000, 9)

test set shape:   (10000, 9)
</pre></div>
</div>
</div>
</div>
</section>
<section id="get-training-and-testing-features-and-targets">
<h2>Get training and testing features and targets<a class="headerlink" href="#get-training-and-testing-features-and-targets" title="Permalink to this headline">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">target</span> <span class="o">=</span> <span class="s1">&#39;RecoDatam&#39;</span>
<span class="n">source</span>  <span class="o">=</span> <span class="n">FIELDS</span><span class="p">[</span><span class="n">target</span><span class="p">]</span>
<span class="n">features</span><span class="o">=</span> <span class="n">source</span><span class="p">[</span><span class="s1">&#39;inputs&#39;</span><span class="p">]</span>
<span class="c1">################################################</span>
<span class="k">def</span> <span class="nf">split_t_x</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">input_features</span><span class="p">):</span>
    <span class="c1"># change from pandas dataframe format to a numpy </span>
    <span class="c1"># array of the specified types</span>
    <span class="c1"># t = np.array(df[target])</span>
    <span class="k">if</span> <span class="n">target</span><span class="o">==</span><span class="s1">&#39;RecoDatam&#39;</span><span class="p">:</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">T</span><span class="p">(</span><span class="s1">&#39;m&#39;</span><span class="p">,</span> <span class="n">scaled_df</span><span class="o">=</span><span class="n">train_data_m</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">target</span><span class="o">==</span><span class="s1">&#39;RecoDatapT&#39;</span><span class="p">:</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">T</span><span class="p">(</span><span class="s1">&#39;pT&#39;</span><span class="p">,</span> <span class="n">scaled_df</span><span class="o">=</span><span class="n">train_data_m</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">target</span><span class="o">==</span><span class="s1">&#39;RecoDataeta&#39;</span><span class="p">:</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">T</span><span class="p">(</span><span class="s1">&#39;eta&#39;</span><span class="p">,</span> <span class="n">scaled_df</span><span class="o">=</span><span class="n">train_data_m</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">target</span><span class="o">==</span><span class="s1">&#39;RecoDataphi&#39;</span><span class="p">:</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">T</span><span class="p">(</span><span class="s1">&#39;phi&#39;</span><span class="p">,</span> <span class="n">scaled_df</span><span class="o">=</span><span class="n">train_data_m</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">input_features</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">t</span><span class="p">),</span> <span class="n">x</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;spliting data for </span><span class="si">{</span><span class="n">target</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">train_t</span><span class="p">,</span> <span class="n">train_x</span> <span class="o">=</span> <span class="n">split_t_x</span><span class="p">(</span><span class="n">df</span><span class="o">=</span> <span class="n">train_data_m</span><span class="p">,</span> <span class="n">target</span> <span class="o">=</span> <span class="n">target</span><span class="p">,</span> <span class="n">input_features</span><span class="o">=</span><span class="n">features</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;train_t shape = &#39;</span><span class="p">,</span><span class="n">train_t</span><span class="o">.</span><span class="n">shape</span> <span class="p">,</span> <span class="s1">&#39;train_x shape = &#39;</span><span class="p">,</span> <span class="n">train_x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1"> Training features:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">train_x</span><span class="p">)</span>
<span class="n">valid_t</span><span class="p">,</span> <span class="n">valid_x</span> <span class="o">=</span> <span class="n">split_t_x</span><span class="p">(</span><span class="n">df</span><span class="o">=</span> <span class="n">test_data_m</span><span class="p">,</span> <span class="n">target</span> <span class="o">=</span> <span class="n">target</span><span class="p">,</span> <span class="n">input_features</span><span class="o">=</span><span class="n">features</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;valid_t shape = &#39;</span><span class="p">,</span><span class="n">valid_t</span><span class="o">.</span><span class="n">shape</span> <span class="p">,</span> <span class="s1">&#39;valid_x shape = &#39;</span><span class="p">,</span> <span class="n">valid_x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;no need to train_test_split since we already have the split dataframes&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>spliting data for RecoDatam
train_t shape =  (10000,) train_x shape =  (10000, 5)

 Training features:

[[ 3.38253091  0.828187    2.90213     1.57969597 -0.83214275]
 [ 3.19127027 -1.16351     0.636469    2.05883697 -2.23860448]
 [ 3.19127027 -1.16351     0.636469    2.05883697  2.77384086]
 ...
 [ 3.58368281  3.537       3.1117      2.26299775 -1.15418175]
 [ 3.58368281  3.537       3.1117      2.26299775  2.00190305]
 [ 3.44642884  2.70158     0.267685    2.41813007  2.39480772]]
valid_t shape =  (10000,) valid_x shape =  (10000, 5)
no need to train_test_split since we already have the split dataframes
</pre></div>
</div>
</div>
</div>
</section>
<section id="training-and-running-of-training-functions">
<h2>Training and running-of-training functions<a class="headerlink" href="#training-and-running-of-training-functions" title="Permalink to this headline">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">train</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">optimizer</span><span class="p">,</span> <span class="n">avloss</span><span class="p">,</span> <span class="n">getbatch</span><span class="p">,</span>
          <span class="n">train_x</span><span class="p">,</span> <span class="n">train_t</span><span class="p">,</span> 
          <span class="n">valid_x</span><span class="p">,</span> <span class="n">valid_t</span><span class="p">,</span>
          <span class="n">batch_size</span><span class="p">,</span> 
          <span class="n">n_iterations</span><span class="p">,</span> <span class="n">traces</span><span class="p">,</span> 
          <span class="n">step</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
    
    <span class="c1"># to keep track of average losses</span>
    <span class="n">xx</span><span class="p">,</span> <span class="n">yy_t</span><span class="p">,</span> <span class="n">yy_v</span><span class="p">,</span> <span class="n">yy_v_avg</span> <span class="o">=</span> <span class="n">traces</span>
    
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">valid_x</span><span class="p">)</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Iteration vs average loss&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%10s</span><span class="se">\t</span><span class="si">%10s</span><span class="se">\t</span><span class="si">%10s</span><span class="s2">&quot;</span> <span class="o">%</span> \
          <span class="p">(</span><span class="s1">&#39;iteration&#39;</span><span class="p">,</span> <span class="s1">&#39;train-set&#39;</span><span class="p">,</span> <span class="s1">&#39;valid-set&#39;</span><span class="p">))</span>
    
    <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_iterations</span><span class="p">):</span>

        <span class="c1"># set mode to training so that training specific </span>
        <span class="c1"># operations such as dropout are enabled.</span>
        <span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
        
        <span class="c1"># get a random sample (a batch) of data (as numpy arrays)</span>
        <span class="n">batch_x</span><span class="p">,</span> <span class="n">batch_t</span> <span class="o">=</span> <span class="n">getbatch</span><span class="p">(</span><span class="n">train_x</span><span class="p">,</span> <span class="n">train_t</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">)</span>
        
        <span class="c1"># convert the numpy arrays batch_x and batch_t to tensor </span>
        <span class="c1"># types. The PyTorch tensor type is the magic that permits </span>
        <span class="c1"># automatic differentiation with respect to parameters. </span>
        <span class="c1"># However, since we do not need to take the derivatives</span>
        <span class="c1"># with respect to x and t, we disable this feature</span>
        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span> <span class="c1"># no need to compute gradients </span>
            <span class="c1"># wrt. x and t</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">batch_x</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">batch_t</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>      

        <span class="c1"># compute the output of the model for the batch of data x</span>
        <span class="c1"># Note: outputs is </span>
        <span class="c1">#   of shape (-1, 1), but the tensor targets, t, is</span>
        <span class="c1">#   of shape (-1,)</span>
        <span class="c1"># In order for the tensor operations with outputs and t</span>
        <span class="c1"># to work correctly, it is necessary that they have the</span>
        <span class="c1"># same shape. We can do this with the reshape method.</span>
        <span class="n">outputs</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
   
        <span class="c1"># compute a noisy approximation to the average loss</span>
        <span class="n">empirical_risk</span> <span class="o">=</span> <span class="n">avloss</span><span class="p">(</span><span class="n">outputs</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
        
        <span class="c1"># use automatic differentiation to compute a </span>
        <span class="c1"># noisy approximation of the local gradient</span>
        <span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>       <span class="c1"># clear previous gradients</span>
        <span class="n">empirical_risk</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>   <span class="c1"># compute gradients</span>
        
        <span class="c1"># finally, advance one step in the direction of steepest </span>
        <span class="c1"># descent, using the noisy local gradient. </span>
        <span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>            <span class="c1"># move one step</span>
        
        <span class="k">if</span> <span class="n">ii</span> <span class="o">%</span> <span class="n">step</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            
            <span class="n">acc_t</span> <span class="o">=</span> <span class="n">validate</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">avloss</span><span class="p">,</span> <span class="n">train_x</span><span class="p">[:</span><span class="n">n</span><span class="p">],</span> <span class="n">train_t</span><span class="p">[:</span><span class="n">n</span><span class="p">])</span> 
            <span class="n">acc_v</span> <span class="o">=</span> <span class="n">validate</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">avloss</span><span class="p">,</span> <span class="n">valid_x</span><span class="p">[:</span><span class="n">n</span><span class="p">],</span> <span class="n">valid_t</span><span class="p">[:</span><span class="n">n</span><span class="p">])</span>
            <span class="n">yy_t</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">acc_t</span><span class="p">)</span>
            <span class="n">yy_v</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">acc_v</span><span class="p">)</span>
            
            <span class="c1"># compute running average for validation data</span>
            <span class="n">len_yy_v</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">yy_v</span><span class="p">)</span>
            <span class="k">if</span>   <span class="n">len_yy_v</span> <span class="o">&lt;</span> <span class="n">window</span><span class="p">:</span>
                <span class="n">yy_v_avg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">yy_v</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span>
            <span class="k">elif</span> <span class="n">len_yy_v</span> <span class="o">==</span> <span class="n">window</span><span class="p">:</span>
                <span class="n">yy_v_avg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="nb">sum</span><span class="p">(</span><span class="n">yy_v</span><span class="p">)</span> <span class="o">/</span> <span class="n">window</span> <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">acc_v_avg</span>  <span class="o">=</span> <span class="n">yy_v_avg</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">window</span>
                <span class="n">acc_v_avg</span> <span class="o">+=</span> <span class="n">yy_v</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">yy_v</span><span class="p">[</span><span class="o">-</span><span class="n">window</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">yy_v_avg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">acc_v_avg</span> <span class="o">/</span> <span class="n">window</span><span class="p">)</span>
                        
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">xx</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">xx</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%10d</span><span class="se">\t</span><span class="si">%10.6f</span><span class="se">\t</span><span class="si">%10.6f</span><span class="s2">&quot;</span> <span class="o">%</span> \
                      <span class="p">(</span><span class="n">xx</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">yy_t</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">yy_v</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">xx</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">xx</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">step</span><span class="p">)</span>
                    
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\r</span><span class="si">%10d</span><span class="se">\t</span><span class="si">%10.6f</span><span class="se">\t</span><span class="si">%10.6f</span><span class="se">\t</span><span class="si">%10.6f</span><span class="s2">&quot;</span> <span class="o">%</span> \
                          <span class="p">(</span><span class="n">xx</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">yy_t</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">yy_v</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">yy_v_avg</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span> 
                      <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
            
    <span class="nb">print</span><span class="p">()</span>      
    <span class="k">return</span> <span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">yy_t</span><span class="p">,</span> <span class="n">yy_v</span><span class="p">,</span> <span class="n">yy_v_avg</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> 
        <span class="n">train_x</span><span class="p">,</span> <span class="n">train_t</span><span class="p">,</span> 
        <span class="n">valid_x</span><span class="p">,</span> <span class="n">valid_t</span><span class="p">,</span> <span class="n">traces</span><span class="p">,</span>
        <span class="n">n_batch</span><span class="o">=</span><span class="mi">256</span><span class="p">,</span> 
        <span class="n">n_iterations</span><span class="o">=</span><span class="n">n_iterations</span><span class="p">,</span> 
        <span class="n">traces_step</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> 
        <span class="n">traces_window</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span>
        <span class="n">save_model</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

    <span class="n">learning_rate</span><span class="o">=</span> <span class="n">starting_learning_rate</span>
    <span class="n">optimizer</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="n">learning_rate</span><span class="p">)</span> 
    <span class="c1">#starting at 10^-3	    </span>
    <span class="n">traces</span> <span class="o">=</span> <span class="n">train</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">optimizer</span><span class="p">,</span> 
                      <span class="n">average_quantile_loss</span><span class="p">,</span>
                      <span class="n">get_batch</span><span class="p">,</span>
                      <span class="n">train_x</span><span class="p">,</span> <span class="n">train_t</span><span class="p">,</span> 
                      <span class="n">valid_x</span><span class="p">,</span> <span class="n">valid_t</span><span class="p">,</span>
                      <span class="n">n_batch</span><span class="p">,</span> 
                  <span class="n">n_iterations</span><span class="p">,</span>
                  <span class="n">traces</span><span class="p">,</span>
                  <span class="n">step</span><span class="o">=</span><span class="n">traces_step</span><span class="p">,</span> 
                  <span class="n">window</span><span class="o">=</span><span class="n">traces_window</span><span class="p">)</span>
    
    <span class="c1"># learning_rate=learning_rate/10</span>
    <span class="c1"># optimizer = torch.optim.Adam(model.parameters(), lr=learning_rate) </span>
    <span class="c1"># #10^-4</span>
    <span class="c1"># traces = train(model, optimizer, </span>
    <span class="c1">#                   average_quantile_loss,</span>
    <span class="c1">#                   get_batch,</span>
    <span class="c1">#                   train_x, train_t, </span>
    <span class="c1">#                   valid_x, valid_t,</span>
    <span class="c1">#                   n_batch, </span>
    <span class="c1">#               n_iterations,</span>
    <span class="c1">#               traces,</span>
    <span class="c1">#               step=traces_step, </span>
    <span class="c1">#               window=traces_window)</span>


    <span class="c1"># learning_rate=learning_rate/100</span>
    <span class="c1"># optimizer = torch.optim.Adam(model.parameters(), lr=learning_rate) </span>
    <span class="c1"># #10^-6</span>
    <span class="c1"># traces = train(model, optimizer, </span>
    <span class="c1">#                   average_quantile_loss,</span>
    <span class="c1">#                   get_batch,</span>
    <span class="c1">#                   train_x, train_t, </span>
    <span class="c1">#                   valid_x, valid_t,</span>
    <span class="c1">#                   n_batch, </span>
    <span class="c1">#               n_iterations,</span>
    <span class="c1">#               traces,</span>
    <span class="c1">#               step=traces_step, </span>
    <span class="c1">#               window=traces_window)</span>

    <span class="n">plot_average_loss</span><span class="p">(</span><span class="n">traces</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">save_model</span><span class="p">:</span>
        <span class="n">filename</span><span class="o">=</span><span class="s1">&#39;Trained_IQNx4_</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">K_iter.dict&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">n_iterations</span><span class="o">/</span><span class="mi">1000</span><span class="p">))</span> <span class="p">)</span>
        <span class="n">PATH</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">IQN_BASE</span><span class="p">,</span> <span class="s1">&#39;trained_models&#39;</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span> <span class="n">PATH</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">trained model dictionary saved in </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">PATH</span><span class="p">)</span>
    <span class="c1">#utils.ModelHandler(model, scalers)</span>
    <span class="k">return</span>  <span class="n">model</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="define-basic-nn-model">
<h2>Define basic NN model<a class="headerlink" href="#define-basic-nn-model" title="Permalink to this headline">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">RegularizedRegressionModel</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="c1">#inherit from the super class</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nfeatures</span><span class="p">,</span> <span class="n">ntargets</span><span class="p">,</span> <span class="n">nlayers</span><span class="p">,</span> <span class="n">hidden_size</span><span class="p">,</span> <span class="n">dropout</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="n">layers</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nlayers</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">layers</span><span class="p">)</span> <span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                <span class="c1">#inital layer has to have size of input features as its input layer</span>
                <span class="c1">#its output layer can have any size but it must match the size of the input layer of the next linear layer</span>
                <span class="c1">#here we choose its output layer as the hidden size (fully connected)</span>
                <span class="n">layers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">nfeatures</span><span class="p">,</span> <span class="n">hidden_size</span><span class="p">))</span>
                <span class="c1">#batch normalization</span>
                <span class="n">layers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm1d</span><span class="p">(</span><span class="n">hidden_size</span><span class="p">))</span>
                <span class="c1">#Dropout seems to worsen model performance</span>
                <span class="n">layers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="n">dropout</span><span class="p">))</span>
                <span class="c1">#ReLU activation </span>
                <span class="n">layers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">())</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1">#if this is not the first layer (we dont have layers)</span>
                <span class="n">layers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">hidden_size</span><span class="p">,</span> <span class="n">hidden_size</span><span class="p">))</span>
                <span class="n">layers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm1d</span><span class="p">(</span><span class="n">hidden_size</span><span class="p">))</span>
                <span class="c1">#Dropout seems to worsen model performance</span>
                <span class="c1"># layers.append(nn.Dropout(dropout))</span>
                <span class="n">layers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">())</span>
                <span class="c1">#output layer:</span>
        <span class="n">layers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">hidden_size</span><span class="p">,</span> <span class="n">ntargets</span><span class="p">))</span> 

        <span class="c1"># only for classification add sigmoid</span>
        <span class="c1"># layers.append(nn.Sigmoid())</span>
            <span class="c1">#we have defined sequential model using the layers in oulist </span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span><span class="o">*</span><span class="n">layers</span><span class="p">)</span>

    
    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">n_iterations</span><span class="p">,</span> <span class="n">n_layers</span><span class="p">,</span> <span class="n">n_hidden</span><span class="p">,</span> <span class="n">starting_learning_rate</span><span class="p">,</span> <span class="n">dropout</span> <span class="o">=</span> <span class="n">get_model_params</span><span class="p">()</span>

<span class="n">NFEATURES</span><span class="o">=</span><span class="n">train_x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">model</span><span class="o">=</span><span class="n">RegularizedRegressionModel</span><span class="p">(</span><span class="n">nfeatures</span><span class="o">=</span><span class="n">NFEATURES</span><span class="p">,</span> <span class="n">ntargets</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                           <span class="n">nlayers</span><span class="o">=</span><span class="n">n_layers</span><span class="p">,</span> <span class="n">hidden_size</span><span class="o">=</span><span class="n">n_hidden</span><span class="p">,</span> <span class="n">dropout</span><span class="o">=</span><span class="n">dropout</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>RegularizedRegressionModel(
  (model): Sequential(
    (0): Linear(in_features=5, out_features=10, bias=True)
    (1): BatchNorm1d(10, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
    (2): Dropout(p=0.2, inplace=False)
    (3): ReLU()
    (4): Linear(in_features=10, out_features=1, bias=True)
  )
)
</pre></div>
</div>
</div>
</div>
</section>
<section id="run-training">
<h2>Run training<a class="headerlink" href="#run-training" title="Permalink to this headline">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">valid_x</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">valid_x</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">train_x</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">train_x</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[3.43200706 0.03296074 0.02674094 2.15370158 0.04535625] [0.34109032 2.21113156 1.81910579 0.28837389 1.74437024]
[ 3.42368585 -0.00716868  0.00421532  2.15308963  0.00824955] [0.33548512 2.20977298 1.80908512 0.28603437 1.7285385 ]
</pre></div>
</div>
</div>
</div>
<p>we expect the targets to have mean 0 and variance=1, since theyre the only things standarized</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">valid_t</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">valid_t</span><span class="o">.</span><span class="n">std</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="n">train_t</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">train_t</span><span class="o">.</span><span class="n">std</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-7.684093361604027e-14 1.0000000000000002
-7.684093361604027e-14 1.0000000000000002
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Training for </span><span class="si">{</span><span class="n">n_iterations</span><span class="si">}</span><span class="s1"> iterations&#39;</span><span class="p">)</span>
<span class="n">start</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;estimating </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">target</span><span class="p">)</span>
<span class="n">IQN_trace</span><span class="o">=</span><span class="p">([],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[])</span>
<span class="n">traces_step</span> <span class="o">=</span> <span class="mi">50</span>
<span class="n">IQN</span> <span class="o">=</span> <span class="n">run</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="n">target</span><span class="p">,</span><span class="n">train_x</span><span class="o">=</span><span class="n">train_x</span><span class="p">,</span> <span class="n">train_t</span><span class="o">=</span><span class="n">train_t</span><span class="p">,</span> 
        <span class="n">valid_x</span><span class="o">=</span><span class="n">valid_x</span><span class="p">,</span> <span class="n">valid_t</span><span class="o">=</span><span class="n">valid_t</span><span class="p">,</span> <span class="n">traces</span><span class="o">=</span><span class="n">IQN_trace</span><span class="p">,</span> <span class="n">n_batch</span><span class="o">=</span><span class="mi">256</span><span class="p">,</span> 
        <span class="n">n_iterations</span><span class="o">=</span><span class="n">n_iterations</span><span class="p">,</span> <span class="n">traces_step</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">traces_window</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
        <span class="n">save_model</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="n">end</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">difference</span><span class="o">=</span><span class="n">end</span><span class="o">-</span><span class="n">start</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;evaluating m took &#39;</span><span class="p">,</span><span class="n">difference</span><span class="p">,</span> <span class="s1">&#39;seconds&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Training for 10000 iterations
estimating RecoDatam

Iteration vs average loss
 iteration	 train-set	 valid-set
         0	-216185.750000	-215364.296875
      7000	-542412.312500	-540274.625000	-473953.093750
</pre></div>
</div>
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">KeyboardInterrupt</span><span class="g g-Whitespace">                         </span>Traceback (most recent call last)
<span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">ipykernel_282404</span><span class="o">/</span><span class="mf">244478561.</span><span class="n">py</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="g g-Whitespace">      </span><span class="mi">7</span>         <span class="n">valid_x</span><span class="o">=</span><span class="n">valid_x</span><span class="p">,</span> <span class="n">valid_t</span><span class="o">=</span><span class="n">valid_t</span><span class="p">,</span> <span class="n">traces</span><span class="o">=</span><span class="n">IQN_trace</span><span class="p">,</span> <span class="n">n_batch</span><span class="o">=</span><span class="mi">256</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">8</span>         <span class="n">n_iterations</span><span class="o">=</span><span class="n">n_iterations</span><span class="p">,</span> <span class="n">traces_step</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">traces_window</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
<span class="ne">----&gt; </span><span class="mi">9</span>         <span class="n">save_model</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">10</span> 
<span class="g g-Whitespace">     </span><span class="mi">11</span> <span class="n">end</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

<span class="nn">/tmp/ipykernel_282404/1130991293.py</span> in <span class="ni">run</span><span class="nt">(model, target, train_x, train_t, valid_x, valid_t, traces, n_batch, n_iterations, traces_step, traces_window, save_model)</span>
<span class="g g-Whitespace">    </span><span class="mi">109</span>                   <span class="n">traces</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">110</span>                   <span class="n">step</span><span class="o">=</span><span class="n">traces_step</span><span class="p">,</span>
<span class="ne">--&gt; </span><span class="mi">111</span>                   <span class="n">window</span><span class="o">=</span><span class="n">traces_window</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">112</span> 
<span class="g g-Whitespace">    </span><span class="mi">113</span>     <span class="c1"># learning_rate=learning_rate/10</span>

<span class="nn">/tmp/ipykernel_282404/1130991293.py</span> in <span class="ni">train</span><span class="nt">(model, optimizer, avloss, getbatch, train_x, train_t, valid_x, valid_t, batch_size, n_iterations, traces, step, window)</span>
<span class="g g-Whitespace">     </span><span class="mi">41</span>         <span class="c1"># to work correctly, it is necessary that they have the</span>
<span class="g g-Whitespace">     </span><span class="mi">42</span>         <span class="c1"># same shape. We can do this with the reshape method.</span>
<span class="ne">---&gt; </span><span class="mi">43</span>         <span class="n">outputs</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">44</span> 
<span class="g g-Whitespace">     </span><span class="mi">45</span>         <span class="c1"># compute a noisy approximation to the average loss</span>

<span class="nn">~/anaconda3/lib/python3.7/site-packages/torch/nn/modules/module.py</span> in <span class="ni">_call_impl</span><span class="nt">(self, *input, **kwargs)</span>
<span class="g g-Whitespace">   </span><span class="mi">1043</span>         <span class="k">return</span> <span class="n">result</span>
<span class="g g-Whitespace">   </span><span class="mi">1044</span> 
<span class="ne">-&gt; </span><span class="mi">1045</span>     <span class="k">def</span> <span class="nf">_call_impl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="nb">input</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="g g-Whitespace">   </span><span class="mi">1046</span>         <span class="n">forward_call</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_slow_forward</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">_C</span><span class="o">.</span><span class="n">_get_tracing_state</span><span class="p">()</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">forward</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1047</span>         <span class="c1"># If we don&#39;t have any hooks, we want to skip the rest of the logic in</span>

<span class="ne">KeyboardInterrupt</span>: 
</pre></div>
</div>
</div>
</div>
</section>
<section id="evalute-model-and-save-evaluated-data">
<h2>Evalute model and save evaluated data<a class="headerlink" href="#evalute-model-and-save-evaluated-data" title="Permalink to this headline">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">target</span><span class="o">==</span> <span class="s1">&#39;RecoDatapT&#39;</span><span class="p">:</span>
    <span class="n">label</span><span class="o">=</span> <span class="s1">&#39;$p_T$ [GeV]&#39;</span>
    <span class="n">x_min</span><span class="p">,</span> <span class="n">x_max</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">60</span>
<span class="k">elif</span> <span class="n">target</span><span class="o">==</span> <span class="s1">&#39;RecoDataeta&#39;</span><span class="p">:</span>
    <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;$\eta$&#39;</span>
    <span class="n">x_min</span><span class="p">,</span> <span class="n">x_max</span> <span class="o">=</span> <span class="o">-</span><span class="mf">5.4</span><span class="p">,</span> <span class="mf">5.4</span>
<span class="k">elif</span> <span class="n">target</span> <span class="o">==</span><span class="s1">&#39;RecoDataphi&#39;</span><span class="p">:</span>
    <span class="n">label</span><span class="o">=</span><span class="s1">&#39;$\phi$&#39;</span>
    <span class="n">x_min</span><span class="p">,</span> <span class="n">x_max</span> <span class="o">=</span> <span class="o">-</span><span class="mf">3.4</span><span class="p">,</span> <span class="mf">3.4</span>
<span class="k">elif</span> <span class="n">target</span> <span class="o">==</span> <span class="s1">&#39;RecoDatam&#39;</span><span class="p">:</span>
    <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39; $m$ [GeV]&#39;</span>
    <span class="n">x_min</span><span class="p">,</span> <span class="n">x_max</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">18</span>


    
<span class="k">def</span> <span class="nf">evaluate_model</span><span class="p">(</span><span class="n">dnn</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span>
               <span class="n">fgsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> 
               <span class="n">ftsize</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span><span class="n">save_image</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">save_pred</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
               <span class="n">show_plot</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="n">eval_data</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">DATA_DIR</span><span class="p">,</span><span class="s1">&#39;test_data_10M_2.csv&#39;</span><span class="p">))</span>
    <span class="n">ev_features</span><span class="o">=</span><span class="n">X</span>
    <span class="c1">#[&#39;genDatapT&#39;, &#39;genDataeta&#39;, &#39;genDataphi&#39;, &#39;genDatam&#39;,&#39;tau&#39;]</span>
    
    <span class="n">eval_data</span><span class="o">=</span><span class="n">eval_data</span><span class="p">[</span><span class="n">ev_features</span><span class="p">]</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;EVALUATION DATA OLD INDEX</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">eval_data</span><span class="o">.</span><span class="n">head</span><span class="p">())</span>

    

                            
    <span class="n">dnn</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">dnn</span><span class="p">(</span><span class="n">eval_data</span><span class="p">)</span>
    <span class="n">eval_data</span><span class="p">[</span><span class="s1">&#39;RecoDatam&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">y</span>
    <span class="n">new_cols</span><span class="o">=</span> <span class="p">[</span><span class="s1">&#39;RecoDatam&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">X</span>
    <span class="n">eval_data</span><span class="o">=</span><span class="n">eval_data</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">new_cols</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;EVALUATION DATA NEW INDEX</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">eval_data</span><span class="o">.</span><span class="n">head</span><span class="p">())</span>

    <span class="n">eval_data</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s1">&#39;AUTOREGRESSIVE_m_Prime.csv&#39;</span><span class="p">)</span>


    <span class="k">if</span> <span class="n">save_pred</span><span class="p">:</span>
        <span class="n">pred_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="n">T</span><span class="o">+</span><span class="s1">&#39;_predicted&#39;</span><span class="p">:</span><span class="n">y</span><span class="p">})</span>
        <span class="n">pred_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s1">&#39;predicted_data/dataset2/&#39;</span><span class="o">+</span><span class="n">T</span><span class="o">+</span><span class="s1">&#39;_predicted_MLP_iter_5000000.csv&#39;</span><span class="p">)</span>
        
    <span class="k">if</span> <span class="n">save_image</span> <span class="ow">or</span> <span class="n">show_plot</span><span class="p">:</span>
        <span class="n">gfile</span> <span class="o">=</span><span class="s1">&#39;fig_model_</span><span class="si">%s</span><span class="s1">.png&#39;</span> <span class="o">%</span> <span class="n">target</span>
        <span class="n">xbins</span> <span class="o">=</span> <span class="mi">100</span>
        <span class="n">xmin</span>  <span class="o">=</span> <span class="n">src</span><span class="p">[</span><span class="s1">&#39;xmin&#39;</span><span class="p">]</span>
        <span class="n">xmax</span>  <span class="o">=</span> <span class="n">src</span><span class="p">[</span><span class="s1">&#39;xmax&#39;</span><span class="p">]</span>
        <span class="n">xlabel</span><span class="o">=</span> <span class="n">src</span><span class="p">[</span><span class="s1">&#39;xlabel&#39;</span><span class="p">]</span>
        <span class="n">xstep</span> <span class="o">=</span> <span class="p">(</span><span class="n">xmax</span> <span class="o">-</span> <span class="n">xmin</span><span class="p">)</span><span class="o">/</span><span class="n">xbins</span>

        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="n">fgsize</span><span class="p">)</span>
        
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">xlabel</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">ftsize</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;reco jet &#39;</span><span class="o">+</span><span class="n">label</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">ftsize</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">y_label_dict</span><span class="p">[</span><span class="n">target</span><span class="p">],</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">ftsize</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">train_data</span><span class="p">[</span><span class="s1">&#39;RecoDatam&#39;</span><span class="p">],</span> 
                <span class="n">bins</span><span class="o">=</span><span class="n">xbins</span><span class="p">,</span> 
                <span class="nb">range</span><span class="o">=</span><span class="p">(</span><span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">),</span> 
                <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> 
                <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> 
                <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
                <span class="n">label</span><span class="o">=</span><span class="s1">&#39;simulation&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> 
                <span class="n">bins</span><span class="o">=</span><span class="n">xbins</span><span class="p">,</span> 
                <span class="nb">range</span><span class="o">=</span><span class="p">(</span><span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">),</span> 
                <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> 
                <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> 
                <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
                <span class="n">label</span><span class="o">=</span><span class="s1">&#39;$y^\prime$&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        
        
        <span class="k">if</span> <span class="n">save_image</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;images/&#39;</span><span class="o">+</span><span class="n">T</span><span class="o">+</span><span class="s1">&#39;IQN_Consecutive_&#39;</span><span class="o">+</span><span class="n">N</span><span class="o">+</span><span class="s1">&#39;.png&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;images/&#39;</span><span class="o">+</span><span class="n">T</span><span class="o">+</span><span class="s1">&#39;IQN_Consecutive_&#39;</span><span class="o">+</span><span class="n">N</span><span class="o">+</span><span class="s1">&#39;.png&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">show_plot</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="c1">##########</span>
<span class="c1">################################################CNN</span>







<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">start</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;estimating mass</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">model</span> <span class="o">=</span>  <span class="n">utils</span><span class="o">.</span><span class="n">RegularizedRegressionModel</span><span class="p">(</span><span class="n">nfeatures</span><span class="o">=</span><span class="n">train_x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">ntargets</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">nlayers</span><span class="o">=</span><span class="n">n_layers</span><span class="p">,</span> <span class="n">hidden_size</span><span class="o">=</span><span class="n">n_hidden</span><span class="p">)</span>
    <span class="n">traces</span> <span class="o">=</span> <span class="p">([],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[])</span>
    <span class="n">dnn</span> <span class="o">=</span> <span class="n">run</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">scalers</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">train_x</span><span class="p">,</span> <span class="n">train_t</span><span class="p">,</span> <span class="n">valid_x</span><span class="p">,</span> <span class="n">valid_t</span><span class="p">,</span> <span class="n">traces</span><span class="p">)</span>
    <span class="n">evaluate_model</span><span class="p">(</span> <span class="n">dnn</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">source</span><span class="p">)</span>



<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="plot-predicted-vs-real-reco-in-our-paper-s-format">
<h1>Plot predicted vs real reco (in our paper’s format)<a class="headerlink" href="#plot-predicted-vs-real-reco-in-our-paper-s-format" title="Permalink to this headline">#</a></h1>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="train-p-t-using-saved-variables-above">
<h1>Train <span class="math notranslate nohighlight">\(p_T\)</span> using saved variables above<a class="headerlink" href="#train-p-t-using-saved-variables-above" title="Permalink to this headline">#</a></h1>
<p>Evaluate <span class="math notranslate nohighlight">\(p_T\)</span> and save predicted distribution</p>
<p>Plot reco <span class="math notranslate nohighlight">\(p_T\)</span> and  predicted reco <span class="math notranslate nohighlight">\(p_T\)</span> marginal densities</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># show_jupyter_image(&#39;screenshot.png&#39;)</span>
</pre></div>
</div>
</div>
</div>
<!-- > I guess it works now --><p>commented new ideas below</p>
<!-- ### Ideas for a future paper

me and Harrison would like to use this method for on-the-fly stochastic folding of events in MC generators (potentially even including CMSSW formats like [nanoaod](https://github.com/cms-nanoAOD/nanoAOD-tools), such as in Madminer (but using IQN as opposed to Delphes for detector simulation) for any observable. This also beings the possibility of using LFI methods for much better inference on models (such as SMEFT) using any observable post-detector simulation. If you're interested in helping out on this, me and Harrison would like to do most of the code/ideas, but your occasional ideas/input would be incredibly valuable! --></section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
            </main>
            <footer class="footer-article noprint">
                
    <!-- Previous / next buttons -->
<div class='prev-next-area'>
    <a class='left-prev' id="prev-link" href="intro.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">Welcome to the <em>torchIQNx4</em></p>
        </div>
    </a>
</div>
            </footer>
        </div>
    </div>
    <div class="footer-content row">
        <footer class="col footer"><p>
  
    By Ali Al Kadhim<br/>
  
      &copy; Copyright 2022.<br/>
</p>
        </footer>
    </div>
    
</div>


      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>


  </body>
</html>